"undefined"==typeof RelayTrap&&("undefined"!=typeof Trap?RelayTrap=Trap:(!function(t){var Trap={};Trap.Transports={},Trap.supportsBinary="undefined"!=typeof Uint8Array,Trap.Constants={},Trap.Constants.OPTION_MAX_CHUNK_SIZE="trap.maxchunksize",Trap.Constants.OPTION_ENABLE_COMPRESSION="trap.enablecompression",Trap.Constants.CONNECTION_TOKEN="trap.connection-token",Trap.Constants.TRANSPORT_ENABLED_DEFAULT=!0,Trap.Constants.TRAP_ID_SEED=1,Trap.Constants.TRAP_ID_NONE=0,Trap.Constants.TRAP_ID_MAX=268435455,Trap.ByteArrayOutputStream=function(t){("number"!=typeof t||0>t)&&(t=512),this.buf=new Uint8Array(t),this.off=0,this.size=t,this.growthSize=512},Trap.ByteArrayOutputStream.prototype._remaining=function(){return this.size-this.off},Trap.ByteArrayOutputStream.prototype._resize=function(t){var e=Math.min(t,this.off),r=new Uint8Array(t),n=e<this.buf.length?this.buf.subarray(0,e):this.buf;r.set(n,0),this.buf=r,this.size=this.buf.length},Trap.ByteArrayOutputStream.prototype._checkAndResize=function(t){this._remaining()<t&&this._resize(this.size+Math.max(t,this.growthSize))},Trap.ByteArrayOutputStream.prototype.write=function(t,e,r){if("number"==typeof t)return this._checkAndResize(1),void(this.buf[this.off++]=t);if("number"!=typeof e&&(e=0),"number"!=typeof r&&(r=t.byteLength?t.byteLength:t.length),"string"!=typeof t){if(this._checkAndResize(r-e),"number"!=typeof t.length||!t.slice){if("number"==typeof t.byteLength){if(0==t.byteLength)return;t.byteOffset>0&&(e+=t.byteOffset);var n=t.buffer?t.buffer:t,a=new Uint8Array(n,e,r);return this.buf.set(a,this.off),void(this.off+=r)}throw"Cannot serialise: "+typeof t}for(var i=e;e+r>i;i++)this.buf[this.off++]=t[i]}else{for(var s=[],o=e;e+r>o;o++){var p=t.charCodeAt(o);128>p?s.push(String.fromCharCode(p)):p>127&&2048>p?(s.push(String.fromCharCode(p>>6|192)),s.push(String.fromCharCode(63&p|128))):(s.push(String.fromCharCode(p>>12|224)),s.push(String.fromCharCode(p>>6&63|128)),s.push(String.fromCharCode(63&p|128)))}this._checkAndResize(s.length);for(var i=0;i<s.length;i++)this.buf[this.off++]=s[i]}},Trap.ByteArrayOutputStream.prototype.toString=function(){for(var t="",e=0;e<this.buf.length;e++)t+=this.buf[e];return String.utf8Decode(t)},Trap.ByteArrayOutputStream.prototype.toArray=function(){return new Uint8Array(this.buf.buffer.slice(0,this.off))},Trap.ByteArrayOutputStream.prototype.clear=function(){this.buf=new Uint8Array(512),this.off=0,this.size=512},Trap.ByteStringOutputStream=function(){this.buf=""},Trap.ByteStringOutputStream.prototype.write=function(t,e,r){if("number"==typeof t)return void(this.buf+=String.fromCharCode(t));if("number"!=typeof e&&(e=0),"number"!=typeof r&&(r=t.length),"string"==typeof t)this.buf+=t.substr(0,r);else{if("number"!=typeof t.length||!t.slice)throw"Cannot serialise: "+typeof t;for(var n=e;e+r>n;n++)this.buf+=String.fromCharCode(t[n])}},Trap.ByteStringOutputStream.prototype.toString=function(){return this.buf},Trap.ByteStringOutputStream.prototype.toArray=function(){for(var t=[],e=0;e<this.buf.length;e++)t[e]=this.buf[e].charCodeAt(0);return t},Trap.ByteStringOutputStream.prototype.clear=function(){this.buf=""},Trap._compat={},Trap._compat.capitalise=function(t){return t.substr(0,1).toUpperCase()+t.substr(1)},Trap._compat.__defineSetter=function(t,e,r){var n="set"+Trap._compat.capitalise(e);if(!r){var a="_"+e;r=function(t){return this[a]=t,this}}if(t.__defineSetter__)try{t.__defineSetter__(e,r)}catch(i){}t[n]=r},Trap._compat.__defineGetter=function(t,e,r){var n="get"+Trap._compat.capitalise(e);if(!r){var a="_"+e;r=function(){return this[a]}}if(t.__defineGetter__)try{t.__defineGetter__(e,r)}catch(i){}t[n]=r},Trap._compat.__defineGetterSetter=function(t,e,r,n,a){r||(r="_"+e),n||(n=function(){return this[r]}),a||(a=function(t){return this[r]=t,this}),Trap._compat.__defineSetter(t,e,a),Trap._compat.__defineGetter(t,e,n)},Trap._compat.__addEventListener=function(t,e,r){function n(){t.attachEvent("on"+e,r)}if(t.addEventListener)try{t.addEventListener(e,r,!1)}catch(a){n()}else{if(!t.attachEvent)throw"Could not add listener for "+e+" to object "+t;n()}},Trap._uuidCounter=0,Trap._uuid=function(){return Math.random().toString(16).substring(2)+(Trap._uuidCounter++).toString(16)},Trap.subarray=function(t,e,r){return t.subarray?t.subarray(e,r):t.slice(e,r)},"undefined"!=typeof ArrayBuffer&&"undefined"==typeof ArrayBuffer.prototype.slice&&(ArrayBuffer.prototype.slice=function(t,e){if("undefined"==typeof t)return new ArrayBuffer(0);if(0>t&&(t=this.byteLength+t),0>t&&(t=0),t>this.byteLength-1&&(t=this.byteLength-1),"undefined"!=typeof e?(0>e&&(e=this.byteLength+e),0>e&&(e=0),e>this.byteLength&&(e=this.byteLength)):e=this.byteLength,0>=e-t)return new ArrayBuffer(0);var r=new Uint8Array(this,t,e-t),n=new Uint8Array(e-t);return n.set(r),n.buffer}),Trap._useGetters=!1;try{eval("var f = {get test() { return true; }}; Trap._useGetters = f.test;")}catch(e){}Trap.ByteConverter={},Trap.ByteConverter.toBigEndian=function(t,e,r){return e||(e=[]),r||(r=0),e[r+0]=t>>24,e[r+1]=t>>16&255,e[r+2]=t>>8&255,e[r+3]=t>>0&255,e},Trap.ByteConverter.fromBigEndian=function(t,e){var r=0;return r|=(255&t[e+0])<<24,r|=(255&t[e+1])<<16,r|=(255&t[e+2])<<8,r|=(255&t[e+3])<<0},Trap.ByteConverter.toBigEndian7=function(t){var e=[];return e[0]=this.getBits(t,4,11),e[1]=this.getBits(t,11,18),e[2]=this.getBits(t,18,25),e[3]=this.getBits(t,25,32),e},Trap.ByteConverter.fromBigEndian7=function(t,e){e||(e=0);var r=0;return r|=(255&t[e+0])<<21,r|=(255&t[e+1])<<14,r|=(255&t[e+2])<<7,r|=(255&t[e+3])<<0,1==this.getBits(r,4,5)&&(r|=4026531840),r},Trap.ByteConverter.getBits=function(t,e,r){var n=Math.pow(2,r-e)-1;n<<=32-r;var a=(t&n)>>32-r;return a},Trap.EventObject=function(){this._eventlistenersMap={}},Trap.EventObject.prototype.addEventListener=function(t,e){this._eventlistenersMap[t]||(this._eventlistenersMap[t]=[]);for(var r=this._eventlistenersMap[t],n=0;n<r.length;n++)if(e===r[n])return;r[n]=e},Trap.EventObject.prototype.removeEventListener=function(t,e){if(this._eventlistenersMap[t])for(var r=this._eventlistenersMap[t],n=0;n<r.length;n++)if(e===r[n]){r.splice(n,1);break}},Trap.EventObject.prototype.on=Trap.EventObject.prototype.addEventListener,Trap.EventObject.prototype.off=Trap.EventObject.prototype.removeEventListener,Trap.EventObject.prototype._dispatchEvent=function(t){var e=this._eventlistenersMap[t.type];if(t.target||(t.target=this),e)for(var r=0;r<e.length;r++)try{e[r](t)}catch(n){this.logger&&this.logger.warn("Exception while dispatching event to listener; ",n," to ",e[r],". Event was ",t)}var a;try{a=this["on"+t.type],a&&"function"==typeof a&&a.call(this,t)}catch(n){this.logger&&this.logger.warn("Exception while dispatching event to listener; ",n," to ",a,". Event was ",t)}},Trap.List=function(){this.list=[]},Trap.List.prototype.className="list",Trap.List.prototype.add=function(t,e){e&&"number"==typeof t?this.list.splice(t,0,e):this.list.push(t)},Trap.List.prototype.addLast=function(t){this.list.push(t)},Trap.List.prototype.pop=function(){return this.remove(0)},Trap.List.prototype.remove=function(t){if(t||(t=0),"number"==typeof t){var e=this.list[t];return this.list.splice(t,1),e}for(var r=0;r<this.list.length;r++)this.list[r]==t&&this.list.splice(r,1);return t},Trap.List.prototype.peek=function(){return this.list.length>0?this.list[0]:null},Trap.List.prototype.size=function(){return this.list.length},Trap.List.prototype.isEmpty=function(){return 0==this.size()},Trap.List.prototype.get=function(t){return this.list[t]},Trap.List.prototype.getLast=function(){return this.get(this.size()-1)},Trap.List.prototype.contains=function(t){for(var e=0;e<this.list.length;e++)if(this.list[e]==t)return!0;return!1},Trap.List.prototype.sort=function(){this.list.sort.apply(this.list,arguments)},Trap.List.prototype.clear=function(){this.list=[]},Trap.List.prototype.addAll=function(){var t=arguments;if(!(t.length<1)){if(1==t.length){var e=t[0];"list"==e.className?t=e.list:("array"==typeof e||e.length&&e.map)&&(t=e)}for(var r=0;r<t.length;r++)this.addLast(t[r])}},Trap.List.prototype.iterator=function(){var t=this,e=-1;return{hasNext:function(){return!!t.get(e+1)},next:function(){return t.get(++e)},remove:function(){t.remove(e)}}},Trap.Logger=function(t){this.name=t},Trap.Logger._loggers={},Trap.Logger.getLogger=function(t){var e=Trap.Logger._loggers[t];return e||(e=new Trap.Logger(t),Trap.Logger._loggers[t]=e),e},Trap.Logger.formatter={};var _pad=function(t,e){for(t=String(t),e=e||2;t.length<e;)t="0"+t;return t},_logtime=function(){var t=new Date;return[_pad(t.getHours(),2)+":"+_pad(t.getMinutes(),2)+":"+_pad(t.getSeconds(),2)+"."+_pad(t.getMilliseconds(),3)+" - "]};Trap.Logger.formatter._format=function(t){var e=_logtime();if(e.push(t.label),t.objects.length>1&&"string"==typeof t.objects[0]){for(var r=t.objects[0],n=r.indexOf("{}"),a=1;-1!=n&&!(a>=t.objects.length);)r=r.replace("{}",t.objects[a]),a++,n=r.indexOf("{}",n);for(e.push(r);a<t.objects.length;){var i=t.objects[a++];e.push(i),i.stack&&e.push(i.stack)}}else e.push.apply(e,t.objects);return t.objects[0].stack&&e.push(t.objects[0].stack),e},Trap.Logger.appender={},Trap.Logger.appender._info=Trap.Logger.appender._warn=Trap.Logger.appender._error=function(){},self.console&&self.console.log&&(self.console.log.apply?Trap.Logger.appender._info=function(t){self.console.log.apply(self.console,t)}:Trap.Logger.appender._info=function(t){self.console.log(t.join(""))},self.console.warn?self.console.warn.apply?Trap.Logger.appender._warn=function(t){self.console.warn.apply(self.console,t)}:Trap.Logger.appender._warn=function(t){self.console.warn(t.join(""))}:Trap.Logger.appender._warn=Trap.Logger.appender._info,self.console.error?self.console.error.apply?Trap.Logger.appender._error=function(t){self.console.error.apply(self.console,t)}:Trap.Logger.appender._error=function(t){self.console.error(t.join(""))}:Trap.Logger.appender._error=Trap.Logger.appender._info),Trap.Logger.prototype.isTraceEnabled=function(){return!0},Trap.Logger.prototype.trace=function(){Trap.Logger.appender._info(Trap.Logger.formatter._format({objects:arguments,label:"",logger:this.name}))},Trap.Logger.prototype.debug=function(){Trap.Logger.appender._info(Trap.Logger.formatter._format({objects:arguments,label:"",logger:this.name}))},Trap.Logger.prototype.info=function(){Trap.Logger.appender._info(Trap.Logger.formatter._format({objects:arguments,label:"",logger:this.name}))},Trap.Logger.prototype.warn=function(){Trap.Logger.appender._warn(Trap.Logger.formatter._format({objects:arguments,label:"WARN: ",logger:this.name}))},Trap.Logger.prototype.error=function(){Trap.Logger.appender._error(Trap.Logger.formatter._format({objects:arguments,label:"ERROR: ",logger:this.name}))},Trap.Map=function(t){if(this._map={},this._keys=[],"undefined"!=typeof t)for(var e in t.allKeys())this.put(e,t.get(e))},Trap.Map.prototype.put=function(t,e){t in this._map||this._keys.push(t),this._map[t]=e},Trap.Map.prototype.get=function(t){return this._map[t]},Trap.Map.prototype.allKeys=function(){return this._keys},Trap.Map.prototype.containsKey=function(t){return"undefined"!=typeof this._map[t]},Trap.Map.prototype.remove=function(t){for(var e=0;e<this._keys.length;e++)this._keys[e]==t&&this._keys.splice(e,1);delete this._map[t]},Trap.Map.prototype.size=function(){return this._keys.length},Trap.Map.prototype.putAll=function(t){for(var e=t.allKeys(),r=0;r<e.length;r++)this.put(e[r],t.get(e[r]))},Trap.MD5=function(t){function e(t,e){return t<<e|t>>>32-e}function r(t,e){var r,n,a,i,s;return a=2147483648&t,i=2147483648&e,r=1073741824&t,n=1073741824&e,s=(1073741823&t)+(1073741823&e),r&n?2147483648^s^a^i:r|n?1073741824&s?3221225472^s^a^i:1073741824^s^a^i:s^a^i}function n(t,e,r){return t&e|~t&r}function a(t,e,r){return t&r|e&~r}function i(t,e,r){return t^e^r}function s(t,e,r){return e^(t|~r)}function o(t,a,i,s,o,p,h){return t=r(t,r(r(n(a,i,s),o),h)),r(e(t,p),a)}function p(t,n,i,s,o,p,h){return t=r(t,r(r(a(n,i,s),o),h)),r(e(t,p),n)}function h(t,n,a,s,o,p,h){return t=r(t,r(r(i(n,a,s),o),h)),r(e(t,p),n)}function u(t,n,a,i,o,p,h){return t=r(t,r(r(s(n,a,i),o),h)),r(e(t,p),n)}function c(t){for(var e,r=t.length,n=r+8,a=(n-n%64)/64,i=16*(a+1),s=Array(i-1),o=0,p=0;r>p;)e=(p-p%4)/4,o=p%4*8,s[e]=s[e]|t.charCodeAt(p)<<o,p++;return e=(p-p%4)/4,o=p%4*8,s[e]=s[e]|128<<o,s[i-2]=r<<3,s[i-1]=r>>>29,s}function l(t){var e,r,n="",a="";for(r=0;3>=r;r++)e=t>>>8*r&255,a="0"+e.toString(16),n+=a.substr(a.length-2,2);return n}function f(t){t=t.replace(/\r\n/g,"\n");for(var e="",r=0;r<t.length;r++){var n=t.charCodeAt(r);128>n?e+=String.fromCharCode(n):n>127&&2048>n?(e+=String.fromCharCode(n>>6|192),e+=String.fromCharCode(63&n|128)):(e+=String.fromCharCode(n>>12|224),e+=String.fromCharCode(n>>6&63|128),e+=String.fromCharCode(63&n|128))}return e}var g,T,d,y,v,m,b,S,E,_=Array(),A=7,C=12,w=17,I=22,k=5,O=9,N=14,D=20,M=4,L=11,R=16,x=23,B=6,P=10,G=15,U=21;for(t=f(t),_=c(t),m=1732584193,b=4023233417,S=2562383102,E=271733878,g=0;g<_.length;g+=16)T=m,d=b,y=S,v=E,m=o(m,b,S,E,_[g+0],A,3614090360),E=o(E,m,b,S,_[g+1],C,3905402710),S=o(S,E,m,b,_[g+2],w,606105819),b=o(b,S,E,m,_[g+3],I,3250441966),m=o(m,b,S,E,_[g+4],A,4118548399),E=o(E,m,b,S,_[g+5],C,1200080426),S=o(S,E,m,b,_[g+6],w,2821735955),b=o(b,S,E,m,_[g+7],I,4249261313),m=o(m,b,S,E,_[g+8],A,1770035416),E=o(E,m,b,S,_[g+9],C,2336552879),S=o(S,E,m,b,_[g+10],w,4294925233),b=o(b,S,E,m,_[g+11],I,2304563134),m=o(m,b,S,E,_[g+12],A,1804603682),E=o(E,m,b,S,_[g+13],C,4254626195),S=o(S,E,m,b,_[g+14],w,2792965006),b=o(b,S,E,m,_[g+15],I,1236535329),m=p(m,b,S,E,_[g+1],k,4129170786),E=p(E,m,b,S,_[g+6],O,3225465664),S=p(S,E,m,b,_[g+11],N,643717713),b=p(b,S,E,m,_[g+0],D,3921069994),m=p(m,b,S,E,_[g+5],k,3593408605),E=p(E,m,b,S,_[g+10],O,38016083),S=p(S,E,m,b,_[g+15],N,3634488961),b=p(b,S,E,m,_[g+4],D,3889429448),m=p(m,b,S,E,_[g+9],k,568446438),E=p(E,m,b,S,_[g+14],O,3275163606),S=p(S,E,m,b,_[g+3],N,4107603335),b=p(b,S,E,m,_[g+8],D,1163531501),m=p(m,b,S,E,_[g+13],k,2850285829),E=p(E,m,b,S,_[g+2],O,4243563512),S=p(S,E,m,b,_[g+7],N,1735328473),b=p(b,S,E,m,_[g+12],D,2368359562),m=h(m,b,S,E,_[g+5],M,4294588738),E=h(E,m,b,S,_[g+8],L,2272392833),S=h(S,E,m,b,_[g+11],R,1839030562),b=h(b,S,E,m,_[g+14],x,4259657740),m=h(m,b,S,E,_[g+1],M,2763975236),E=h(E,m,b,S,_[g+4],L,1272893353),S=h(S,E,m,b,_[g+7],R,4139469664),b=h(b,S,E,m,_[g+10],x,3200236656),m=h(m,b,S,E,_[g+13],M,681279174),E=h(E,m,b,S,_[g+0],L,3936430074),S=h(S,E,m,b,_[g+3],R,3572445317),b=h(b,S,E,m,_[g+6],x,76029189),m=h(m,b,S,E,_[g+9],M,3654602809),E=h(E,m,b,S,_[g+12],L,3873151461),S=h(S,E,m,b,_[g+15],R,530742520),b=h(b,S,E,m,_[g+2],x,3299628645),m=u(m,b,S,E,_[g+0],B,4096336452),E=u(E,m,b,S,_[g+7],P,1126891415),S=u(S,E,m,b,_[g+14],G,2878612391),b=u(b,S,E,m,_[g+5],U,4237533241),m=u(m,b,S,E,_[g+12],B,1700485571),E=u(E,m,b,S,_[g+3],P,2399980690),S=u(S,E,m,b,_[g+10],G,4293915773),b=u(b,S,E,m,_[g+1],U,2240044497),m=u(m,b,S,E,_[g+8],B,1873313359),E=u(E,m,b,S,_[g+15],P,4264355552),S=u(S,E,m,b,_[g+6],G,2734768916),b=u(b,S,E,m,_[g+13],U,1309151649),m=u(m,b,S,E,_[g+4],B,4149444226),E=u(E,m,b,S,_[g+11],P,3174756917),S=u(S,E,m,b,_[g+2],G,718787259),b=u(b,S,E,m,_[g+9],U,3951481745),m=r(m,T),b=r(b,d),S=r(S,y),E=r(E,v);var F=l(m)+l(b)+l(S)+l(E);return F.toLowerCase()},Trap.Set=function(){Trap.List.prototype.constructor.call(this)},Trap.Set.prototype=new Trap.List,Trap.Set.prototype.className="set",Trap.Set.prototype.add=function(t,e){var r=t;e&&"number"==typeof t&&(r=e),this.contains(r)||Trap.List.prototype.add.call(this,t,e)},function(){navigator&&navigator.userAgent.match(/OS 6(_\d)+/i)&&"undefined"!=typeof window&&!function(t){function e(e,r,n){function a(){o&&(o.apply(t,arguments),p||(delete r[i],o=null))}var i,o=n[0],p=e===s;return n[0]=a,i=e.apply(t,n),r[i]={args:n,created:Date.now(),cb:o,id:i},i}function r(e,r,n,a,i){function o(){p.cb&&(p.cb.apply(t,arguments),h||(delete n[a],p.cb=null))}var p=n[a];if(p){var h=e===s;if(r(p.id),!h){var u=p.args[1],c=Date.now()-p.created;0>c&&(c=0),u-=c,0>u&&(u=0),p.args[1]=u}p.args[0]=o,p.created=Date.now(),p.id=e.apply(t,p.args)}}var n={},a={},i=t.setTimeout,s=t.setInterval,o=t.clearTimeout,p=t.clearInterval;t.setTimeout=function(){return e(i,n,arguments)},t.setInterval=function(){return e(s,a,arguments)},t.clearTimeout=function(t){var e=n[t];e&&(delete n[t],o(e.id))},t.clearInterval=function(t){var e=a[t];e&&(delete a[t],p(e.id))},t.addEventListener("scroll",function(){var t;for(t in n)r(i,o,n,t);for(t in a)r(s,p,a,t)})}(window)}(),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(t){return 0==this.indexOf(t)}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(t){for(var e=t.replace(/^\s\s*/,""),r=/\s/,n=e.length;r.test(e.charAt(--n)););return e.slice(0,n+1)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(t){return-1!==this.indexOf(t,this.length-t.length)}),"function"!=typeof String.prototype.contains&&(String.prototype.contains=function(t){return-1!=this.indexOf(t)}),"function"!=typeof String.prototype.utf8ByteLength&&(String.prototype.utf8ByteLength=function(){var t=encodeURIComponent(this).match(/%[89ABab]/g);return this.length+(t?t.length:0)}),"function"!=typeof String.prototype.toUTF8ByteArray&&(String.prototype.toUTF8ByteArray=function(){for(var t=[],e=unescape(encodeURIComponent(this)),r=0;r<e.length;r++){var n=e.charCodeAt(r);t.push(n)}return t}),String.utf8Encode=function(t){return unescape(encodeURIComponent(t))},String.utf8Decode=function(t){return decodeURIComponent(escape(t))},"function"!=typeof String.prototype.fromUTF8ByteArray&&(String.fromUTF8ByteArray=function(t,e,r){var n="";"undefined"==typeof e&&(e=0,r=t.length);for(var a=e;r>a;a++)n+=String.fromCharCode(t[a]);return String.utf8Decode(n)}),Trap.StringBuffer=function(){this.buf=""},Trap.StringBuffer.prototype.append=function(t){this.buf+=t},Trap.StringBuffer.prototype.toString=function(){return this.buf},Trap.StringBuilder=Trap.StringBuffer,function(){"use strict";function t(t){throw t}function e(t,e){var r=t.split("."),n=h;!(r[0]in n)&&n.execScript&&n.execScript("var "+r[0]);for(var a;r.length&&(a=r.shift());)r.length||e===p?n=n[a]?n[a]:n[a]={}:n[a]=e}function r(t){var e,r,n,a,i,s,o,p,h,c=t.length,l=0,f=Number.POSITIVE_INFINITY;for(p=0;c>p;++p)t[p]>l&&(l=t[p]),t[p]<f&&(f=t[p]);for(e=1<<l,r=new(u?Uint32Array:Array)(e),n=1,a=0,i=2;l>=n;){for(p=0;c>p;++p)if(t[p]===n){for(s=0,o=a,h=0;n>h;++h)s=s<<1|1&o,o>>=1;for(h=s;e>h;h+=i)r[h]=n<<16|p;++a}++n,a<<=1,i<<=1}return[r,l,f]}function n(e,r){switch(this.g=[],this.h=32768,this.d=this.f=this.a=this.l=0,this.input=u?new Uint8Array(e):e,this.m=!1,this.i=l,this.r=!1,(r||!(r={}))&&(r.index&&(this.a=r.index),r.bufferSize&&(this.h=r.bufferSize),r.bufferType&&(this.i=r.bufferType),r.resize&&(this.r=r.resize)),this.i){case c:this.b=32768,this.c=new(u?Uint8Array:Array)(32768+this.h+258);break;case l:this.b=0,this.c=new(u?Uint8Array:Array)(this.h),this.e=this.z,this.n=this.v,this.j=this.w;break;default:t(Error("invalid inflate mode"))}}function a(e,r){for(var n,a=e.f,i=e.d,s=e.input,o=e.a;r>i;)n=s[o++],n===p&&t(Error("input buffer is broken")),a|=n<<i,i+=8;return n=a&(1<<r)-1,e.f=a>>>r,e.d=i-r,e.a=o,n}function i(t,e){for(var r,n,a,i=t.f,s=t.d,o=t.input,h=t.a,u=e[0],c=e[1];c>s&&(r=o[h++],r!==p);)i|=r<<s,s+=8;return n=u[i&(1<<c)-1],a=n>>>16,t.f=i>>a,t.d=s-a,t.a=h,65535&n}function s(t){function e(t,e,r){var n,s,o,p;for(p=0;t>p;)switch(n=i(this,e)){case 16:for(o=3+a(this,2);o--;)r[p++]=s;break;case 17:for(o=3+a(this,3);o--;)r[p++]=0;s=0;break;case 18:for(o=11+a(this,7);o--;)r[p++]=0;s=0;break;default:s=r[p++]=n}return r}var n,s,o,p,h=a(t,5)+257,c=a(t,5)+1,l=a(t,4)+4,f=new(u?Uint8Array:Array)(y.length);for(p=0;l>p;++p)f[y[p]]=a(t,3);n=r(f),s=new(u?Uint8Array:Array)(h),o=new(u?Uint8Array:Array)(c),t.j(r(e.call(t,h,n,s)),r(e.call(t,c,n,o)))}function o(e,r){var a,i;switch(this.input=e,this.a=0,(r||!(r={}))&&(r.index&&(this.a=r.index),r.verify&&(this.A=r.verify)),a=e[this.a++],i=e[this.a++],15&a){case M:this.method=M;break;default:t(Error("unsupported compression method"))}0!==((a<<8)+i)%31&&t(Error("invalid fcheck flag:"+((a<<8)+i)%31)),32&i&&t(Error("fdict flag is not supported")),this.q=new n(e,{index:this.a,bufferSize:r.bufferSize,bufferType:r.bufferType,resize:r.resize})}var p=void 0,h=this,u="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,c=0,l=1,f={t:c,s:l};n.prototype.k=function(){for(;!this.m;){var e=a(this,3);switch(1&e&&(this.m=!0),e>>>=1){case 0:var r=this.input,n=this.a,i=this.c,o=this.b,h=p,f=p,g=p,T=i.length,d=p;switch(this.d=this.f=0,h=r[n++],h===p&&t(Error("invalid uncompressed block header: LEN (first byte)")),f=h,h=r[n++],h===p&&t(Error("invalid uncompressed block header: LEN (second byte)")),f|=h<<8,h=r[n++],h===p&&t(Error("invalid uncompressed block header: NLEN (first byte)")),g=h,h=r[n++],h===p&&t(Error("invalid uncompressed block header: NLEN (second byte)")),g|=h<<8,f===~g&&t(Error("invalid uncompressed block header: length verify")),n+f>r.length&&t(Error("input buffer is broken")),this.i){case c:for(;o+f>i.length;){if(d=T-o,f-=d,u)i.set(r.subarray(n,n+d),o),o+=d,n+=d;else for(;d--;)i[o++]=r[n++];this.b=o,i=this.e(),o=this.b}break;case l:for(;o+f>i.length;)i=this.e({p:2});break;default:t(Error("invalid inflate mode"))}if(u)i.set(r.subarray(n,n+f),o),o+=f,n+=f;else for(;f--;)i[o++]=r[n++];this.a=n,this.b=o,this.c=i;break;case 1:this.j(O,D);break;case 2:s(this);break;default:t(Error("unknown BTYPE: "+e))}}return this.n()};var g,T,d=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],y=u?new Uint16Array(d):d,v=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],m=u?new Uint16Array(v):v,b=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],S=u?new Uint8Array(b):b,E=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],_=u?new Uint16Array(E):E,A=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],C=u?new Uint8Array(A):A,w=new(u?Uint8Array:Array)(288);for(g=0,T=w.length;T>g;++g)w[g]=143>=g?8:255>=g?9:279>=g?7:8;var I,k,O=r(w),N=new(u?Uint8Array:Array)(30);for(I=0,k=N.length;k>I;++I)N[I]=5;var D=r(N);n.prototype.j=function(t,e){var r=this.c,n=this.b;this.o=t;for(var s,o,p,h,u=r.length-258;256!==(s=i(this,t));)if(256>s)n>=u&&(this.b=n,r=this.e(),n=this.b),r[n++]=s;else for(o=s-257,h=m[o],0<S[o]&&(h+=a(this,S[o])),s=i(this,e),p=_[s],0<C[s]&&(p+=a(this,C[s])),n>=u&&(this.b=n,r=this.e(),n=this.b);h--;)r[n]=r[n++-p];for(;8<=this.d;)this.d-=8,this.a--;this.b=n},n.prototype.w=function(t,e){var r=this.c,n=this.b;this.o=t;for(var s,o,p,h,u=r.length;256!==(s=i(this,t));)if(256>s)n>=u&&(r=this.e(),u=r.length),r[n++]=s;else for(o=s-257,h=m[o],0<S[o]&&(h+=a(this,S[o])),s=i(this,e),p=_[s],0<C[s]&&(p+=a(this,C[s])),n+h>u&&(r=this.e(),u=r.length);h--;)r[n]=r[n++-p];for(;8<=this.d;)this.d-=8,this.a--;this.b=n},n.prototype.e=function(){var t,e,r=new(u?Uint8Array:Array)(this.b-32768),n=this.b-32768,a=this.c;if(u)r.set(a.subarray(32768,r.length));else for(t=0,e=r.length;e>t;++t)r[t]=a[t+32768];if(this.g.push(r),this.l+=r.length,u)a.set(a.subarray(n,n+32768));else for(t=0;32768>t;++t)a[t]=a[n+t];return this.b=32768,a},n.prototype.z=function(t){var e,r,n,a,i=this.input.length/this.a+1|0,s=this.input,o=this.c;return t&&("number"==typeof t.p&&(i=t.p),"number"==typeof t.u&&(i+=t.u)),2>i?(r=(s.length-this.a)/this.o[2],a=258*(r/2)|0,n=a<o.length?o.length+a:o.length<<1):n=o.length*i,u?(e=new Uint8Array(n),e.set(o)):e=o,this.c=e},n.prototype.n=function(){var t,e,r,n,a,i=0,s=this.c,o=this.g,p=new(u?Uint8Array:Array)(this.l+(this.b-32768));if(0===o.length)return u?this.c.subarray(32768,this.b):this.c.slice(32768,this.b);for(e=0,r=o.length;r>e;++e)for(t=o[e],n=0,a=t.length;a>n;++n)p[i++]=t[n];for(e=32768,r=this.b;r>e;++e)p[i++]=s[e];return this.g=[],this.buffer=p},n.prototype.v=function(){var t,e=this.b;return u?this.r?(t=new Uint8Array(e),t.set(this.c.subarray(0,e))):t=this.c.subarray(0,e):(this.c.length>e&&(this.c.length=e),t=this.c),this.buffer=t},o.prototype.k=function(){var e,r,n=this.input;if(e=this.q.k(),this.a=this.q.a,this.A){r=(n[this.a++]<<24|n[this.a++]<<16|n[this.a++]<<8|n[this.a++])>>>0;var a=e;if("string"==typeof a){var i,s,o=a.split("");for(i=0,s=o.length;s>i;i++)o[i]=(255&o[i].charCodeAt(0))>>>0;a=o}for(var p,h=1,u=0,c=a.length,l=0;c>0;){p=c>1024?1024:c,c-=p;do h+=a[l++],u+=h;while(--p);h%=65521,u%=65521}r!==(u<<16|h)>>>0&&t(Error("invalid adler-32 checksum"))}return e};var M=8;e("Zlib.Inflate",o),e("Zlib.Inflate.prototype.decompress",o.prototype.k);var L,R,x,B,P={ADAPTIVE:f.s,BLOCK:f.t};if(Object.keys)L=Object.keys(P);else for(R in L=[],x=0,P)L[x++]=R;for(x=0,B=L.length;B>x;++x)R=L[x],e("Zlib.Inflate.BufferType."+R,P[R])}.call(this),function(){"use strict";function t(t,e){var r=t.split("."),n=g;!(r[0]in n)&&n.execScript&&n.execScript("var "+r[0]);for(var a;r.length&&(a=r.shift());)r.length||e===l?n=n[a]?n[a]:n[a]={}:n[a]=e}function e(t,e){if(this.index="number"==typeof e?e:0,this.e=0,this.buffer=t instanceof(T?Uint8Array:Array)?t:new(T?Uint8Array:Array)(32768),2*this.buffer.length<=this.index)throw Error("invalid index");this.buffer.length<=this.index&&r(this)}function r(t){var e,r=t.buffer,n=r.length,a=new(T?Uint8Array:Array)(n<<1);if(T)a.set(r);else for(e=0;n>e;++e)a[e]=r[e];return t.buffer=a}function n(t){this.buffer=new(T?Uint16Array:Array)(2*t),this.length=0}function a(t,e){this.d=_,this.i=0,this.input=T&&t instanceof Array?new Uint8Array(t):t,this.c=0,e&&(e.lazy&&(this.i=e.lazy),"number"==typeof e.compressionType&&(this.d=e.compressionType),e.outputBuffer&&(this.a=T&&e.outputBuffer instanceof Array?new Uint8Array(e.outputBuffer):e.outputBuffer),"number"==typeof e.outputIndex&&(this.c=e.outputIndex)),this.a||(this.a=new(T?Uint8Array:Array)(32768))}function i(t,e){this.length=t,this.k=e}function s(t,e){function r(t,e){var r,n=t.k,a=[],i=0;r=I[t.length],a[i++]=65535&r,a[i++]=r>>16&255,a[i++]=r>>24;var s;switch(f){case 1===n:s=[0,n-1,0];break;case 2===n:s=[1,n-2,0];break;case 3===n:s=[2,n-3,0];break;case 4===n:s=[3,n-4,0];break;case 6>=n:s=[4,n-5,1];break;case 8>=n:s=[5,n-7,1];break;case 12>=n:s=[6,n-9,2];break;case 16>=n:s=[7,n-13,2];break;case 24>=n:s=[8,n-17,3];break;case 32>=n:s=[9,n-25,3];break;case 48>=n:s=[10,n-33,4];break;case 64>=n:s=[11,n-49,4];break;case 96>=n:s=[12,n-65,5];break;case 128>=n:s=[13,n-97,5];break;case 192>=n:s=[14,n-129,6];break;case 256>=n:s=[15,n-193,6];break;case 384>=n:s=[16,n-257,7];break;case 512>=n:s=[17,n-385,7];break;case 768>=n:s=[18,n-513,8];break;case 1024>=n:s=[19,n-769,8];break;case 1536>=n:s=[20,n-1025,9];break;case 2048>=n:s=[21,n-1537,9];break;case 3072>=n:s=[22,n-2049,10];break;case 4096>=n:s=[23,n-3073,10];break;case 6144>=n:s=[24,n-4097,11];break;case 8192>=n:s=[25,n-6145,11];break;case 12288>=n:s=[26,n-8193,12];break;case 16384>=n:s=[27,n-12289,12];break;case 24576>=n:s=[28,n-16385,13];break;case 32768>=n:s=[29,n-24577,13];break;default:throw"invalid distance"}r=s,a[i++]=r[0],a[i++]=r[1],a[i++]=r[2];var o,p;for(o=0,p=a.length;p>o;++o)y[v++]=a[o];b[a[0]]++,S[a[3]]++,m=t.length+e-1,c=null}var n,a,i,s,p,h,u,c,g,d={},y=T?new Uint16Array(2*e.length):[],v=0,m=0,b=new(T?Uint32Array:Array)(286),S=new(T?Uint32Array:Array)(30),E=t.i;if(!T){for(i=0;285>=i;)b[i++]=0;for(i=0;29>=i;)S[i++]=0}for(b[256]=1,n=0,a=e.length;a>n;++n){for(i=p=0,s=3;s>i&&n+i!==a;++i)p=p<<8|e[n+i];if(d[p]===l&&(d[p]=[]),h=d[p],!(0<m--)){for(;0<h.length&&32768<n-h[0];)h.shift();if(n+3>=a){for(c&&r(c,-1),i=0,s=a-n;s>i;++i)g=e[n+i],y[v++]=g,++b[g];break}0<h.length?(u=o(e,n,h),c?c.length<u.length?(g=e[n-1],y[v++]=g,++b[g],r(u,0)):r(c,-1):u.length<E?c=u:r(u,0)):c?r(c,-1):(g=e[n],y[v++]=g,++b[g])}h.push(n)}return y[v++]=256,b[256]++,t.m=b,t.l=S,T?y.subarray(0,v):y}function o(t,e,r){var n,a,s,o,p,h,u=0,c=t.length;o=0,h=r.length;t:for(;h>o;o++){if(n=r[h-o-1],s=3,u>3){for(p=u;p>3;p--)if(t[n+p-1]!==t[e+p-1])continue t;s=u}for(;258>s&&c>e+s&&t[n+s]===t[e+s];)++s;if(s>u&&(a=n,u=s),258===s)break}return new i(u,e-a)}function p(t,e){var r,a,i,s,o,p=t.length,u=new n(572),c=new(T?Uint8Array:Array)(p);if(!T)for(s=0;p>s;s++)c[s]=0;for(s=0;p>s;++s)0<t[s]&&u.push(s,t[s]);if(r=Array(u.length/2),a=new(T?Uint32Array:Array)(u.length/2),1===r.length)return c[u.pop().index]=1,c;for(s=0,o=u.length/2;o>s;++s)r[s]=u.pop(),a[s]=r[s].value;for(i=h(a,a.length,e),s=0,o=r.length;o>s;++s)c[r[s].index]=i[s];return c}function h(t,e,r){function n(t){var r=f[t][g[t]];r===e?(n(t+1),n(t+1)):--c[r],++g[t]}var a,i,s,o,p,h=new(T?Uint16Array:Array)(r),u=new(T?Uint8Array:Array)(r),c=new(T?Uint8Array:Array)(e),l=Array(r),f=Array(r),g=Array(r),d=(1<<r)-e,y=1<<r-1;for(h[r-1]=e,i=0;r>i;++i)y>d?u[i]=0:(u[i]=1,d-=y),d<<=1,h[r-2-i]=(h[r-1-i]/2|0)+e;for(h[0]=u[0],l[0]=Array(h[0]),f[0]=Array(h[0]),i=1;r>i;++i)h[i]>2*h[i-1]+u[i]&&(h[i]=2*h[i-1]+u[i]),l[i]=Array(h[i]),f[i]=Array(h[i]);for(a=0;e>a;++a)c[a]=r;for(s=0;s<h[r-1];++s)l[r-1][s]=t[s],f[r-1][s]=s;for(a=0;r>a;++a)g[a]=0;for(1===u[r-1]&&(--c[0],++g[r-1]),i=r-2;i>=0;--i){for(o=a=0,p=g[i+1],s=0;s<h[i];s++)o=l[i+1][p]+l[i+1][p+1],o>t[a]?(l[i][s]=o,f[i][s]=e,p+=2):(l[i][s]=t[a],f[i][s]=a,++a);g[i]=0,1===u[i]&&n(i)}return c}function u(t){var e,r,n,a,i=new(T?Uint16Array:Array)(t.length),s=[],o=[],p=0;for(e=0,r=t.length;r>e;e++)s[t[e]]=(0|s[t[e]])+1;for(e=1,r=16;r>=e;e++)o[e]=p,p+=0|s[e],p<<=1;for(e=0,r=t.length;r>e;e++)for(p=o[t[e]],o[t[e]]+=1,n=i[e]=0,a=t[e];a>n;n++)i[e]=i[e]<<1|1&p,p>>>=1;return i}function c(t,e){this.input=t,this.a=new(T?Uint8Array:Array)(32768),this.d=k.g;var r,n={};!e&&(e={})||"number"!=typeof e.compressionType||(this.d=e.compressionType);for(r in e)n[r]=e[r];n.outputBuffer=this.a,this.j=new a(this.input,n)}var l=void 0,f=!0,g=this,T="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;e.prototype.b=function(t,e,n){var a,i=this.buffer,s=this.index,o=this.e,p=i[s];if(n&&e>1&&(t=e>8?(S[255&t]<<24|S[t>>>8&255]<<16|S[t>>>16&255]<<8|S[t>>>24&255])>>32-e:S[t]>>8-e),8>e+o)p=p<<e|t,o+=e;else for(a=0;e>a;++a)p=p<<1|t>>e-a-1&1,8===++o&&(o=0,i[s++]=S[p],p=0,s===i.length&&(i=r(this)));i[s]=p,this.buffer=i,this.e=o,this.index=s},e.prototype.finish=function(){var t,e=this.buffer,r=this.index;return 0<this.e&&(e[r]<<=8-this.e,e[r]=S[e[r]],r++),T?t=e.subarray(0,r):(e.length=r,t=e),t};var d,y=new(T?Uint8Array:Array)(256);for(d=0;256>d;++d){for(var v=d,m=v,b=7,v=v>>>1;v;v>>>=1)m<<=1,m|=1&v,--b;y[d]=(m<<b&255)>>>0}var S=y;n.prototype.getParent=function(t){return 2*((t-2)/4|0)},n.prototype.push=function(t,e){var r,n,a,i=this.buffer;for(r=this.length,i[this.length++]=e,i[this.length++]=t;r>0&&(n=this.getParent(r),i[r]>i[n]);)a=i[r],i[r]=i[n],i[n]=a,a=i[r+1],i[r+1]=i[n+1],i[n+1]=a,r=n;return this.length},n.prototype.pop=function(){var t,e,r,n,a,i=this.buffer;for(e=i[0],t=i[1],this.length-=2,i[0]=i[this.length],i[1]=i[this.length+1],a=0;(n=2*a+2,!(n>=this.length))&&(n+2<this.length&&i[n+2]>i[n]&&(n+=2),i[n]>i[a]);)r=i[a],i[a]=i[n],i[n]=r,r=i[a+1],i[a+1]=i[n+1],i[n+1]=r,a=n;return{index:t,value:e,length:this.length}};var E,_=2,A={NONE:0,h:1,g:_,n:3},C=[];for(E=0;288>E;E++)switch(f){case 143>=E:C.push([E+48,8]);break;case 255>=E:C.push([E-144+400,9]);break;case 279>=E:C.push([E-256+0,7]);break;case 287>=E:C.push([E-280+192,8]);break;default:throw"invalid literal: "+E}a.prototype.f=function(){var t,r,n,a,i=this.input;switch(this.d){case 0:for(n=0,a=i.length;a>n;){r=T?i.subarray(n,n+65535):i.slice(n,n+65535),n+=r.length;var o=r,h=n===a,c=l,g=l,d=l,y=l,v=l,m=this.a,b=this.c;if(T){for(m=new Uint8Array(this.a.buffer);m.length<=b+o.length+5;)m=new Uint8Array(m.length<<1);m.set(this.a)}if(c=h?1:0,m[b++]=0|c,g=o.length,d=~g+65536&65535,m[b++]=255&g,m[b++]=g>>>8&255,m[b++]=255&d,m[b++]=d>>>8&255,T)m.set(o,b),b+=o.length,m=m.subarray(0,b);else{for(y=0,v=o.length;v>y;++y)m[b++]=o[y];m.length=b}this.c=b,this.a=m}break;case 1:var S=new e(T?new Uint8Array(this.a.buffer):this.a,this.c);S.b(1,1,f),S.b(1,2,f);var E,A,w,I=s(this,i);for(E=0,A=I.length;A>E;E++)if(w=I[E],e.prototype.b.apply(S,C[w]),w>256)S.b(I[++E],I[++E],f),S.b(I[++E],5),S.b(I[++E],I[++E],f);else if(256===w)break;
this.a=S.finish(),this.c=this.a.length;break;case _:var k,O,N,D,M,L,R,x,B,P,G,U,F,K,z,j=new e(T?new Uint8Array(this.a.buffer):this.a,this.c),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],H=Array(19);for(k=_,j.b(1,1,f),j.b(k,2,f),O=s(this,i),L=p(this.m,15),R=u(L),x=p(this.l,7),B=u(x),N=286;N>257&&0===L[N-1];N--);for(D=30;D>1&&0===x[D-1];D--);var V,Q,X,Z,q,Y,J=N,$=D,tt=new(T?Uint32Array:Array)(J+$),et=new(T?Uint32Array:Array)(316),rt=new(T?Uint8Array:Array)(19);for(V=Q=0;J>V;V++)tt[Q++]=L[V];for(V=0;$>V;V++)tt[Q++]=x[V];if(!T)for(V=0,Z=rt.length;Z>V;++V)rt[V]=0;for(V=q=0,Z=tt.length;Z>V;V+=Q){for(Q=1;Z>V+Q&&tt[V+Q]===tt[V];++Q);if(X=Q,0===tt[V])if(3>X)for(;0<X--;)et[q++]=0,rt[0]++;else for(;X>0;)Y=138>X?X:138,Y>X-3&&X>Y&&(Y=X-3),10>=Y?(et[q++]=17,et[q++]=Y-3,rt[17]++):(et[q++]=18,et[q++]=Y-11,rt[18]++),X-=Y;else if(et[q++]=tt[V],rt[tt[V]]++,X--,3>X)for(;0<X--;)et[q++]=tt[V],rt[tt[V]]++;else for(;X>0;)Y=6>X?X:6,Y>X-3&&X>Y&&(Y=X-3),et[q++]=16,et[q++]=Y-3,rt[16]++,X-=Y}for(t=T?et.subarray(0,q):et.slice(0,q),P=p(rt,7),K=0;19>K;K++)H[K]=P[W[K]];for(M=19;M>4&&0===H[M-1];M--);for(G=u(P),j.b(N-257,5,f),j.b(D-1,5,f),j.b(M-4,4,f),K=0;M>K;K++)j.b(H[K],3,f);for(K=0,z=t.length;z>K;K++)if(U=t[K],j.b(G[U],P[U],f),U>=16){switch(K++,U){case 16:F=2;break;case 17:F=3;break;case 18:F=7;break;default:throw"invalid code: "+U}j.b(t[K],F,f)}var nt,at,it,st,ot,pt,ht,ut,ct=[R,L],lt=[B,x];for(ot=ct[0],pt=ct[1],ht=lt[0],ut=lt[1],nt=0,at=O.length;at>nt;++nt)if(it=O[nt],j.b(ot[it],pt[it],f),it>256)j.b(O[++nt],O[++nt],f),st=O[++nt],j.b(ht[st],ut[st],f),j.b(O[++nt],O[++nt],f);else if(256===it)break;this.a=j.finish(),this.c=this.a.length;break;default:throw"invalid compression type"}return this.a};var w=function(){function t(t){switch(f){case 3===t:return[257,t-3,0];case 4===t:return[258,t-4,0];case 5===t:return[259,t-5,0];case 6===t:return[260,t-6,0];case 7===t:return[261,t-7,0];case 8===t:return[262,t-8,0];case 9===t:return[263,t-9,0];case 10===t:return[264,t-10,0];case 12>=t:return[265,t-11,1];case 14>=t:return[266,t-13,1];case 16>=t:return[267,t-15,1];case 18>=t:return[268,t-17,1];case 22>=t:return[269,t-19,2];case 26>=t:return[270,t-23,2];case 30>=t:return[271,t-27,2];case 34>=t:return[272,t-31,2];case 42>=t:return[273,t-35,3];case 50>=t:return[274,t-43,3];case 58>=t:return[275,t-51,3];case 66>=t:return[276,t-59,3];case 82>=t:return[277,t-67,4];case 98>=t:return[278,t-83,4];case 114>=t:return[279,t-99,4];case 130>=t:return[280,t-115,4];case 162>=t:return[281,t-131,5];case 194>=t:return[282,t-163,5];case 226>=t:return[283,t-195,5];case 257>=t:return[284,t-227,5];case 258===t:return[285,t-258,0];default:throw"invalid length: "+t}}var e,r,n=[];for(e=3;258>=e;e++)r=t(e),n[e]=r[2]<<24|r[1]<<16|r[0];return n}(),I=T?new Uint32Array(w):w,k=A;c.prototype.f=function(){var t,e,r,n,a,i,s=0;switch(i=this.a,t=Math.LOG2E*Math.log(32768)-8,e=t<<4|8,i[s++]=e,this.d){case k.NONE:n=0;break;case k.h:n=1;break;case k.g:n=2;break;default:throw Error("unsupported compression type")}r=n<<6|0,i[s++]=r|31-(256*e+r)%31;var o=this.input;if("string"==typeof o){var p,h,u=o.split("");for(p=0,h=u.length;h>p;p++)u[p]=(255&u[p].charCodeAt(0))>>>0;o=u}for(var c,l=1,f=0,g=o.length,d=0;g>0;){c=g>1024?1024:g,g-=c;do l+=o[d++],f+=l;while(--c);l%=65521,f%=65521}return a=(f<<16|l)>>>0,this.j.c=s,i=this.j.f(),s=i.length,T&&(i=new Uint8Array(i.buffer),i.length<=s+4&&(this.a=new Uint8Array(i.length+4),this.a.set(i),i=this.a),i=i.subarray(0,s+4)),i[s++]=a>>24&255,i[s++]=a>>16&255,i[s++]=a>>8&255,i[s++]=255&a,i},t("Zlib.Deflate",c),t("Zlib.Deflate.compress",function(t,e){return new c(t,e).f()}),t("Zlib.Deflate.prototype.compress",c.prototype.f);var O,N,D,M,L={NONE:k.NONE,FIXED:k.h,DYNAMIC:k.g};if(Object.keys)O=Object.keys(L);else for(N in O=[],D=0,L)O[D++]=N;for(D=0,M=O.length;M>D;++D)N=O[D],t("Zlib.Deflate.CompressionType."+N,L[N])}.call(this),Trap.Authentication=function(){this.getContextKeys=function(t){return[]},this.verifyAuthentication=function(t,e,r,n){return!0},this.createAuthenticationChallenge=function(t){return""},this.createAuthenticationResponse=function(t,e,r,n){return""}},Trap.Channel=function(t,e){this._parentEP=t,this._channelID=e,this._streamingEnabled=!1,this._chunkSize=16384,this._maxInFlightBytes=8*this._chunkSize,this._bytesInFlight=0,this._available=!1,this._messageId=1,this._maxMessageId=134217728,this._priority=0,this._outQueue=new Trap.List,this._inBuf=new Trap.MessageBuffer(50,1e3,1,1,this.maxMessageId),this.failedMessages=new Trap.List,this.tmp={},this.buf=new Trap.ByteArrayOutputStream,this.receivingFragment=!1},Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"parentEP"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"channelID"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"streamingEnabled"),Trap._compat.__defineGetter(Trap.Channel.prototype,"chunkSize"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"maxInFlightBytes"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"bytesInFlight"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"available"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"messageId"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"maxMessageId"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"outQueue"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"inBuf"),Trap._compat.__defineGetterSetter(Trap.Channel.prototype,"priority"),Trap._compat.__defineSetter(Trap.Channel.prototype,"chunkSize",function(t){var e=t;return e>16&&(e-=16),e>this.parentEP.getMaxChunkSize()&&(e=this.parentEP.getMaxChunkSize()),0>=e&&(e=Integer.MAX_VALUE),this._chunkSize=e,this}),Trap.Channel.prototype.assignMessageID=function(t){if(0==t.getMessageId()){var e=this.messageId++;e>this.maxMessageId&&(this.messageId=e=1),t.setMessageId(e)}},Trap.Channel.prototype.send=function(t,e){if(this.assignMessageID(t),!e){var r=t.getCompressedData();if(null!=r&&r.length>this.chunkSize){for(var n=0;n<r.length;n+=this.chunkSize){var a=Trap.subarray(r,n,Math.min(n+this.chunkSize,r.length)),i=new Trap.Message;i.setData(a),0==n?(i.setOp(Trap.Message.Operation.FRAGMENT_START),i.setMessageId(t.getMessageId())):n+this.chunkSize>=r.length?i.setOp(Trap.Message.Operation.FRAGMENT_END):i.setOp(Trap.Message.Operation.MESSAGE),i.setCompressed(t.getCompressed()),i.setTransportId(t.getTransportId()),i.setFormat(t.getFormat()),this.send(i,!0)}return}}t.setChannel(this.channelID),this.outQueue.addLast(t),this.bytesInFlight<this.maxInFlightBytes&&(this.available=!0)},Trap.Channel.prototype.messageSent=function(t){this.bytesInFlight-=t.length(),this.bytesInFlight<this.maxInFlightBytes&&null!=this.outQueue.peek()&&(this.available=!0),this.parentEP.kickSendingThread()},Trap.Channel.prototype.addFailedMessage=function(t){this.failedMessages.add(t)},Trap.Channel.prototype.rebuildMessageQueue=function(){if(!this.failedMessages.isEmpty()){for(var t=this.failedMessages.iterator();t.hasNext();)this.bytesInFlight-=t.next().length();for(var e=new Trap.List,r=new LinkedList,n=this.failedMessages.iterator(),a=n.next();null!=a&&0==a.getMessageId();)a=n.hasNext()?n.next():null;for(var i=this.outQueue.peek();null!=a||null!=i;)null!=i&&this.outQueue.pop(),null!=i&&null!=a?i.getMessageId()<a.getMessageId()?(r.add(i),i=null):(r.add(a),a=null):null==a?(r.add(i),i=null):(r.add(a),a=null),null==a&&n.hasNext()&&(a=n.next()),null==i&&(i=this.outQueue.peek());for(var s=-1,o=r.iterator();o.hasNext();){var p=o.next();p.getMessageId()!=s&&(s=p.getMessageId(),e.put(p))}this.outQueue=e,this.failedMessages.clear(),this.bytesInFlight<this.maxInFlightBytes&&null!=this.outQueue.peek()&&(this.available=!0)}},Trap.Channel.prototype.messagesAvailable=function(){return this.available},Trap.Channel.prototype.peek=function(){return this.messagesAvailable()?this.outQueue.peek():null},Trap.Channel.prototype.pop=function(){var t=null;return t=this.outQueue.pop(),null!=t&&(this.bytesInFlight+=t.length()),(null==this.outQueue.peek()||this.bytesInFlight>=this.maxInFlightBytes)&&(this.available=!1),t},Trap.Channel.prototype.receiveMessage=function(t,e){for(this.inBuf.put(t,e);;){try{for(;this.inBuf.fetch(this.tmp,!1);){if(!this.streamingEnabled)if(this.receivingFragment){switch(this.tmp.m.getOp()){case Trap.Message.Operation.FRAGMENT_END:this.receivingFragment=!1,this.tmp.m.setOp(Trap.Message.Operation.MESSAGE);case Trap.Message.Operation.MESSAGE:this.buf.write(this.tmp.m.getData())}if(this.receivingFragment)continue;this.tmp.m.setData(this.buf.toArray()),this.tmp.m.getCompressed()&&this.tmp.m.setData(new Zlib.Inflate(this.tmp.m.getData()).decompress()),this.buf=new Trap.ByteArrayOutputStream}else if(this.tmp.m.getOp()==Trap.Message.Operation.FRAGMENT_START){this.receivingFragment=!0,this.buf.write(this.tmp.m.getData());continue}this.parentEP.executeMessageReceived(this.tmp.m,this.tmp.t)}}catch(r){console.log(r.stack)}finally{}if(!(this.inBuf.available()>0))return}},Trap.Channel.prototype.toString=function(){return"("+this.channelID+"/o:"+this.outQueue.length()+"/i:"+this.inBuf.toString()+")"},Trap.ChannelMessageQueue=function(){this.priorities=[],this.cPrio=0,this.cPrioIndex=0,this.cPrioBytes=0;var t=function(){this.channels=[],this.currChannel=0,this.getPriority=function(){return this.channels.length>0?this.channels[0].getPriority():Number.MIN_VALUE},this.peek=function(){try{for(var t=this.currChannel,e=this.currChannel+this.channels.length,r=t;e>r;r++){var n=this.channels[this.currChannel%this.channels.length].peek();if(null!=n)return n;this.currChannel++}return null}finally{this.currChannel=this.currChannel%this.channels.length}},this.pop=function(){var t=this.channels[this.currChannel].pop();return this.currChannel++,t},this.addChannel=function(t){this.channels.push(t)},this.toString=function(){var t=new StringBuilder;t.append("{");for(var e=0;e<this.channels.length;e++)e>0&&t.append(", "),t.append(this.channels[e].toString());return t.append("}"),t.toString()}};this.rebuild=function(e){var r=new Trap.List;r.addAll(e),r.sort(function(t,e){return e.getPriority()-t.getPriority()});for(var n=[],a=r.iterator(),i=Number.MIN_VALUE,s=null;a.hasNext();){var o=a.next();o.getPriority()!=i&&(s=new t,n.push(s),i=o.getPriority()),s.addChannel(o)}this.priorities=n,this.setPrioIndex(0)},this.peek=function(){for(var t=this.cPrioIndex;t<this.priorities.length;t++){var e=this.priorities[t].peek();if(null!=e)return this.cPrioIndex=t,e}return null},this.pop=function(){var t=this.priorities[this.cPrioIndex].pop(),e=t.length();return this.cPrioBytes+=e,this.cPrioBytes>this.cPrio&&this.setPrioIndex(this.cPrioIndex++),t},this.rewind=function(){this.setPrioIndex(0)},this.setPrioIndex=function(t){t<this.priorities.length&&(this.cPrioIndex=t,this.cPrio=this.priorities[this.cPrioIndex].getPriority(),this.cPrioBytes=0)},this.toString=function(){var t=new Trap.StringBuilder;t.append("[\n");for(var e=0;e<this.priorities.length;e++){var r=this.priorities[e];t.append("	"),t.append(r.getPriority()),t.append(": "),t.append(r.toString()),t.append("\n")}return t.append("\n]"),t.toString()}},Trap.Configuration=function(t){this.config=new Trap.Map,null!=t&&this.initFromString(t)},Trap.Configuration.CONFIG_HASH_PROPERTY="trap.confighash",Trap.Configuration.prototype.initFromString=function(t){for(var e=t.split("\n"),r=0;r<e.length;r++){var n=e[r].trim(),a=n.indexOf("=");0>a||a>=n.length-1||this.config.put(n.substring(0,a).trim(),n.substring(a+1).trim())}},Trap.Configuration.prototype.createPuttableGettableMap=function(t,e){var r=this,n=new Trap.Map;return"undefined"==typeof e&&(e=!0),n.prefixKey=function(r){return sb=e?t:r,e&&(t.endsWith(".")||(sb+="."),sb+=r),sb},n.put=function(t,e){if(null==t||null==e)throw"Cannot put nil key or value";r.config.put(n.prefixKey(t),e),Trap.Map.prototype.put.call(n,t,e)},n},Trap.Configuration.prototype.getOptions=function(t,e){"undefined"==typeof e&&(e=!0);for(var r=e&&!t.endsWith(".")?1:0,n=this.createPuttableGettableMap(t,e),a=this.config.allKeys(),i=0;i<a.length;i++){var s=a[i],o=this.config.get(s);s.startsWith(t)&&(e&&(s=s.substring(t.length+r)),n.put(s,o))}return n},Trap.Configuration.prototype.toString=function(){for(var t=this.config.allKeys().sort(),e=new Trap.StringBuilder,r=0;r<t.length;r++)e.append(t[r]),e.append(" = "),e.append(this.config.get(t[r])),e.append("\n");return e.toString()},Trap.Configuration.prototype.getOption=function(t,e){return this.config.get("undefined"!=typeof e?t+"."+e:t)},Trap.Configuration.prototype.getIntOption=function(t,e){var r=parseInt(this.getOption(t));return isNaN(r)?e:r},Trap.Configuration.prototype.getBooleanOption=function(t,e){var r=this.getOption(t);return"string"!=typeof r?e:"true"===r.toLowerCase()?!0:"false"===r.toLowerCase()?e:void 0},Trap.Configuration.prototype.setOption=function(t,e,r){this.config.put("undefined"!=typeof r?t+"."+e:t,"undefined"!=typeof r?r:e)},Trap.CustomConfiguration=function(t){Trap.Configuration.prototype.constructor.call(this,t),this.setStaticConfiguration(t)},Trap.CustomConfiguration.prototype=new Trap.Configuration,Trap.CustomConfiguration.prototype.constructor=Trap.CustomConfiguration,Trap.CustomConfiguration.prototype.setStaticConfiguration=function(t){this.staticConfig=new Trap.Configuration(t)},Trap.CustomConfiguration.prototype.getOptions=function(t,e){var r=this.createPuttableGettableMap(t,e);return r.putAll(this.staticConfig.getOptions(t,e)),r.putAll(Trap.Configuration.prototype.getOptions.call(this,t,e)),r},Trap.CustomConfiguration.prototype.getOption=function(){var t=Trap.Configuration.prototype.getOption.apply(this,arguments);return null==t&&(t=this.staticConfig.getOption.apply(this.staticConfig,arguments)),t},Trap.CustomConfiguration.prototype.toString=function(){var t=new Trap.StringBuffer,e=new Array;e.push.apply(e,this.staticConfig.config.allKeys()),e.push.apply(e,this.config.allKeys()),e.sort();for(var r=e.length,n=[],a={},i=0;r>i;i++)a[e[i]]=0;for(i in a)n.push(i);for(var i=0;i<n.length;i++){var s=n[i];t.append(s),t.append(" = "),t.append(this.getOption(s)),t.append("\n")}return t.toString()},Trap.Keepalive={},Trap.Keepalive.Policy={DISABLED:-1,DEFAULT:0},Trap.Keepalive.StaticPredictor=function(){this.keepaliveInterval=Trap.Keepalive.Policy.DISABLED,this.mKeepaliveInterval=30,this.minKeepalive=1,this.maxKeepalive=999999,this.lastInterval=this.mKeepaliveInterval,this.growthStep=0,this.nextInterval=this.mKeepaliveInterval+this.growthStep,this.minAutoKeepalive=1,this.maxAutoKeepalive=1680,this.lastDataReceived=0,this.lastDataSent=0,this.lastSentKeepalive=0,this.keepaliveTask=null,this.keepaliveTaskTime=0,this.keepaliveExpiryMsec=5e3,this.keepaliveData=null,this.started=!1,this.delegate=null,this.setMinKeepalive=function(t){this.minKeepalive=t},this.setMaxKeepalive=function(t){this.maxKeepalive=t},this.setMinAutoKeepalive=function(t){this.minAutoKeepalive=t},this.setMaxAutoKeepalive=function(t){this.maxAutoKeepalive=t},this.setKeepaliveInterval=function(t){this.keepaliveInterval=t,t==Trap.Keepalive.Policy.DEFAULT?this.nextInterval=this.mKeepaliveInterval:t==Trap.Keepalive.Policy.DISABLED?this.nextInterval=-1:t>this.maxKeepalive||t<this.minKeepalive?this.nextInterval=this.mKeepaliveInterval:this.nextInterval=t},this.getKeepaliveInterval=function(){return this.keepaliveInterval},this.getNextKeepaliveSend=function(){var t=Math.min(this.lastDataReceived,this.lastDataSent),e=t+1e3*this.nextInterval,r=(new Date).valueOf(),n=e-r;return n},this.keepaliveReceived=function(t,e,r,n){if(t)this.delegate.get().shouldSendKeepalive(!1,this.getPingType(),this.nextInterval,n);else{if(n!=this.keepaliveData)return;switch(this.keepaliveData=null,e){case"1":break;case"2":this.setKeepaliveInterval(r);break;case"3":}this.schedule()}},this.nextKeepaliveReceivedDelta=function(){if(null==this.keepaliveData)return Number.MAX_VALUE;var t=this.lastSentKeepalive,e=(new Date).valueOf();return t-e},this.setDelegate=function(t){this.delegate={get:function(){return t}}},this.setKeepaliveExpiry=function(t){this.keepaliveExpiryMsec=t,this.schedule()},this.getKeepaliveExpiry=function(){return this.keepaliveExpiryMsec},this.start=function(){if(this.getKeepaliveInterval()!=Trap.Keepalive.Policy.DISABLED){if(this.started)return void this.schedule();this.nextKeepaliveReceivedDelta()<=0&&(this.lastReceivedKeepalive=(new Date).valueOf()),this.keepaliveData=null,this.lastSentKeepalive=0,this.keepaliveTaskTime=0,this.started=!0,this.schedule()}},this.stop=function(){this.started&&(null!=this.keepaliveTask&&(this.keepaliveTask.cancel(),this.keepaliveTask=null),this.started=!1)},this.schedule=function(){if(this.getKeepaliveInterval()!=Trap.Keepalive.Policy.DISABLED&&this.started){var t=null==this.keepaliveData?this.getNextKeepaliveSend():Number.MAX_VALUE,e=this.nextKeepaliveReceivedDelta()+(null==this.keepaliveData?0:this.keepaliveExpiryMsec),r=Math.min(t,e);500>=r&&(r=501);var n=r+(new Date).valueOf();if(null!=this.keepaliveTask){if(this.keepaliveTaskTime<=n+250&&this.keepaliveTaskTime>(new Date).valueOf())return;this.keepaliveTask.cancel()}this.keepaliveTaskTime=n;var a=this;this.keepaliveTask={run:function(){a.run()},cancel:function(){clearTimeout(this.timeout)}},this.keepaliveTask.timeout=setTimeout(this.keepaliveTask.run,r)}},this.run=function(){var t=this.delegate.get();if(null==t)return void this.stop();if(this.getKeepaliveInterval()==Trap.Keepalive.Policy.DISABLED)return void this.stop();var e=this.nextKeepaliveReceivedDelta();if(0>e&&-e>this.keepaliveExpiryMsec)return t.predictedKeepaliveExpired(this,-e),void this.stop();e=this.getNextKeepaliveSend(),0>=e&&(null!=this.keepaliveData||(this.keepaliveData="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,r="x"==t?e:3&e|8;return r.toString(16)}),this.lastSentKeepalive=(new Date).valueOf(),this.lastInterval=this.nextInterval,t.shouldSendKeepalive(!0,this.getPingType(),this.nextInterval,this.keepaliveData))),this.keepaliveTaskTime=0;var r=this;setTimeout(function(){r.schedule()},1)},this.getPingType=function(){var t="1";return this.getKeepaliveInterval()>0&&(t="2"),t},this.dataReceived=function(){this.lastDataReceived=(new Date).valueOf()},this.dataSent=function(){this.lastDataSent=(new Date).valueOf()}},Trap.MessageBuffer=function(t,e,r,n,a){this.buffer=new Array(t),this.minMessageId=n,this.maxMessageId=a,this.bufGrowthSize=t,this.maxBufSize=e,this.readMessageID=this.writeMessageID=r,this.fillEmptyBuf=function(t){for(var e=0;e<t.length;e++){var r=t[e];null==r&&(t[e]={m:null,t:null})}},this.fillEmptyBuf(this.buffer),this.available=function(){return this.writeMessageID-this.readMessageID},this.put=function(t,e){var r=t.getMessageId();if(r>this.maxMessageId||r<this.minMessageId)throw"Message ID ["+r+"] outside of acceptable range ["+this.minMessageId+", "+this.maxMessageId+"].";if(r<this.readMessageID){if(!(this.readMessageID-r>(this.maxMessageId-this.minMessageId)/2))return;r+=this.maxMessageId-this.minMessageId+1}if(r>this.readMessageID+this.maxBufSize)throw"Message ID ["+r+"] outside of buffer size. First message has ID ["+this.readMessageID+"] and max buffer size is "+this.maxBufSize;if(!(r<this.writeMessageID)){if(r>=this.readMessageID+this.buffer.length){var n=r-this.readMessageID;n/=this.bufGrowthSize,n++,n*=this.bufGrowthSize;var a=new Array(n);this.fillEmptyBuf(a);for(var i=0;i<this.buffer.length;i++){var s=this.buffer[i];null!=s.m&&(a[s.m.getMessageId()%a.length]=s)}this.buffer=a}var o=this.buffer[r%this.buffer.length];if(o.m=t,o.t=e,r==this.writeMessageID)do{var p=this.writeMessageID;if(p>this.maxMessageId&&(p-=this.maxMessageId-this.minMessageId+1),o.m.getMessageId()!=p)throw"Trap Message Buffer corrupted. Unexpected message ID found. This needs debugging...";this.writeMessageID++,o=this.buffer[this.writeMessageID%this.buffer.length]}while(null!=o.m&&this.writeMessageID-this.readMessageID<this.buffer.length)}},this.fetch=function(t,e){if(this.readMessageID>=this.writeMessageID)return t.m=null,t.t=null,!1;try{for(var r=null;;){if(r=this.buffer[this.readMessageID%this.buffer.length],null!=r.m)return this.readMessageID++,t.m=r.m,t.t=r.t,r.m=null,r.t=null,!0;if(!(e&&this.readMessageID<this.writeMessageID))return!1;this.readMessageID++}}catch(n){throw n}finally{if(this.readMessageID>this.maxMessageId){var a=new Array(this.buffer.length);this.fillEmptyBuf(a),this.readMessageID-=this.maxMessageId-this.minMessageId+1,this.writeMessageID-=this.maxMessageId-this.minMessageId+1;for(var i=0;i<a.length;i++){var s=this.buffer[i];null!=s.m&&(a[s.m.getMessageId()%a.length]=s)}this.buffer=a}}}},Trap.Endpoint=function(){Trap.EventObject.constructor.call(this),this.transportsMap=new Trap.Map,this.transports=new Trap.List,this.config=new Trap.Configuration,this.availableTransports=new Trap.List,this._state=Trap.Endpoint.State.CLOSED,this.channels=new Array,this.messageQueue=new Trap.ChannelMessageQueue,this.messageQueueType=Trap.Endpoint.Queue.REGULAR,this._maxActiveTransports=65535,this.sending=!1,this.trapID=0,this.trapFormat=this.useBinary?Trap.Message.Format.REGULAR:Trap.Message.Format.SEVEN_BIT_SAFE,this._authentication=new Trap.Authentication,this.logger=Trap.Logger.getLogger("TrapEndpoint"),this._lastAlive=0,this.canWakeupUntil=0,this.canReconnectUntil=0,this.keepaliveExpiry=5e3,this.keepaliveInterval=Trap.Keepalive.Policy.DEFAULT,this.keepaliveTask=null,this.reconnectTimeout=18e4,this.async=!0,this.compressionEnabled=this.useBinary,Trap._compat.__defineGetter(this,"state",function(){return this._state}),Trap._compat.__defineGetter(this,"queueType",function(){return this.messageQueueType}),Trap._compat.__defineSetter(this,"queueType",function(t){this.messageQueueType=t}),Trap._compat.__defineGetter(this,"maxActiveTransports",function(){return this._maxActiveTransports}),Trap._compat.__defineSetter(this,"maxActiveTransports",function(t){this._maxActiveTransports=t}),Trap._compat.__defineGetter(this,"authentication",function(){return this._authentication}),Trap._compat.__defineSetter(this,"authentication",function(t){this._authentication=t;for(var e=0;e<this.transports.size();e++)this.transports.get(e).setAuthentication(t)}),Trap._compat.__defineGetter(this,"format",function(){return this.trapFormat}),Trap._compat.__defineSetter(this,"format",function(t){this.trapFormat=t;for(var e=this.transports.iterator();e.hasNext();)e.next().setFormat(t)}),this.useBinary?Trap._useGetters?this._dispatchMessageEvent=function(t){var e=new Trap._GetterMessageEvent(t);this._dispatchEvent(e)}:this._dispatchMessageEvent=function(t){var e={type:"message",message:t.getData(),dataAsString:t.getString(),buffer:t.getData().buffer.slice(t.data.byteOffset,t.data.byteOffset+t.data.byteLength),compression:t.getCompression(),channel:t.getChannel(),object:JSON.parse(t.getString())};e.data=e.message,e.string=e.dataAsString,this._dispatchEvent(e)}:this._dispatchMessageEvent=function(t){var e={type:"message",message:t.getString(),channel:t.getChannel()};e.data=e.message,e.dataAsString=e.data,e.string=e.data,this._dispatchEvent(e)},this.channels[0]=new Trap.Channel(this,0),this.channels[0].setPriority(Number.MAX_VALUE),this.messageQueue.rebuild(this.channels)},Trap.Endpoint.prototype=new Trap.EventObject,Trap.Endpoint.prototype.constructor=Trap.Endpoint,Trap.Endpoint.State={CLOSED:"Trap.Endpoint.State.CLOSED",OPENING:"Trap.Endpoint.State.OPENING",OPEN:"Trap.Endpoint.State.OPEN",SLEEPING:"Trap.Endpoint.State.SLEEPING",ERROR:"Trap.Endpoint.State.ERROR",CLOSING:"Trap.Endpoint.State.CLOSING"},Trap.Endpoint.Queue={REGULAR:"Trap.Endpoint.Queue.REGULAR"},Trap.Endpoint.prototype.enableTransport=function(t){this.isTransportEnabled(t)||this.getTransport(t).enable()},Trap.Endpoint.prototype.disableTransport=function(t){this.isTransportEnabled(t)&&this.getTransport(t).disable()},Trap.Endpoint.prototype.disableAllTransports=function(){for(var t=0;t<this.transports.size();t++)this.transports.get(t).disable()},Trap.Endpoint.prototype.isTransportEnabled=function(t){try{return this.getTransport(t).isEnabled()}catch(e){return!1}},Trap.Endpoint.prototype.getConfiguration=function(){return this.config.toString()},Trap.Endpoint.prototype.parseConfiguration=function(t){return new Trap.Configuration(t)},Trap.Endpoint.prototype.configure=function(t){this.config=this.parseConfiguration(t);for(var e=0;e<this.transports.size();e++)this.transports.get(e).setConfiguration(this.config);var r=this.config.getIntOption("trap.keepalive.interval",this.keepaliveInterval);this.setKeepaliveInterval(r),r=this.config.getIntOption("trap.keepalive.expiry",this.keepaliveExpiry),this.setKeepaliveExpiry(r),this.compressionEnabled=this.config.getBooleanOption(Trap.Constants.OPTION_ENABLE_COMPRESSION,this.compressionEnabled)},Trap.Endpoint.prototype.configureTransport=function(t,e,r){this.getTransport(t).configure(e,r)},Trap.Endpoint.prototype.getTransports=function(){return this.transports},Trap.Endpoint.prototype.getTransport=function(t){var e=this.transportsMap.get(t);if(null==e)throw"Unknown Transport";return e},Trap.Endpoint.prototype.addTransport=function(t,e){if(!t.canConnect()&&!t.canListen()&&t.getState()==Trap.Transport.State.DISCONNECTED)return this.logger.debug("Attempting to add transport class [{}] for handler [{}] that can neither connect nor listen. Skipping...",t,t.getTransportName()),!1;var r=this.transportsMap.get(t.getTransportName());if(null!=r){var n=r.getTransportPriority(),a=t.getTransportPriority();if(a>n)return this.logger.debug("Attempting to add new handler for [{}] when the old handler had a higher priority. New class was [{}]/{}, old class was [{}]{}. Skipping...",t.getTransportName(),t.getClass().getName(),t.getTransportPriority(),r.getClass().getName(),r.getTransportPriority()),!1;this.transports.remove(r)}this.transportsMap.put(t.getTransportName(),t),this.transports.add(t),t.setFormat(this.getFormat());var i=this;if(t.onmessage=function(e){i.ttMessageReceived(e.message,t,null)},t.onmessagesent=function(e){i.ttMessageSent(e.message,t,null)},t.onstatechange=function(e){i.ttStateChanged(e.newState,e.oldState,t,null)},t.onfailedsending=function(e){i.ttMessagesFailedSending(e.messages,t,null)},e){t.setConfiguration(this.config),t.setAuthentication(this.authentication),t.setTrapID(this.trapID),t.setFormat(this.getFormat());var s=new Trap.List(this.availableTransports),o=function(t){if(!(t>=s.size())){var e=s.get(t);e.isAlive(0,!0,!0,4e3,function(t){t?e.getState()==Trap.Transport.State.AVAILABLE&&this.addTransportToAvailable(e):e.forceError()})}};t.getState()==Trap.Transport.State.AVAILABLE?(this.availableTransports.clear(),o(0),this.addTransportToAvailable(t)):o(0),this.ttMessageReceived(e,t,null)}},Trap.Endpoint.prototype.setTrapID=function(t){this.trapID=t},Trap.Endpoint.prototype.getTrapID=function(){return this.trapID},Trap.Endpoint.prototype.removeTransport=function(t){this.transportsMap.remove(t.getTransportName()),this.transports.remove(t)},Trap.Endpoint.prototype.close=function(){if(this.getState()!=Trap.Endpoint.State.OPEN)if(this.getState()==Trap.Endpoint.State.SLEEPING)this.setState(Trap.Endpoint.State.CLOSING),this.onEnd(null,null);else{if(this.getState()==Trap.Endpoint.State.CLOSING||this.getState()==Trap.Endpoint.State.CLOSED)return;if(this.getState()==Trap.Endpoint.State.ERROR)return void this.logger.debug("Called close() on an endpoint in state ERROR. This might be caused by recovery code shared between regular and normal states");this.getState()==Trap.Endpoint.State.OPENING&&this.logger.debug("Called close() on an endpoint in state OPENING. This message is logged for debug purposes (if we don't fully close).")}this.setState(Trap.Endpoint.State.CLOSING);try{this.sendMessage(this.createMessage().setOp(Trap.Message.Operation.END))}catch(t){this.logger.error("Setting Trap.Endpoint.State to ERROR due to an error while disconnecting that may have left the implementation in an inconsistent state"),this.setState(Trap.Endpoint.State.ERROR)}},Trap.Endpoint.prototype.send=function(t,e,r){var n=this.createMessage().setOp(Trap.Message.Operation.MESSAGE).setData(t);r?n.setCompressed(r&&this.compressionEnabled&&this.useBinary):n.setCompressed(!1),"number"==typeof e&&n.setChannel(e),this.sendMessage(n)},Trap.Endpoint.prototype.sendMessage=function(t){if(this.getState()!=Trap.Endpoint.State.OPEN&&t.getOp()!=Trap.Message.Operation.END&&this.getState()!=Trap.Endpoint.State.SLEEPING)throw"Tried to send to non-open Trap session";var e=this.getChannel(t.getChannel());e.send(t),this.kickSendingThread()},Trap.Endpoint.prototype._sendFun=function(){try{for(;;){var t=null;if(null!=this.messageQueue.peek()){try{t=this.availableTransports.get(0)}catch(e){}if(null!=t){for(;t.isAvailable();)try{var r=this.messageQueue.peek();if(null==r||"undefined"==typeof r)break;this.logger.debug("Attempting to send message with op {}",r.getOp()),t.send(r,!0),this.messageQueue.pop()}catch(n){this.logger.debug(n),t.isAvailable()&&(this.logger.warn("Forcibly removing transport {} from available due to infinite loop protection. This code should not occur with a well-behaved transport.",t.getTransportName()),this.logger.warn("Caused by {}",n),t.forceError())}t.isAvailable()&&t.flushTransport()}}if(null==this.messageQueue.peek()||null==t)return void(this.sending=!1)}}catch(e){this.logger.error(e)}finally{this.messageQueue.rewind()}},Trap.Endpoint.prototype.kickSendingThread=function(){if(!this.sending){this.sending=!0;var t=this;setTimeout(function(){t._sendFun()},10)}},Trap.Endpoint.prototype.ttStateChanged=function(t,e,r){if(t==Trap.Transport.State.AVAILABLE)return this.addTransportToAvailable(r),void this.kickSendingThread();if(this.availableTransports.remove(r),!(t!=Trap.Transport.State.DISCONNECTED&&t!=Trap.Transport.State.ERROR||this.getState()!=Trap.Endpoint.State.CLOSED&&this.getState()!=Trap.Endpoint.State.CLOSING||this.getState()!=Trap.Endpoint.State.CLOSING)){for(var n=0;n<this.transports.size();n++){var a=this.transports.get(n);if(a.getState()!=Trap.Transport.State.ERROR&&a.getState()!=Trap.Transport.State.DISCONNECTED)return}this.setState(Trap.Endpoint.State.CLOSED)}},Trap.Endpoint.prototype.reconnect=function(t,e){},Trap.Endpoint.prototype.onmessage=function(t){},Trap.Endpoint.prototype.onstatechange=function(t){},Trap.Endpoint.prototype.onfailedsending=function(t){},Trap.Endpoint.prototype.createMessage=function(){return(new Trap.Message).setTransportId(this.trapID).setFormat(this.trapFormat)},Trap.Endpoint.prototype.addTransportToAvailable=function(t){for(var e=!1,r=0;r<this.availableTransports.size();r++){var n=this.availableTransports.get(r);if(n.getTransportPriority()>t.getTransportPriority()){this.availableTransports.add(r,t),e=!0;break}if(n==t)return}if(e||this.availableTransports.addLast(t),this.availableTransports.size()>this.maxActiveTransports){var t=this.availableTransports.getLast();this.logger.debug("Disconnecting transport [{}] as the max active transports were exceeded. ({} active, {} max)",t.getTransportName(),this.availableTransports.size(),this._maxActiveTransports),t.disconnect()}},Trap.Endpoint.prototype.ttMessageReceived=function(t,e){this.logger.debug("Received message with op {}",t.getOp()),this.async&&0!=t.getMessageId()?this.getChannel(t.getChannel()).receiveMessage(t,e):this.executeMessageReceived(t,e)},Trap.Endpoint.prototype.executeMessageReceived=function(t,e){switch(t.getOp()){case 1:this.onOpen(t,e);break;case 2:this.onOpened(t,e);break;case 3:this.onClose(t,e);break;case 4:this.onEnd(t,e);break;case 5:this.onChallenge(t,e);break;case 6:this.onError(t,e);break;case 8:this.onMessage(t,e);break;case 16:this.onOK(t,e);break;case 17:this.onPing(t,e);break;case 18:this.onPong(t,e);break;case 19:this.onTransport(t,e);break;default:return}},Trap.Endpoint.prototype.onTransport=function(t,e){},Trap.Endpoint.prototype.onPong=function(t,e){},Trap.Endpoint.prototype.onPing=function(t,e){},Trap.Endpoint.prototype.onOK=function(t,e){},Trap.Endpoint.prototype.onMessage=function(t,e){this._dispatchMessageEvent(t)},Trap._GetterMessageEvent=function(t){this._orig=t,this.type="message"},Trap._compat.__defineGetter(Trap._GetterMessageEvent.prototype,"message",function(){
return this._orig.data}),Trap._compat.__defineGetter(Trap._GetterMessageEvent.prototype,"data",function(){return this._orig.data}),Trap._compat.__defineGetter(Trap._GetterMessageEvent.prototype,"string",function(){return this._orig.string}),Trap._compat.__defineGetter(Trap._GetterMessageEvent.prototype,"channel",function(){return this._orig.channel}),Trap._compat.__defineGetter(Trap._GetterMessageEvent.prototype,"dataAsString",function(){return this._orig.string}),Trap._compat.__defineGetter(Trap._GetterMessageEvent.prototype,"object",function(){return JSON.parse(this._orig.string)}),Trap._compat.__defineGetter(Trap._GetterMessageEvent.prototype,"buffer",function(){return this._orig.message.data.buffer.slice(message.data.byteOffset,message.data.byteOffset+message.data.byteLength)}),Trap.Endpoint.prototype.onError=function(t,e){this.setState(Trap.Endpoint.State.ERROR)},Trap.Endpoint.prototype.onChallenge=function(t,e){},Trap.Endpoint.prototype.onEnd=function(t,e){if(this.getState()==Trap.Endpoint.State.CLOSING){for(var r=0;r<this.transports.size();r++)this.transports.get(r).disconnect();this.setState(Trap.Endpoint.State.CLOSED)}else{this.setState(Trap.Endpoint.State.CLOSING);try{this.sendMessage(this.createMessage().setOp(Trap.Message.Operation.END))}catch(n){this.logger.warn(n);for(var r=0;r<this.transports.size();r++)this.transports.get(r).disconnect()}}},Trap.Endpoint.prototype.onClose=function(t,e){},Trap.Endpoint.prototype.onOpened=function(t,e){this.getState()!=Trap.Endpoint.State.CLOSED&&this.getState()!=Trap.Endpoint.State.CLOSING&&this.getState()!=Trap.Endpoint.State.ERROR&&(0==this.trapID&&this.setTrapID(t.getTransportId()),this.setState(Trap.Endpoint.State.OPEN))},Trap.Endpoint.prototype.setState=function(t){if(t!=this._state){var e=this._state;if(this._state=t,this.logger.debug("TrapEndpoint changing state from {} to {}.",e,t),this._dispatchEvent({type:"statechange",newState:t,oldState:e}),t==Trap.Endpoint.State.OPEN&&this._dispatchEvent({type:"open"}),t==Trap.Endpoint.State.CLOSED&&this._dispatchEvent({type:"close"}),t==Trap.Endpoint.State.SLEEPING&&this._dispatchEvent({type:"sleep"}),t==Trap.Endpoint.State.SLEEPING&&this._dispatchEvent({type:"sleeping"}),t==Trap.Endpoint.State.OPENING&&this._dispatchEvent({type:"opening"}),t==Trap.Endpoint.State.CLOSING&&this._dispatchEvent({type:"closing"}),t==Trap.Endpoint.State.ERROR){this._dispatchEvent({type:"error"});for(var r=0;r<this.transports.size();r++)this.transports.get(r).disconnect()}(t==Trap.Endpoint.State.CLOSED||t==Trap.Endpoint.State.CLOSING||t==Trap.Endpoint.State.ERROR)&&this.keepaliveTask&&clearTimeout(this.keepaliveTask)}},Trap.Endpoint.prototype.onOpen=function(t,e){if(console.log("Endpoint ONOPEN"),this.getState()==Trap.Endpoint.State.CLOSED||this.getState()==Trap.Endpoint.State.CLOSING||this.getState()==Trap.Endpoint.State.ERROR){this.logger.debug("Connection Error: Received OPEN message on {}. Returning with END",this),e.sendTransportSpecific(this.createMessage().setOp(Trap.Message.Operation.END));var r=this;return void setTimeout(function(){e.getState()!=TrapTransportState.DISCONNECTED&&e.getState()!=TrapTransportState.ERROR&&(r.logger.debug("Disconnect Error: {} failed to disconnect, despite ending the session on {}",e,Tmt),e.forceError())},5e3)}try{e.sendTransportSpecific(this.createOnOpenedMessage(t),!1),this.setState(Trap.Endpoint.State.OPEN)}catch(n){this.logger.warn(n)}},Trap.Endpoint.prototype.createOnOpenedMessage=function(t){return this.createMessage().setOp(Trap.Message.Operation.OPENED)},Trap.Endpoint.prototype.ttMessagesFailedSending=function(t,e){for(var r=0;r<t.length;r++){var n=t[r];this.getChannel(n.getChannel).addFailedMessage()}for(var r=0;r<this.channels.length;r++)null!=this.channels[r]&&this.channels[r].rebuildMessageQueue();this.kickSendingThread()},Trap.Endpoint.prototype.lastAlive=function(){for(var t=0;t<this.transports.size();t++){var e=this.transports.get(t),r=e.lastAlive;this._lastAlive<r&&(this._lastAlive=r)}return this._lastAlive},Trap.Endpoint.prototype.isAlive=function(t,e,r,n,a){this.lastAlive();var i=(new Date).valueOf()-t;if(this._lastAlive>i)return void a(!0);if(!e)return void a(!1);var s=0,o=function(){},p=this;(o=function(i){if(i)return void a(!0);if(s<p.availableTransports.size())p.availableTransports.get(s).isAlive(t,e,n,o),s++;else{r||a(!1);try{p.setState(Trap.Endpoint.State.SLEEPING),p.reconnect(n,function(){a(p.getState()==Trap.Endpoint.State.OPEN)})}catch(h){p.logger.error("Setting TrapEndpoint to state ERROR because reconnect failed. We don't know currently how to recover from this state, so the connection is dropped"),p.setState(Trap.Endpoint.State.ERROR)}a(!1)}})(!1)},Trap.Endpoint.prototype.getKeepaliveInterval=function(){return this.keepaliveInterval},Trap.Endpoint.prototype.setKeepaliveInterval=function(t){this.keepaliveInterval=t;for(var e=0;e<this.transports.size();e++)this.transports.get(e).setKeepaliveInterval(t);var r=this.keepaliveInterval;if(r!=Trap.Keepalive.Policy.DEFAULT&&r!=Trap.Keepalive.Policy.DISABLED){null!=this.keepaliveTask&&clearTimeout(this.keepaliveTask);var n=this;this.keepaliveTask=setTimeout(function(){n._keepaliveFun()},1e3*r)}},Trap.Endpoint.prototype._keepaliveFun=function(){if(this.getState()!=Trap.Endpoint.State.CLOSING&&this.getState()!=Trap.Endpoint.State.CLOSED&&this.getState()!=Trap.Endpoint.State.ERROR&&this.getKeepaliveInterval()!=Trap.Keepalive.Policy.DISABLED&&this.getKeepaliveInterval()!=Trap.Keepalive.Policy.DEFAULT){for(var t=(new Date).valueOf()-1e3*this.keepaliveInterval-this.keepaliveExpiry,e=0;e<this.transports.size();e++){var r=this.transports.get(e);if(r.isConnected()&&r.lastAlive<t){this.logger.debug("Transport {} is not compliant with the keepalive timers. Last alive reported was {}, but expected {}",r.getTransportName(),r.lastAlive,t);try{var n=this;r.isAlive(this.keepaliveExpiry,!0,this.keepaliveExpiry,function(t){t||(n.logger.info("Disconnecting transport {} because it had timed out while not performing its own checks",r.getTransportName()),r.disconnect())})}catch(a){this.logger.error("Exception while checking non-conforming transport",a)}}}var i=this.keepaliveInterval;if(i!=Trap.Keepalive.Policy.DEFAULT&&i!=Trap.Keepalive.Policy.DISABLED){var n=this;this.keepaliveTask=setTimeout(function(){n._keepaliveFun()},1e3*i)}}},Trap.Endpoint.prototype.setKeepaliveExpiry=function(t){this.keepaliveExpiry=t;for(var e=0;e<this.transports.size();e++)this.transports.get(e).setKeepaliveExpiry(t)},Trap.Endpoint.prototype.getChannel=function(t){var e=this.channels[t];if(null==e){e=new Trap.Channel(this,t);var r=this.getMaxChunkSize();r=Math.min(r,e.getChunkSize()),0>=r&&(r=Number.MAX_VALUE),e.setChunkSize(r),this.channels[t]=e,this.messageQueue.rebuild(this.channels)}return e},Trap.Endpoint.prototype.getMaxChunkSize=function(){return this.config.getIntOption("trap."+Trap.Constants.OPTION_MAX_CHUNK_SIZE,65536)},Trap.Endpoint.prototype.ttMessageSent=function(t,e,r){this.getChannel(t.getChannel()).messageSent(t)},Trap.Message=function(t){this._data=[],this._authData=null,this._transportId=0,this._format=Trap.Message.Format.SEVEN_BIT_SAFE,this._op=Trap.Message.Operation.OK,this._compressed=!1,this._channel=0,this._messageId=0,"undefined"!=typeof t&&this.deserialize(t,0,t.length)},Trap._compat.__defineGetterSetter(Trap.Message.prototype,"messageId"),Trap._compat.__defineGetter(Trap.Message.prototype,"channel",function(){return this.format==Trap.Message.Format.REGULAR?this._channel:0}),Trap._compat.__defineSetter(Trap.Message.prototype,"channel"),Trap._compat.__defineGetterSetter(Trap.Message.prototype,"compressed"),Trap._compat.__defineGetter(Trap.Message.prototype,"data",function(){return this._data}),Trap._compat.__defineGetter(Trap.Message.prototype,"dataAsString",function(){return String.fromUTF8ByteArray(this._data)}),Trap._compat.__defineGetter(Trap.Message.prototype,"string",function(){return String.fromUTF8ByteArray(this._data)}),Trap._compat.__defineGetter(Trap.Message.prototype,"authData",function(){return this._authData}),Trap._compat.__defineGetter(Trap.Message.prototype,"transportId",function(){return this._transportId}),Trap._compat.__defineGetter(Trap.Message.prototype,"format",function(){return this._format}),Trap._compat.__defineGetter(Trap.Message.prototype,"op",function(){return this._op}),Trap._compat.__defineGetter(Trap.Message.prototype,"channelID",function(){return this._channelID}),Trap._compat.__defineSetter(Trap.Message.prototype,"data",function(t){if("string"==typeof t)this._data=t.toUTF8ByteArray();else if("number"==typeof t.length||"number"==typeof t.byteLength)this._data=t;else if("number"==typeof t)this._data=[t];else{if("object"!=typeof t)throw"Invalid data supplied; not an array, not a string, not a number";this._data=JSON.stringify(t).toUTF8ByteArray()}return this}),Trap._compat.__defineSetter(Trap.Message.prototype,"authData",function(t){if(t&&t.length>65535)throw"authData cannot be more than 65535 bytes";if(t&&t.length!=t.toUTF8ByteArray().length)throw"authData was not a US-ASCII string";return this._authData=t,this}),Trap._compat.__defineSetter(Trap.Message.prototype,"transportId",function(t){if(t>268435455)throw"Transport ID ["+t+"] too large to be transported through Trap";if(0>t)throw"Transport IDs must be unsigned integers";return this._transportId=t,this}),Trap._compat.__defineSetter(Trap.Message.prototype,"format",function(t){return this._format=t,this}),Trap._compat.__defineSetter(Trap.Message.prototype,"op",function(t){return this._op=t,this}),Trap._compat.__defineSetter(Trap.Message.prototype,"channelID",function(t){return this._channelID=t,this}),Trap.Message.Operation={OPEN:1,OPENED:2,CLOSE:3,END:4,CHALLENGE:5,ERROR:6,MESSAGE:8,ACK:9,FRAGMENT_START:10,FRAGMENT_END:11,OK:16,PING:17,PONG:18,TRANSPORT:19,name:function(t){switch(t){case 1:return"OPEN";case 2:return"OPENED";case 3:return"CLOSE";case 4:return"END";case 5:return"CHALLENGE";case 6:return"ERROR";case 8:return"MESSAGE";case 9:return"ACK";case 10:return"FRAGMENT_START";case 11:return"FRAGMENT_END";case 16:return"OK";case 17:return"PING";case 18:return"PONG";case 19:return"TRANSPORT";default:return"Unknown op type: "+t}},getType:function(t){return t}},Trap.Message.Format={REGULAR:"Trap.Message.Format.Regular",SEVEN_BIT_SAFE:"Trap.Message.Format.7bit",DEFAULT:"Trap.Message.Format.Regular"},Trap.Constants.MESSAGE_FORMAT_DEFAULT=Trap.Message.Format.DEFAULT,Trap.Message.prototype.getBits=function(t,e,r){var n=Math.pow(2,r-e+1)-1;n<<=32-r;var a=(t&n)>>32-r;return a},Trap.Message.prototype.writeInt7=function(t,e){e.write(this.getBits(t,5,11)),e.write(this.getBits(t,12,18)),e.write(this.getBits(t,19,25)),e.write(this.getBits(t,26,32))},Trap.Message.prototype.writeInt8=function(t,e){e.write(this.getBits(t,1,8)),e.write(this.getBits(t,9,16)),e.write(this.getBits(t,17,24)),e.write(this.getBits(t,25,32))},Trap.Message.prototype.serialize=function(t){var e=t?new Trap.ByteArrayOutputStream:new Trap.ByteStringOutputStream;return this.format==Trap.Message.Format.SEVEN_BIT_SAFE?this.serialize7bit(e,t):this.serialize8bit(e,t),t?e.toArray():e.toString()},Trap.Message.prototype.getCompressedData=function(){return this.compressed?(this._compressedData||(this._compressedData=new Zlib.Deflate(this.data).compress()),this._compressedData):this.data},Trap.Message.prototype.serialize8bit=function(t,e){if(this.data.length>=Math.pow(2,32))throw"Asked to serialize more than 2^32 bytes data into a 8-bit Trap message";var r=0;r|=128|this.op,t.write(r);var n=null!=this.authData?this.authData.length:0,a=this.getCompressedData();r=this.channel,this.compressed&&e&&(r|=128),t.write(r),t.write(this.getBits(n,17,24)),t.write(this.getBits(n,25,32)),this.writeInt8(this.getMessageId(),t,!0),this.writeInt8(this.transportId,t,!0),this.writeInt8(a.byteLength?a.byteLength:a.length,t,!1),n>0&&t.write(this.authData),t.write(e?a:String.fromUTF8ByteArray(a))},Trap.Message.prototype.serialize7bit=function(t,e){if(this.data.length>=Math.pow(2,28))throw"Asked to serialize more than 2^28 bytes data into a 7-bit Trap message";var r=0;r|=this.op,t.write(r);var n=null!=this.authData?this.authData.length:0;t.write(this.getBits(n,17,18)),t.write(this.getBits(n,19,25)),t.write(this.getBits(n,26,32)),this.writeInt7(this.getMessageId(),t,!0),this.writeInt7(this.transportId,t,!0),this.writeInt7(this.data.byteLength?this.data.byteLength:this.data.length,t,!1),n>0&&t.write(this.authData),t.write(e?this.data:String.fromUTF8ByteArray(this.data))},Trap.Message.prototype.deserialize=function(t,e,r){if(e+r>t.length)throw"Offset and length specified exceed the buffer";if(16>r)return-1;var n,a;0!=(128&t[e+0])?(this.format=Trap.Message.Format.REGULAR,this.op=Trap.Message.Operation.getType(63&t[e+0]),this.compressed=0!=(128&t[e+1]),this.channel=63&t[e+1],n=t[e+2]<<8|t[e+3],this.messageId=t[e+4]<<24|t[e+5]<<16|t[e+6]<<8|t[e+7],this.transportId=t[e+8]<<24|t[e+9]<<16|t[e+10]<<8|t[e+11],a=t[e+12]<<24|t[e+13]<<16|t[e+14]<<8|t[e+15]):(this.format=Trap.Message.Format.SEVEN_BIT_SAFE,this.op=Trap.Message.Operation.getType(63&t[e+0]),n=(3&t[e+1])<<14|(127&t[e+2])<<7|(127&t[e+3])<<0,this.messageId=(127&t[e+4])<<21|(127&t[e+5])<<14|(127&t[e+6])<<7|(127&t[e+7])<<0,this.transportId=(127&t[e+8])<<21|(127&t[e+9])<<14|(127&t[e+10])<<7|(127&t[e+11])<<0,a=(127&t[e+12])<<21|(127&t[e+13])<<14|(127&t[e+14])<<7|(127&t[e+15])<<0,this.compressed=!1,this.channel=0);var i=16+n+a;if(i>r)return-1;var s=e+16;return n>0?(this.authData=Trap.subarray(t,s,s+n),this.authData=String.utf8Decode(this.authData),s+=n):this.authData=null,this.data=Trap.subarray(t,s,s+a),this.compressed&&(this.data=new Zlib.Inflate(this.data).decompress()),i},Trap.Message.prototype.length=function(){var t=16;return null!=this.authData&&(t+=this.authData.toUTF8ByteArray().length),null!=this.getCompressedData()&&(t+=this.getCompressedData().byteLength||this.getCompressedData().length),t},Trap.ClientEndpoint=function(t,e){if("object"==typeof t?(this.useBinary="boolean"==typeof t.useBinary?t.useBinary:!1,this.autoConfigure="boolean"==typeof t.autoConfigure?t.autoConfigure:!0,t=t.config):(this.autoConfigure="boolean"==typeof e?e:!0,this.useBinary="undefined"!=typeof Trap.useBinary?Trap.useBinary:Trap.supportsBinary),this.useBinary&&!Trap.supportsBinary)throw"Cannot enable binary mode; it is unsupported on this client. Either no transport supported it, or Uint8Array is not present.";this.cTransport,this.transportsToConnect=new Trap.Set,this.failedTransports=new Trap.List,this.activeTransports=new Trap.List,this.recovering=!1,Trap.Endpoint.prototype.constructor.call(this),this._maxActiveTransports=1,this.trapID=0;for(var r in Trap.Transports){var n=Trap.Transports[r];if(n.prototype&&"function"==typeof n.prototype.setTransportPriority){var a=new n;if(this.logger.trace("Initialising new Transport for client: {}",a.getTransportName()),!a.canConnect()){this.logger.trace("Skipping it; it cannot connect");continue}if(this.useBinary&&!a.supportsBinary){this.logger.info("Skipping it; Trap Binary Mode requested, but transport only supports text");continue}a.useBinary=this.useBinary,this.addTransport(a)}}if(0==this.transports.size())throw"No transports could be initialised; either no transports could connect, or transports did not support binary mode (if requested)";if(null!=t&&t.trim().length>0)if(t.startsWith("ws://")||t.startsWith("wss://"))t="trap.transport.websocket.wsuri = "+t;else if(t.startsWith("socket://"));else if(t.startsWith("http://")||t.startsWith("https://"))t="trap.transport.http.url = "+t;else if(!t.startsWith("trap"))throw"Unknown configuration; invalid format or garbage characters entered";this.configure(t),this.transportRecoveryTimeout=9e5;var i=this;setTimeout(function(){i.logger.trace("##### CLIENT OPEN ####"),i.logger.trace("Config is: {}",i.config.toString());for(var t=0;t<i.transports.size();t++){var e=i.transports.get(t);i.logger.trace("Transport [{}] is enabled: {}",e.getTransportName(),e.isEnabled())}i.setState(Trap.Endpoint.State.OPENING),i.doOpen();var r=function(){i.failedTransports.clear();for(var t=0;t<i.transports.size();t++){if(i.getState()==Trap.Endpoint.State.CLOSING||i.getState()==Trap.Endpoint.State.CLOSED||i.getState()==Trap.Endpoint.State.CLOSED)return;for(var e=i.transports.get(t),n=!1,a=0;a<i.activeTransports.size();a++)if(i.activeTransports.get(a)==e){n=!0;break}n||i.transportsToConnect.add(e)}i.recovering||i.kickRecoveryThread(),setTimeout(r,i.transportRecoveryTimeout)};setTimeout(r,i.transportRecoveryTimeout)},0)},Trap.ClientEndpoint.prototype=new Trap.Endpoint,Trap.ClientEndpoint.prototype.constructor=Trap.ClientEndpoint,Trap.ClientEndpoint.prototype.parseConfiguration=function(t){return new Trap.CustomConfiguration(t)},Trap.ClientEndpoint.prototype.open=function(){},Trap.ClientEndpoint.prototype.doOpen=function(){if(0==this.transports.size())throw this.setState(Trap.Endpoint.State.ERROR),"No transports available";this.failedTransports.clear(),this.activeTransports.clear(),this.availableTransports.clear(),this.transportsToConnect.clear(),this.transportsToConnect.addAll(this.transports),this.kickRecoveryThread()},Trap.ClientEndpoint.prototype.ttStateChanged=function(t,e,r){if(this.logger.debug("Transport {} changed state to {}",r.getTransportName(),t),Trap.Endpoint.prototype.ttStateChanged.call(this,t,e,r),this.getState()!=Trap.Endpoint.State.CLOSED&&this.getState()!=Trap.Endpoint.State.CLOSING&&this.getState()!=Trap.Endpoint.State.ERROR){if(e==Trap.Transport.State.DISCONNECTING)return this.activeTransports.remove(r),void this.availableTransports.remove(r);if(t==Trap.Transport.State.DISCONNECTED||t==Trap.Transport.State.ERROR)if(this.activeTransports.remove(r),e==Trap.Transport.State.AVAILABLE||e==Trap.Transport.State.UNAVAILABLE||e==Trap.Transport.State.CONNECTED){if(0!=this.activeTransports.size())return this.transportsToConnect.add(r),void this.kickRecoveryThread();if(this.getState()==Trap.Endpoint.State.OPENING)return this.failedTransports.add(r),void this.kickRecoveryThread();var n=1e3;if(this.getState()==Trap.Endpoint.State.OPEN&&(this.setState(Trap.Endpoint.State.SLEEPING),this.canReconnectUntil=(new Date).valueOf()+this.reconnectTimeout,n=0),this.getState()!=Trap.Endpoint.State.SLEEPING)return;var a=this;(new Date).valueOf()<this.canReconnectUntil&&setTimeout(function(){try{a.doOpen()}catch(t){return void a.logger.error("Error while reconnecting after all transports failed",t)}},n)}else e==Trap.Transport.State.CONNECTING&&this.cycleTransport(r,"connectivity failure");t==Trap.Transport.State.CONNECTED&&(e==Trap.Transport.State.CONNECTING?this.sendOpen(r):this.logger.error("Reached Trap.Transport.State.CONNECTED from a non-CONNECTING state. We don't believe in this."))}},Trap.ClientEndpoint.prototype.ttMessageReceived=function(t,e){if(e==this.cTransport){if(t.getOp()!=Trap.Message.Operation.OPENED)return void this.cycleTransport(e,"illegal open reply message op");this.cTransport=null,this.autoConfigure&&t.getData().length>0&&this.config.setStaticConfiguration(t.getData())}Trap.Endpoint.prototype.ttMessageReceived.call(this,t,e)},Trap.ClientEndpoint.prototype.sendOpen=function(t){var e=this.createMessage().setOp(Trap.Message.Operation.OPEN),r=new Trap.Configuration;if(this.autoConfigure)try{var n=this.getConfiguration().toString(),a=Trap.MD5(n);r.setOption(Trap.Configuration.CONFIG_HASH_PROPERTY,a)}catch(i){this.logger.warn("Could not compute client configuration hash",i)}null==this.connectionToken&&(this.connectionToken=Trap._uuid()),r.setOption("trap.connection-token",this.connectionToken),r.setOption(Trap.Constants.OPTION_MAX_CHUNK_SIZE,"16384"),r.setOption(Trap.Constants.OPTION_ENABLE_COMPRESSION,"true"),e.setData(r.toString());try{t.send(e,!1)}catch(i){this.cycleTransport(t,"open message send failure")}},Trap.ClientEndpoint.prototype.cycleTransport=function(t,e){if(this.logger.debug("Cycling transports due to {} {}...",t.getTransportName(),e),t.onmessage=function(){},t.onstatechange=function(){},t.onfailedsending=function(){},t.onmessagesent=function(){},t.disconnect(),this.activeTransports.remove(t),this.failedTransports.add(t),0==this.transportsToConnect.size()){if(this.activeTransports.size()>0)return;if(this.getState()==Trap.Endpoint.State.OPENING)return this.logger.error("Could not open a connection on any transport..."),void this.setState(Trap.Endpoint.State.ERROR);var r=this;if(this._cycling)return;this._cycling=setTimeout(function(){try{this._cycling=null,r.doOpen()}catch(t){r.logger.warn(t)}},1e3)}else this.kickRecoveryThread()},Trap.ClientEndpoint.prototype.kickRecoveryThread=function(){if(!this.recovering){var t=this;this.recovering=setTimeout(function(){if(t.state!=Trap.Endpoint.State.CLOSED&&t.state!=Trap.Endpoint.State.CLOSING&&t.state!=Trap.Endpoint.State.ERROR){try{for(;;){t.transportsToConnect.sort(function(t,e){return t.getTransportPriority()-e.getTransportPriority()});var e=null;if(t.transportsToConnect.size()>0)try{if(e=t.transportsToConnect.remove(0),null!=e){var r=e;if(t.logger.trace("Now trying to connect transport {}",r.getTransportName()),!r.canConnect()){t.logger.trace("Skipping: Transport cannot connect");continue}if(!r.isEnabled()){t.logger.trace("Skipping: Transport is disabled");continue}for(var n=!1,a=0;a<t.availableTransports.size();a++)t.availableTransports.get(a).getTransportPriority()<r.getTransportPriority()&&(n=!0);if(n){t.transportsToConnect.add(0,r),t.logger.trace("Skipping: Transport is downprioritised (we'll try a higher prio transport first)");break}r.init(),r.onmessage=function(e){t.ttMessageReceived(e.message,e.target,null)},r.onstatechange=function(e){t.ttStateChanged(e.newState,e.oldState,e.target,null)},r.onfailedsending=function(e){t.ttMessagesFailedSending(e.messages,e.target,null)},r.onmessagesent=function(e){t.ttMessageSent(e.message,e.target,null)},r.setAuthentication(t.authentication),r.setTrapID(t.trapID),r.setConfiguration(t.config),r.setFormat(t.getFormat()),t.activeTransports.add(r),r.connect()}}catch(i){e&&(t.failedTransports.add(e),t.activeTransports.remove(e))}if(0==t.transportsToConnect.size()||null==e)return void(t.recovering=null)}}catch(r){t.logger.warn(r),t.recovering=null}t.recovering=null}},0)}},Trap.ClientEndpoint.prototype.reconnect=function(t){for(var e=0;e<this.transports.size();e++)this.transports.get(e).disconnect();this.availableTransports=new Trap.List,this.doOpen();var r=this;t>0&&(this.reconnectFunTimer=setTimeout(function(){r.getState()!=Trap.Endpoint.State.OPEN&&r.setState(Trap.Endpoint.State.CLOSED),r.reconnectFunTimer=null},t))},Trap.ClientEndpoint.prototype.onOpened=function(t,e){var r=Trap.Endpoint.prototype.onOpened.call(this,t,e);if(0!=this.trapID&&this.autoConfigure&&t.string&&t.string.length>0){this.logger.debug("Received new configuration from server..."),this.logger.debug("Configuration was [{}]",t.string),this.configure(t.string),this.failedTransports.clear();for(var n=0;n<this.transports.size();n++){for(var a=this.transports.get(n),i=!1,s=0;s<this.activeTransports.size();s++)if(this.activeTransports.get(s)==a){i=!0;break}i||this.transportsToConnect.add(a)}this.kickRecoveryThread()}return r},Trap.Transport=function(){},Trap.Transport.Options={Enabled:"enabled",ENABLED:"enabled",Priority:"priority"},Trap.Transport.State={DISCONNECTED:"trap.transport.state.DISCONNECTED",CONNECTING:"trap.transport.state.CONNECTING",CONNECTED:"trap.transport.state.CONNECTED",AVAILABLE:"trap.transport.state.AVAILABLE",UNAVAILABLE:"trap.transport.state.UNAVAILABLE",DISCONNECTING:"trap.transport.state.DISCONNECTING",ERROR:"trap.transport.state.ERROR"},Trap.Transport.prototype.isEnabled=function(){},Trap.Transport.prototype.enable=function(){},Trap.Transport.prototype.disable=function(){},Trap.Transport.prototype.isConnected=function(){},Trap.Transport.prototype.connect=function(){},Trap.Transport.prototype.disconnect=function(){},Trap.Transport.prototype.getTransportPriority=function(){},Trap.Transport.prototype.setTransportPriority=function(t){},Trap.Transport.prototype.getTransportName=function(){},Trap.Transport.prototype.configure=function(t,e){},Trap.Transport.prototype.configure=function(t,e){},Trap.Transport.prototype.setConfiguration=function(t){},Trap.Transport.prototype.getConfiguration=function(){},Trap.Transport.prototype.setAuthentication=function(t){},Trap.Transport.prototype.canConnect=function(){},Trap.Transport.prototype.canListen=function(){},Trap.Transport.prototype.send=function(t,e){},Trap.Transport.prototype.isAvailable=function(){},Trap.Transport.prototype.setTrapID=function(t){},Trap.Transport.prototype.getTrapID=function(){},Trap.Transport.prototype.getState=function(){},Trap.Transport.prototype.lastAlive=function(){},Trap.Transport.prototype.isAlive=function(t,e,r,n){},Trap.Transport.prototype.onmessage=function(t){},Trap.Transport.prototype.onstatechange=function(t){},Trap.Transport.prototype.onfailedsending=function(t){},Trap.AbstractTransport=function(){Trap.EventObject.call(this),this._headersMap=new Trap.Map,this._configuration=new Trap.Configuration,this._prefix="trap.transport."+this.getTransportName().toLowerCase(),this._authentication=new Trap.Authentication,this._delegate=null,this._delegateContext=null,this._availableKeys=[],this._contextKeys=[],this._contextMap=new Trap.Map,this._transportPriority=0,this._lastAckTimestamp=0,this._acks=null,this._ackTask=0,this._format=Trap.Constants.MESSAGE_FORMAT_DEFAULT,this.logger=Trap.Logger.getLogger(this.getTransportName()),this.fillAuthenticationKeys(this.availableKeys),Trap._compat.__defineSetter(this,"transportPriority",function(t){this._transportPriority=t}),Trap._compat.__defineGetter(this,"transportPriority",function(){return this._transportPriority}),Trap._compat.__defineSetter(this,"configuration",function(t){this._configuration=t,this.updateConfig()}),Trap._compat.__defineGetter(this,"configuration",function(){return this._configuration.toString()}),Trap._compat.__defineGetter(this,"state",function(){return this._state}),Trap._compat.__defineSetter(this,"trapID",function(t){this._trapID=t}),Trap._compat.__defineGetter(this,"trapID",function(){return this._trapID}),Trap._compat.__defineGetter(this,"enabled",function(){return this._enabled}),Trap._compat.__defineSetter(this,"enabled",function(t){if("boolean"!=typeof t)throw"Cannot set to a non-boolean value. Please set enabled to true or false";t?this.enable():this.disable()}),Trap._compat.__defineGetter(this,"keepaliveInterval",function(){return this._keepalivePredictor.getKeepaliveInterval()}),Trap._compat.__defineSetter(this,"keepaliveInterval",function(t){this._keepalivePredictor.setKeepaliveInterval(t),(this.state==Trap.Transport.State.CONNECTED||this.state==Trap.Transport.State.AVAILABLE)&&this._keepalivePredictor.start()}),Trap._compat.__defineGetterSetter(this,"keepalivePredictor","_keepalivePredictor"),Trap._compat.__defineGetterSetter(this,"keepaliveExpiry",null,function(){return this._keepalivePredictor.getKeepaliveExpiry()},function(t){this._keepalivePredictor.setKeepaliveExpiry(t)}),Trap._compat.__defineGetter(this,"format",function(){return this._format}),Trap._compat.__defineSetter(this,"format",function(t){this._format=t}),Trap.AbstractTransport.prototype.init.call(this)},Trap.AbstractTransport.prototype=new Trap.EventObject,Trap.AbstractTransport.prototype.constructor=Trap.AbstractTransport,Trap.AbstractTransport.prototype.init=function(){this._enabled=Trap.Constants.TRANSPORT_ENABLED_DEFAULT,this._state=Trap.Transport.State.DISCONNECTED,this._trapID=0,this.lastAlive=0,this._livenessCheckData=null,this.connectTimeout=3e4,this._bos=this.useBinary?new Trap.ByteArrayOutputStream:new Trap.ByteStringOutputStream,this._keepalivePredictor&&this._keepalivePredictor.stop(),this._keepalivePredictor=new Trap.Keepalive.StaticPredictor,this._keepalivePredictor.setDelegate(this),this.messagesInTransit=new Trap.List,this.transportMessageBuffer=new Trap.List,this.connectionTimeoutTask&&clearTimeout(this.connectionTimeoutTask),this.connectionTimeoutTask=null,null!=this.disconnectExpiry&&clearTimeout(this.disconnectExpiry),this.disconnectExpiry=null},Trap.AbstractTransport.prototype.fillAuthenticationKeys=function(t){},Trap.AbstractTransport.prototype.updateContext=function(){},Trap.AbstractTransport.prototype.internalSend=function(t,e){},Trap.AbstractTransport.prototype.internalConnect=function(){},Trap.AbstractTransport.prototype.internalDisconnect=function(){},Trap.AbstractTransport.prototype.getTransportName=function(){return"abstract"},Trap.AbstractTransport.prototype.isEnabled=function(){return this._enabled},Trap.AbstractTransport.prototype.isConnected=function(){return this.getState()==Trap.Transport.State.CONNECTED||this.getState()==Trap.Transport.State.AVAILABLE},Trap.AbstractTransport.prototype.configure=function(t,e){t.startsWith(this._prefix)||(t=this._prefix+"."+t),this._configuration.setOption(t,e),this.updateConfig()},Trap.AbstractTransport.prototype.updateConfig=function(){var t=this.getOption(Trap.Transport.Options.Enabled);if(null!=t)try{this._enabled="true"==t}catch(e){this.logger.warn("Failed to parse transport {} enabled flag; {}",this.getTransportName(),e)}this.transportPriority=this._configuration.getIntOption(Trap.Transport.Options.Priority,this.transportPriority),this.keepaliveInterval=this._configuration.getIntOption("trap.keepalive.interval",this.keepaliveInterval),this.keepaliveExpiry=this._configuration.getIntOption("trap.keepalive.expiry",this.keepaliveExpiry)},Trap.AbstractTransport.prototype.canConnect=function(){return!1},Trap.AbstractTransport.prototype.canListen=function(){return!1},Trap.AbstractTransport.prototype.setTransportDelegate=function(t,e){this.delegate=t,this._delegateContext=e,this.onmessage=function(r){t.ttMessageReceived(r.message,this,e)},this.onmessagesent=function(r){t.ttMessageSent(r.message,this,e)},this.onstatechange=function(r){t.ttStateChanged(r.newState,r.oldState,this,e)},this.onfailedsending=function(r){t.ttMessagesFailedSending(r.messages,this,e)}},Trap.AbstractTransport.prototype.setAuthentication=function(t){this._authentication=t,this.contextKeys=t.getContextKeys(this.availableKeys),this.updateContext()},Trap.AbstractTransport.prototype.isAvailable=function(){return this.state==Trap.Transport.State.AVAILABLE},Trap.AbstractTransport.prototype.setState=function(t){if(t!=this._state){var e=this._state;this._state=t,null==this.delegate&&this.logger.trace("Transport {} changed state from {} to {}",this.getTransportName(),e,t);try{this._dispatchEvent({type:"statechange",newState:t,oldState:e})}catch(r){this.logger.error("Exception while dispatching statechange: {}",r)}if(t==Trap.Transport.State.AVAILABLE&&null!=this.connectionTimeoutTask&&(clearTimeout(this.connectionTimeoutTask),this.connectionTimeoutTask=null),t==Trap.Transport.State.CONNECTED&&this._keepalivePredictor.start(),(t==Trap.Transport.State.DISCONNECTED||t==Trap.Transport.State.DISCONNECTING||t==Trap.Transport.State.ERROR)&&(this._keepalivePredictor.stop(),null!=this.disconnectExpiry&&clearTimeout(this.disconnectExpiry),this.disconnectExpiry=null,this.messagesInTransit.size()>0&&this._dispatchEvent({type:"failedsending",data:this.messagesInTransit,messages:this.messagesInTransit})),t==Trap.Transport.State.AVAILABLE&&e==Trap.Transport.State.UNAVAILABLE){var n=this;setTimeout(function(){n.flushTransportMessages(!1)},5)}}},Trap.AbstractTransport.prototype.enable=function(){try{this.configure(Trap.Transport.Options.ENABLED,"true")}catch(t){this.logger.warn(t.getMessage(),t)}},Trap.AbstractTransport.prototype.disable=function(){try{this.configure(Trap.Transport.Options.ENABLED,"false")}catch(t){this.logger.warn(t)}this.disconnect()},Trap.AbstractTransport.prototype.connect=function(){if(!this.isEnabled())throw"Transport "+this.getTransportName()+" is unavailable...";if(!this.canConnect())throw"Transport "+this.getTransportName()+" cannot act as a client";if(this.getState()!=Trap.Transport.State.DISCONNECTED)throw"Cannot connect from state that is not DISCONNECTED";if(!this.isClientConfigured())return this.logger.debug("Configuration Error. {} not properly configured... Unless autoconfigure is enabled (and another transport succeeds) this transport will not be available.",this),
void this.setState(Trap.Transport.State.ERROR);var t=this;this.connectionTimeoutTask=setTimeout(function(){t.getState()==Trap.Transport.State.CONNECTING&&(t.logger.debug("Connection Error. {} failed to move to state OPEN after 15 seconds... purging it",t),t.setState(Trap.Transport.State.ERROR),t.internalDisconnect())},this.connectTimeout),this.setState(Trap.Transport.State.CONNECTING),this.internalConnect()},Trap.AbstractTransport.prototype.disconnect=function(){if(this.state!=Trap.Transport.State.DISCONNECTING&&this.state!=Trap.Transport.State.DISCONNECTED&&this.state!=Trap.Transport.State.ERROR){if(this.getState()==Trap.Transport.State.CONNECTING)return void this.internalDisconnect();this.setState(Trap.Transport.State.DISCONNECTING),this.internalSend(this.createMessage().setOp(Trap.Message.Operation.CLOSE),!1),this.keepalivePredictor.dataSent();var t=this;this.disconnectExpiry=setTimeout(function(){t.getState()!=Trap.Transport.State.DISCONNECTED&&t.getState==Trap.Transport.State.ERROR&&(t.internalDisconnect(),t.logger.debug("Disconnection Error. {} moving to state ERROR as failed to disconnect in time. Triggering state was {}",t,cs),t.setState(Trap.Transport.State.ERROR)),t.disconnectExpiry=null},5e3),this.internalDisconnect()}},Trap.AbstractTransport.prototype.send=function(t,e){if(this.state!=Trap.Transport.State.AVAILABLE&&this.state!=Trap.Transport.State.CONNECTED)throw{message:t,state:this.state};t.setAuthData(this._authentication.createAuthenticationResponse(null,this.headersMap,t.getData(),this.contextMap)),this.logger.isTraceEnabled()&&this.logger.trace("Sending {}/{} on transport {} for {}.",t.getOp(),t.getMessageId(),this,this.delegate),this.internalSend(t,e),0!=t.getMessageId()&&this.addTransitMessage(t),this._keepalivePredictor.dataSent()},Trap.AbstractTransport.prototype.sendTransportSpecific=function(t){t.setAuthData(this._authentication.createAuthenticationResponse(null,this.headersMap,t.getData(),this.contextMap)),this.transportMessageBuffer.add(t),this.flushTransportMessages(!1)},Trap.AbstractTransport.prototype.flushTransportMessages=function(t){for(;(this.getState()==Trap.Transport.State.AVAILABLE||this.getState()==Trap.Transport.State.CONNECTED||this.getState()==Trap.Transport.State.CONNECTING||this.getState()==Trap.Transport.State.DISCONNECTING)&&this.transportMessageBuffer.size()>0;){var e=null;try{e=this.transportMessageBuffer.remove(),this.logger.isTraceEnabled()&&this.logger.trace("Sending {}/{} on transport {} for {}.",e.getOp(),e.getMessageId(),this,this.delegate),this.internalSend(e,t?!0:this.transportMessageBuffer.size()>0),this._keepalivePredictor.dataSent()}catch(r){this.transportMessageBuffer.addFirst(e)}}this.flushTransport()},Trap.AbstractTransport.prototype.receive=function(t,e,r){try{this._bos.write(t,e,r);var n=this._bos.toArray(),a=0;do{var i=new Trap.Message,s=i.deserialize(n,a,n.length-a);if(-1==s)break;this.receiveMessage(i),a+=s}while(a<n.length);if(a>0){this._bos=this.useBinary?new Trap.ByteArrayOutputStream:new Trap.ByteStringOutputStream;try{this._bos.write(n,a,n.length-a)}catch(o){this.logger.warn(o)}}}catch(p){this.logger.warn(p);try{this.sendTransportSpecific(this.createMessage().setOp(Trap.Message.Operation.END))}catch(h){this.logger.warn(h)}this.disconnect()}},Trap.AbstractTransport.prototype.toString=function(){return this.getTransportName()+"/"+this.getTrapID()+"/"+this.getState()},Trap.AbstractTransport.prototype.receiveMessage=function(t){this.logger.isTraceEnabled()&&this.logger.trace("Received: {}/{} on {} for {}",t.getOp(),t.getMessageId(),this,this.delegate),this.lastAlive=(new Date).getTime(),this._keepalivePredictor.dataReceived();var e=!0;switch(t.getOp()){case 1:e=this.onOpen(t);break;case 2:e=this.onOpened(t);break;case 3:e=this.onClose(t);break;case 4:e=this.onEnd(t);break;case 5:e=this.onChallenge(t);break;case 6:e=this.onError(t);break;case 8:case Trap.Message.Operation.FRAGMENT_START:case Trap.Message.Operation.FRAGMENT_END:e=this.onMessage(t);break;case 9:e=!1,this.onAck(t);break;case 16:e=this.onOK(t);break;case 17:e=this.onPing(t);break;case 18:e=this.onPong(t);break;case 19:e=this.onTransport(t);break;default:return}e&&(this._dispatchEvent({type:"message",data:t,message:t}),this.acknowledgeTransitMessage(t))},Trap.AbstractTransport.prototype.onTransport=function(t){var e=this.checkAuthentication(t);return e},Trap.AbstractTransport.prototype.onPong=function(t){var e=this.checkAuthentication(t);if(e){var r=t.getDataAsString(),n=r[0],a=r.substring(7),i=parseInt(r.substring(1,7));isNaN(i)&&(i=30),"3"!=n?this._keepalivePredictor.keepaliveReceived(!1,n,i,a):this.livenessCheck&&this.livenessCheck(a)}return e},Trap.AbstractTransport.prototype.onPing=function(t){var e=this.checkAuthentication(t);if(e){if(this.getState()==Trap.Transport.State.DISCONNECTING||this.getState()==Trap.Transport.State.DISCONNECTED)return e;try{var r=t.string,n=r.substring(0,1),a=parseInt(r.substring(1,7)),i=r.substring(7);isNaN(a)&&(a=30),"3"!=n?this._keepalivePredictor.keepaliveReceived(!0,n,a,i):this.sendKeepalive(!1,n,a,i)}catch(s){this.logger.warn(s)}}return e},Trap.AbstractTransport.prototype.padTimer=function(t){for(;t.length<6;)t=t.startsWith("-")?"-0"+t.substring(1):"0"+t;return t},Trap.AbstractTransport.prototype.onOK=function(t){var e=this.checkAuthentication(t);return e},Trap.AbstractTransport.prototype.onMessage=function(t){var e=this.checkAuthentication(t);return e},Trap.AbstractTransport.prototype.onError=function(t){var e=this.checkAuthentication(t);return e},Trap.AbstractTransport.prototype.onChallenge=function(t){try{var e=new Trap.Message(t.getData()),r=this._authentication.createAuthenticationResponse(t.getAuthData(),this.headersMap,e.getData(),this.contextMap);e.setAuthData(r),this.sendTransportSpecific(e)}catch(n){this.logger.warn(n)}return!1},Trap.AbstractTransport.prototype.onEnd=function(t){var e=this.checkAuthentication(t);return e},Trap.AbstractTransport.prototype.onClose=function(t){var e=this.checkAuthentication(t);return e&&(this.disconnect(),this.internalDisconnect(),this.setState(Trap.Transport.State.DISCONNECTED)),!1},Trap.AbstractTransport.prototype.onOpened=function(t){var e=this.checkAuthentication(t);return e&&(this.getState()==Trap.Transport.State.UNAVAILABLE||this.getState()==Trap.Transport.State.CONNECTED?this.setState(Trap.Transport.State.AVAILABLE):this.logger.debug("Potential race: Transport received onOpen while not connecting")),e},Trap.AbstractTransport.prototype.onOpen=function(t){var e=this.checkAuthentication(t);return e&&(this.getState()==Trap.Transport.State.UNAVAILABLE||this.getState()==Trap.Transport.State.CONNECTED?this.setState(Trap.Transport.State.AVAILABLE):this.logger.debug("Potential race: Transport received onOpen while not connecting")),e},Trap.AbstractTransport.prototype.checkAuthentication=function(t){var e=this._authentication.verifyAuthentication(t.getAuthData(),this.headersMap,t.getData(),this.contextMap);if(!e){var r=this._authentication.createAuthenticationChallenge(this.contextMap),n=this.createMessage();n.setOp(Trap.Message.Operation.CHALLENGE),n.setAuthData(r),n.setTransportId(this.getTrapID());try{n.setData(t.serialize()),this.internalSend(n,!1),this._keepalivePredictor.dataSent()}catch(a){this.logger.warn("Something happened: {}",a)}}return e},Trap.AbstractTransport.prototype.getOption=function(t){return t.startsWith(this._prefix)||(t=this._prefix+"."+t),this._configuration.getOption(t)},Trap.AbstractTransport.prototype.isAlive=function(t,e,r,n){if((new Date).getTime()-t<this.lastAlive)return void n(!0);if(!e)return void n(!1);if(null==this.livenessCheckData){var a=this;this.livenessCheckData=""+(new Date).getTime(),this.livenessCheck=function(t){a.livenessCheckData==t&&(clearTimeout(a.livenessCheckTimeout),n(!0))},this.livenessCheckTimeout&&clearTimeout(this.livenessCheckTimeout),this.livenessCheckTimeout=setTimeout(function(){n(!1)},r)}this.sendKeepalive(!0,"3",this._keepalivePredictor.getNextKeepaliveSend(),this.livenessCheckData)},Trap.AbstractTransport.prototype.sendKeepalive=function(t,e,r,n){if("undefined"==typeof e||"undefined"==typeof r||"undefined"==typeof n)throw"Invalid call; Bug.";if(1!=e.length)throw"Invalid type";r=""+r;try{var a=this.createMessage();t?a.setOp(Trap.Message.Operation.PING):a.setOp(Trap.Message.Operation.PONG),r=this.padTimer(r),n=e+r+n,a.setData(n),this.sendTransportSpecific(a)}catch(i){this.logger.error(i)}},Trap.AbstractTransport.prototype.predictedKeepaliveExpired=function(t,e){this.logger.debug("Keepalive timer for {} expired. Moving to DISCONNECTED.",this.getTransportName()),this.setState(Trap.Transport.State.DISCONNECTED)},Trap.AbstractTransport.prototype.shouldSendKeepalive=function(t,e,r,n){this.logger.trace("Sending keepalive: {} | {} | {} | {}",t,e,r,n),this.sendKeepalive(t,e,r,n)},Trap.AbstractTransport.prototype.warnAddressConfiguration=function(){this.warnAddressConfigurationPerformed||this.configuration.getBooleanOption("warnAddressConfiguration",!0)&&(this.warnAddressConfigurationPerformed=!0,this.logger.warn("Configuration Error: {} could not detect a single public address; may need configuration!",this))},Trap.AbstractTransport.prototype.getHostName=function(t,e,r){return"localhost"},Trap.AbstractTransport.prototype.isConfigured=function(t,e){var r=!0;return t&&(r=r&&this.isClientConfigured()),e&&(r=r&&this.isServerConfigured()),r},Trap.AbstractTransport.prototype.isServerConfigured=function(){return this.canListen()},Trap.AbstractTransport.prototype.isClientConfigured=function(){return!1},Trap.AbstractTransport.prototype.forceError=function(){this.logger.isTraceEnabled()&&this.logger.trace("Error was forced"),this.setState(Trap.Transport.State.ERROR)},Trap.AbstractTransport.prototype.onAck=function(t){var e=t.getData();if(t.getFormat()==Trap.Message.Format.REGULAR)for(var r,n,a=0;a<e.length;a+=5)n=e[a],r=Trap.ByteConverter.fromBigEndian(e,a+1),this.removeTransitMessageById(r,n);else for(var a=0;a<e.length;a+=4){var r=Trap.ByteConverter.fromBigEndian7(e,a);this.removeTransitMessageById(r,0)}},Trap.AbstractTransport.prototype.addTransitMessage=function(t){0!=t.getMessageId()&&this.messagesInTransit.add(t)},Trap.AbstractTransport.prototype.removeTransitMessageById=function(t,e){for(var r=this.messagesInTransit.iterator(),n=!0;r.hasNext();){var a=r.next();if(a.getMessageId()==t&&a.getChannel()==e)return r.remove(),n||this.logger.error("It appears we have dropped some messages on an otherwise working transport. Most likely, this transport is bugged; please report this."),void this._dispatchEvent({type:"messagesent",data:a,message:a});n=!1}},Trap.AbstractTransport.prototype.acknowledgeTransitMessage=function(t){if(0!=t.getMessageId()){this._acks||(this._acks=this.useBinary&&this.getFormat()==Trap.Message.Format.REGULAR?new Trap.ByteArrayOutputStream:new Trap.ByteStringOutputStream),this._acks.length>512&&this.flushAcks(),this.getFormat()==Trap.Message.Format.REGULAR?(this._acks.write(t.getChannel()),this._acks.write(Trap.ByteConverter.toBigEndian(t.getMessageId()))):this._acks.write(Trap.ByteConverter.toBigEndian7(t.getMessageId()));var e=(new Date).valueOf();if(this._lastAckTimestamp>=e-5){if(!this._ackTask){var r=this;this._ackTask=setTimeout(function(){r.flushAcks()},6)}}else this.flushAcks()}},Trap.AbstractTransport.prototype.flushAcks=function(){this._lastAckTimestamp=(new Date).valueOf();var t=this.createMessage();t.setOp(Trap.Message.Operation.ACK),t.setData(this._acks.toArray()),this._acks.clear(),this.sendTransportSpecific(t)},Trap.AbstractTransport.prototype.createMessage=function(){var t=new Trap.Message;return t.setTransportId(this.trapID),t.setFormat(this.format),t},Trap.AbstractTransport.prototype.isObjectTransport=function(){return!1},Trap.Transports.WebSocket=function(){Trap.AbstractTransport.call(this),this._transportPriority=0,this.keepaliveInterval=28},Trap.Transports.WebSocket.prototype=new Trap.AbstractTransport,Trap.Transports.WebSocket.prototype.constructor=new Trap.Transports.WebSocket,Trap.Transports.WebSocket.CONFIG_URI="wsuri";try{Trap.Transports.WebSocket.prototype.supportsBinary="string"==typeof new WebSocket("ws://127.0.0.1").binaryType}catch(e){}Trap.Transports.WebSocket.prototype.canConnect=function(){return"undefined"!=typeof WebSocket&&WebSocket.prototype&&WebSocket.prototype.send?!0:!1},Trap.Transports.WebSocket.prototype.getTransportName=function(){return"websocket"},Trap.Transports.WebSocket.prototype.init=function(){Trap.AbstractTransport.prototype.init.call(this),this.ws&&(this.ws.onopen=function(){},this.ws.onerror=function(){},this.ws.onclose=function(){},this.ws.onmessage=function(){}),this.ws=null},Trap.Transports.WebSocket.prototype.getProtocolName=function(){return"websocket"},Trap.Transports.WebSocket.prototype.internalSend=function(t,e){var r=t.serialize(this.useBinary);this.ws.send(r.buffer?r.buffer:r)},Trap.Transports.WebSocket.prototype.flushTransport=function(){},Trap.Transports.WebSocket.prototype.isClientConfigured=function(){return!!this.getOption(Trap.Transports.WebSocket.CONFIG_URI)},Trap.Transports.WebSocket.prototype.internalConnect=function(){var t=this.getOption(Trap.Transports.WebSocket.CONFIG_URI);if(!t)return this.logger.debug("WebSocket Transport not properly configured... Unless autoconfigure is enabled (and another transport succeeds) this transport will not be available."),void this.setState(Trap.Transport.State.ERROR);var t=this.getOption(Trap.Transports.WebSocket.CONFIG_URI);this.logger.debug("WS Transport Opening"),this.ws=new WebSocket(t),this._initWS()},Trap.Transports.WebSocket.prototype.internalDisconnect=function(){this.getState()!=Trap.Transport.State.DISCONNECTED&&this.getState()!=Trap.Transport.State.DISCONNECTED&&this.getState()!=Trap.Transport.State.ERROR&&this.setState(Trap.Transport.State.DISCONNECTING),this.ws&&this.ws.close()},Trap.Transports.WebSocket.prototype.fillAuthenticationKeys=function(t){},Trap.Transports.WebSocket.prototype.updateContext=function(){},Trap.Transports.WebSocket.prototype._initWS=function(){var t=this;this.ws.onopen=function(){t.notifyOpen()},this.ws.onerror=function(){t.notifyError()},this.ws.onclose=function(){t.notifyClose()},this.ws.onmessage=function(e){t.notifyMessage(e.data)},this.useBinary&&this.supportsBinary&&(this.ws.binaryType="arraybuffer")},Trap.Transports.WebSocket.prototype.notifyError=function(){this.setState(Trap.Transport.State.ERROR)},Trap.Transports.WebSocket.prototype.notifyOpen=function(){this.logger.debug("WS Transport Connected"),this.setState(Trap.Transport.State.CONNECTED)},Trap.Transports.WebSocket.prototype.notifyClose=function(){this.ws=null,this.getState()!=Trap.Transport.State.ERROR&&this.setState(Trap.Transport.State.DISCONNECTED),this.logger.debug("WS Transport Disconnected")},Trap.Transports.WebSocket.prototype.notifyMessage=function(t){"string"==typeof t?(t=t.toUTF8ByteArray(),this.receive(t,0,t.length)):this.receive(new Uint8Array(t))},Trap.Transports.HTTP=function(){Trap.AbstractTransport.call(this),this._transportPriority=100,this.expirationDelay=28e3,this.connectionTimeout=1e4,this.latencyEstimate=1e3,this._buf=[]},Trap.Transports.HTTP.prototype=new Trap.AbstractTransport,Trap.Transports.HTTP.prototype.constructor=new Trap.Transports.HTTP,Trap.Transports.HTTP.CONFIG_URL="url";try{Trap.Transports.HTTP.prototype.supportsBinary="string"==typeof(new XMLHttpRequest).responseType}catch(e){Trap.Transports.HTTP.prototype.supportsBinary=!1}Trap.Transports.HTTP.prototype.init=function(){this._buf=[],this._longpoll&&(this._longpoll.onreadystatechange=function(){}),Trap.AbstractTransport.prototype.init.call(this)},Trap.Transports.HTTP.prototype.getTransportName=function(){return"http"},Trap.Transports.HTTP.prototype.getProtocolName=function(){return"http"},Trap.Transports.HTTP.prototype.updateConfig=function(){Trap.AbstractTransport.prototype.updateConfig.call(this),this.getState()==Trap.Transport.State.DISCONNECTED||this.getState()==Trap.Transport.State.CONNECTING?this.url=this.getOption(Trap.Transports.HTTP.CONFIG_URL):this.logger.debug("Updating HTTP configuration while open; changes will not take effect until HTTP is reconnected"),this.expirationDelay=this._configuration.getIntOption(this._prefix+".expirationDelay",this.expirationDelay),this.connectionTimeout=this._configuration.getIntOption(this._prefix+".connectionTimeout",this.connectionTimeout)},Trap.Transports.HTTP.prototype.fillAuthenticationKeys=function(t){},Trap.Transports.HTTP.prototype.updateContext=function(){},Trap.Transports.HTTP.prototype.internalSend=function(t,e){var r=this;if(r._sendQueued=!0,t&&this._buf.push(t),e)return r._sendTimer&&clearTimeout(r._sendTimer),void(r._sendTimer=setTimeout(function(){r.internalSend(null,!1)},1e3));if(r._sendTimer&&(clearTimeout(r._sendTimer),r._sendTimer=null),0!=this._buf.length){for(var n=this.useBinary?new Trap.ByteArrayOutputStream:new Trap.ByteStringOutputStream,a=0;a<this._buf.length;a++)n.write(this._buf[a].serialize(this.useBinary));var i=this.useBinary?n.toArray():n.toString();(r.getState()==Trap.Transport.State.AVAILABLE||r.getState()==Trap.Transport.State.CONNECTED)&&r.setState(Trap.Transport.State.UNAVAILABLE);var s=this.openConnection("POST");s.setRequestHeader("Content-Type","x-trap"),s.send(i.buffer?i.buffer:i),s.onreadystatechange=function(){if(4==s.readyState){if(s.hasError||s.hasTimeout||s.isAborted)r._dispatchEvent({type:"failedsending",messages:r._buf}),r.setState(Trap.Transport.State.ERROR);else{for(var t=0;t<r._buf.length;t++)r._buf[t].getMessageId()>0&&r._dispatchEvent({type:"messagesent",data:r._buf[t],message:r._buf[t]});r._buf=[],(r.getState()==Trap.Transport.State.UNAVAILABLE||r.getState()==Trap.Transport.State.CONNECTED)&&r.setState(Trap.Transport.State.AVAILABLE)}r._sendQueued=!1}}}},Trap.Transports.HTTP.prototype.isClientConfigured=function(){return this.url&&"string"==typeof this.url&&this.url.length>4},Trap.Transports.HTTP.prototype.internalConnect=function(){if(this.logger.debug("HTTP Transport Opening..."),!this.isClientConfigured())return this.logger.debug("HTTP Transport not properly configured... Unless autoconfigure is enabled (and another transport succeeds) this transport will not be available."),void this.setState(Trap.Transport.State.ERROR);var t=this;try{var e=this.openConnection("GET");e.responseType="text",e.onreadystatechange=function(){if(4==e.readyState){if(200!=e.status||e.hasError||e.hasTimeout||e.isAborted)return t.logger.warn("HTTP transport failed with state ",e.status),t.setState(Trap.Transport.State.ERROR),!0;"/"==t.url.charAt(t.url.length-1)?t.url=t.url+e.responseText:t.url=t.url+"/"+e.responseText,t.running=!0,t.poll(),t.setState(Trap.Transport.State.CONNECTED)}return!1},e.send()}catch(r){return this.logger.warn("HTTP transport failed to connect due to ",r),r.stack&&this.logger.debug(r.stack),void this.setState(Trap.Transport.State.ERROR)}},Trap.Transports.HTTP.prototype.internalDisconnect=function(){var t=this;if(t._sendQueued)return void setTimeout(function(){t.internalDisconnect()},100);var e=new XMLHttpRequest;e.open("POST",this.url,!0);var r=function(){t.running=!1,t.getState()==Trap.Transport.State.DISCONNECTING&&t.setState(Trap.Transport.State.DISCONNECTED)};e.onreadystatechange=function(){4==e.readyState&&r()},e.send()},Trap.Transports.HTTP.prototype.canConnect=function(){return!0},Trap.Transports.HTTP.prototype.poll=function(){if(this.running){var t=this.openConnection("GET");if(this.useBinary)try{t.responseType="arraybuffer"}catch(e){return console.error("Asked to use binary but could not use binary mode transport!"),void this.setState(Trap.Transport.State.ERROR)}var r=this;t.onreadystatechange=function(){if(4==t.readyState)if(t.isAborted)2==t.abortState?(r.poll(),r._keepalivePredictor.dataReceived()):r.setState(Trap.Transport.State.ERROR);else if(t.status<300&&t.status>=200)if("arraybuffer"==t.responseType)try{if(t.response){var e=new Uint8Array(t.response);r.receive(e)}(0!=t.status||0!=t.statusText.length)&&r.poll()}catch(n){console.log(n)}else{var e=t.responseText;e=e.toUTF8ByteArray(),r.receive(e,0,e.length),r.poll(),r._keepalivePredictor.dataReceived()}else(0==t.status||t.status>=300)&&r.getState()!=Trap.Transport.State.DISCONNECTING&&r.getState()!=Trap.Transport.State.DISCONNECTED&&r.setState(Trap.Transport.State.ERROR)},t.send(),r._keepalivePredictor.dataSent(),this._longpoll=t}},Trap.Transports.HTTP.prototype.openConnection=function(t){function e(t){n.isAborted=!0,n.abortState=n.readyState,n.abort()}function r(){if(!o){o=!0;var t=(new Date).valueOf(),e=t-p;a.latencyEstimate=(a.latencyEstimate+e)/2}}var n=new XMLHttpRequest;n.open(t,this.url+"?expires="+this.expirationDelay,!0),n.aborted=!1,"arraybuffer"===n.responseType;var a=this,i=null,s=function(){1==n.readyState&&(e(),a.logger.warn("XHR longpoll failed to connect..."))};n.connectionTimer=setTimeout(s,this.expirationDelay+3*this.latencyEstimate);var o=!1,p=(new Date).valueOf();n.upload&&n.upload.addEventListener("loadstart",function(){clearTimeout(n.connectionTimer),o=!0;var t=!1,r=1e3,i=!1;n.upload.addEventListener("progress",function(){t=!0},!0),n.upload.addEventListener("error",function(){n.hasError=!0},!0),n.upload.addEventListener("timeout",function(){n.hasTimeout=!0},!0),n.upload.addEventListener("load",function(){clearTimeout(h),i=!0,n.connectionTimer=setTimeout(s,a.connectionTimeout)},!0),n.upload.addEventListener("loadend",function(){i||(a.logger.warn("Incomplete upload: loadend without load"),n.hasError=!0)},!0);var p=function(){if(a.running&&4!=n.readyState){if(!t)return void e();t=!1,setTimeout(p,r)}},h=setTimeout(p,a.connectionTimeout)},!0),n.addEventListener("loadstart",function(){a.logger.trace("XHR load started...")}),n.addEventListener("readystatechange",function(){switch(n.readyState){case 0:break;case 1:break;case 2:a.logger.debug("XHR switched state to headers received (we have connection to server). Stopping connectionTimeout, starting pollTimeout"),clearTimeout(n.connectionTimer),r(),i=setTimeout(function(){if(a.running){switch(n.readyState){case 0:case 1:return e(),a.logger.warn("XHR ended in an inconsistent state..."),void a.setState(Trap.Transport.State.ERROR);case 2:return e(),void a.logger.debug("Loading failed after headers loaded");case 3:break;case 4:return a.logger.error("HTTP transport in inconsistent state"),void a.setState(Trap.Transport.State.ERROR)}var t=!1;n.onprogress=function(){t=!0};var r=function(){if(a.running&&4!=n.readyState){if(!t)return void e();t=!1,setTimeout(r,100)}};setTimeout(r,100)}},3e4);break;case 3:a.logger.debug("XHR switched state to Receiving (data incoming from server)");break;case 4:clearTimeout(i),(n.hasError||n.hasTimeout)&&a.setState(Trap.Transport.State.ERROR)}},!0);var h=!1;return n.addEventListener("error",function(){n.hasError=!0},!0),n.addEventListener("timeout",function(){n.hasTimeout=!0},!0),n.addEventListener("load",function(){h=!0},!0),n.addEventListener("loadend",function(){h||(a.logger.warn("Incomplete download: loadend without load"),n.hasError=!0)},!0),n},Trap.Transports.HTTP.prototype.flushTransport=function(){this.internalSend(null,!1)},Trap.Transports.HTTP.prototype.setState=function(){(this.getState()==Trap.Transport.State.DISCONNECTED||this.getState()==Trap.Transport.State.ERROR)&&(this.running=!1),Trap.AbstractTransport.prototype.setState.apply(this,arguments)},t.Trap=Trap}(self),Trap.Logger.appender._info=Trap.Logger.appender._warn=Trap.Logger.appender._error=function(t){console.log(t.join(""))},RelayTrap=Trap)),function(t){"use strict";function e(t,e,r){return t>=e&&r>=t}function r(t,e){return Math.floor(t/e)}function n(t){var e=0;this.get=function(){return e>=t.length?U:Number(t[e])},this.offset=function(r){if(e+=r,0>e)throw new Error("Seeking past start of the buffer");if(e>t.length)throw new Error("Seeking past EOF")},this.match=function(r){if(r.length>e+t.length)return!1;var n;for(n=0;n<r.length;n+=1)if(Number(t[e+n])!==r[n])return!1;return!0}}function a(t){var e=0;this.emit=function(r){var n,a=U;for(n=0;n<arguments.length;++n)a=Number(arguments[n]),t[e++]=a;return a}}function i(t){var r=0,n=function(){for(var r=[],n=0,a=t.length;n<t.length;){var i=t.charCodeAt(n);if(e(i,55296,57343))if(e(i,56320,57343))r.push(65533);else if(n===a-1)r.push(65533);else{var s=t.charCodeAt(n+1);if(e(s,56320,57343)){var o=1023&i,p=1023&s;n+=1,r.push(65536+(o<<10)+p)}else r.push(65533)}else r.push(i);n+=1}return r}();this.offset=function(t){if(r+=t,0>r)throw new Error("Seeking past start of the buffer");if(r>n.length)throw new Error("Seeking past EOF")},this.get=function(){return r>=n.length?F:n[r]}}function s(){var t="";this.string=function(){return t},this.emit=function(e){65535>=e?t+=String.fromCharCode(e):(e-=65536,t+=String.fromCharCode(55296+(e>>10&1023)),t+=String.fromCharCode(56320+(1023&e)))}}function o(t,e){if(t)throw new Error("EncodingError");return e||65533}function p(t){throw new Error("EncodingError")}function h(t){if(t=String(t).trim().toLowerCase(),Object.prototype.hasOwnProperty.call(j,t))return j[t];throw new Error("EncodingError: Unknown encoding: "+t)}function u(t,e){return(e||[])[t]||null}function c(t,e){var r=e.indexOf(t);return-1===r?null:r}function l(t){if(t>39419&&189e3>t||t>1237575)return null;var e,r=0,n=0,a=W.gb18030;for(e=0;e<a.length;++e){var i=a[e];if(!(i[0]<=t))break;r=i[0],n=i[1]}return n+t-r}function f(t){var e,r=0,n=0,a=W.gb18030;for(e=0;e<a.length;++e){var i=a[e];if(!(i[1]<=t))break;r=i[1],n=i[0]}return n+t-r}function g(t){var r=t.fatal,n=0,a=0,i=0,s=0;this.decode=function(t){var p=t.get();if(p===U)return 0!==a?o(r):F;if(t.offset(1),0===a){if(e(p,0,127))return p;if(e(p,194,223))a=1,s=128,n=p-192;else if(e(p,224,239))a=2,s=2048,n=p-224;else{if(!e(p,240,244))return o(r);a=3,s=65536,n=p-240}return n*=Math.pow(64,a),null}if(!e(p,128,191))return n=0,a=0,i=0,s=0,t.offset(-1),o(r);if(i+=1,n+=(p-128)*Math.pow(64,a-i),i!==a)return null;var h=n,u=s;return n=0,a=0,i=0,s=0,e(h,u,1114111)&&!e(h,55296,57343)?h:o(r)}}function T(t){t.fatal;this.encode=function(t,n){var a=n.get();if(a===F)return U;if(n.offset(1),e(a,55296,57343))return p(a);if(e(a,0,127))return t.emit(a);var i,s;e(a,128,2047)?(i=1,s=192):e(a,2048,65535)?(i=2,s=224):e(a,65536,1114111)&&(i=3,s=240);for(var o=t.emit(r(a,Math.pow(64,i))+s);i>0;){var h=r(a,Math.pow(64,i-1));o=t.emit(128+h%64),i-=1}return o}}function d(t,r){var n=r.fatal;this.decode=function(r){var a=r.get();if(a===U)return F;if(r.offset(1),e(a,0,127))return a;var i=t[a-128];return null===i?o(n):i}}function y(t,r){r.fatal;this.encode=function(r,n){var a=n.get();if(a===F)return U;if(n.offset(1),e(a,0,127))return r.emit(a);var i=c(a,t);return null===i&&p(a),r.emit(i+128)}}function v(t,r){var n=r.fatal,a=0,i=0,s=0;this.decode=function(r){var p=r.get();if(p===U&&0===a&&0===i&&0===s)return F;p!==U||0===a&&0===i&&0===s||(a=0,i=0,s=0,o(n)),r.offset(1);var h;if(0!==s)return h=null,e(p,48,57)&&(h=l(10*(126*(10*(a-129)+(i-48))+(s-129))+p-48)),a=0,i=0,s=0,null===h?(r.offset(-3),o(n)):h;if(0!==i)return e(p,129,254)?(s=p,null):(r.offset(-2),a=0,i=0,o(n));if(0!==a){if(e(p,48,57)&&t)return i=p,null;var c=a,f=null;a=0;var g=127>p?64:65;return(e(p,64,126)||e(p,128,254))&&(f=190*(c-129)+(p-g)),h=null===f?null:u(f,W.gbk),null===f&&r.offset(-1),null===h?o(n):h}return e(p,0,127)?p:128===p?8364:e(p,129,254)?(a=p,null):o(n)}}function m(t,n){n.fatal;this.encode=function(n,a){var i=a.get();if(i===F)return U;if(a.offset(1),e(i,0,127))return n.emit(i);var s=c(i,W.gbk);if(null!==s){var o=r(s,190)+129,h=s%190,u=63>h?64:65;return n.emit(o,h+u)}if(null===s&&!t)return p(i);s=f(i);var l=r(r(r(s,10),126),10);s-=10*l*126*10;var g=r(r(s,10),126);s-=10*g*126;var T=r(s,10),d=s-10*T;return n.emit(l+129,g+48,T+129,d+48)}}function b(t){var r=t.fatal,n=!1,a=0;this.decode=function(t){var i=t.get();if(i===U&&0===a)return F;if(i===U&&0!==a)return a=0,o(r);if(t.offset(1),126===a)return a=0,123===i?(n=!0,null):125===i?(n=!1,null):126===i?126:10===i?null:(t.offset(-1),o(r));if(0!==a){var s=a;a=0;var p=null;return e(i,33,126)&&(p=u(190*(s-1)+(i+63),W.gbk)),10===i&&(n=!1),null===p?o(r):p}return 126===i?(a=126,null):n?e(i,32,127)?(a=i,null):(10===i&&(n=!1),o(r)):e(i,0,127)?i:o(r)}}function S(t){var n=(t.fatal,!1);this.encode=function(t,a){var i=a.get();if(i===F)return U;if(a.offset(1),e(i,0,127)&&n)return a.offset(-1),n=!1,t.emit(126,125);if(126===i)return t.emit(126,126);if(e(i,0,127))return t.emit(i);if(!n)return a.offset(-1),n=!0,t.emit(126,123);var s=c(i,W.gbk);if(null===s)return p(i);var o=r(s,190)+1,h=s%190-63;return e(o,33,126)&&e(h,33,126)?t.emit(o,h):p(i)}}function E(t){var r=t.fatal,n=0,a=null;this.decode=function(t){if(null!==a){var i=a;return a=null,i}var s=t.get();if(s===U&&0===n)return F;if(s===U&&0!==n)return n=0,o(r);if(t.offset(1),0!==n){var p=n,h=null;n=0;var c=127>s?64:98;if((e(s,64,126)||e(s,161,254))&&(h=157*(p-129)+(s-c)),1133===h)return a=772,202;if(1135===h)return a=780,202;if(1164===h)return a=772,234;if(1166===h)return a=780,234;var l=null===h?null:u(h,W.big5);return null===h&&t.offset(-1),null===l?o(r):l}return e(s,0,127)?s:e(s,129,254)?(n=s,null):o(r)}}function _(t){t.fatal;this.encode=function(t,n){var a=n.get();if(a===F)return U;if(n.offset(1),e(a,0,127))return t.emit(a);var i=c(a,W.big5);if(null===i)return p(a);var s=r(i,157)+129,o=i%157,h=63>o?64:98;return t.emit(s,o+h)}}function A(t){var r=t.fatal,n=0,a=0;this.decode=function(t){var i=t.get();if(i===U)return 0===n&&0===a?F:(n=0,a=0,o(r));t.offset(1);var s,p;return 0!==a?(s=a,a=0,p=null,e(s,161,254)&&e(i,161,254)&&(p=u(94*(s-161)+i-161,W.jis0212)),e(i,161,254)||t.offset(-1),null===p?o(r):p):142===n&&e(i,161,223)?(n=0,65377+i-161):143===n&&e(i,161,254)?(n=0,a=i,null):0!==n?(s=n,n=0,p=null,e(s,161,254)&&e(i,161,254)&&(p=u(94*(s-161)+i-161,W.jis0208)),e(i,161,254)||t.offset(-1),null===p?o(r):p):e(i,0,127)?i:142===i||143===i||e(i,161,254)?(n=i,null):o(r)}}function C(t){t.fatal;this.encode=function(t,n){var a=n.get();if(a===F)return U;if(n.offset(1),e(a,0,127))return t.emit(a);if(165===a)return t.emit(92);if(8254===a)return t.emit(126);if(e(a,65377,65439))return t.emit(142,a-65377+161);var i=c(a,W.jis0208);if(null===i)return p(a);var s=r(i,94)+161,o=i%94+161;return t.emit(s,o)}}function w(t){var r=t.fatal,n={ASCII:0,escape_start:1,escape_middle:2,escape_final:3,lead:4,trail:5,Katakana:6},a=n.ASCII,i=!1,s=0;this.decode=function(t){var p=t.get();switch(p!==U&&t.offset(1),a){default:case n.ASCII:return 27===p?(a=n.escape_start,null):e(p,0,127)?p:p===U?F:o(r);case n.escape_start:return 36===p||40===p?(s=p,a=n.escape_middle,null):(p!==U&&t.offset(-1),a=n.ASCII,o(r));case n.escape_middle:var h=s;return s=0,36!==h||64!==p&&66!==p?36===h&&40===p?(a=n.escape_final,null):40!==h||66!==p&&74!==p?40===h&&73===p?(a=n.Katakana,null):(p===U?t.offset(-1):t.offset(-2),a=n.ASCII,o(r)):(a=n.ASCII,null):(i=!1,a=n.lead,null);case n.escape_final:return 68===p?(i=!0,a=n.lead,null):(p===U?t.offset(-2):t.offset(-3),a=n.ASCII,o(r));case n.lead:return 10===p?(a=n.ASCII,o(r,10)):27===p?(a=n.escape_start,null):p===U?F:(s=p,a=n.trail,null);case n.trail:if(a=n.lead,p===U)return o(r);var c=null,l=94*(s-33)+p-33;return e(s,33,126)&&e(p,33,126)&&(c=i===!1?u(l,W.jis0208):u(l,W.jis0212)),null===c?o(r):c;case n.Katakana:return 27===p?(a=n.escape_start,null):e(p,33,95)?65377+p-33:p===U?F:o(r)}}}function I(t){var n=(t.fatal,{ASCII:0,lead:1,Katakana:2}),a=n.ASCII;this.encode=function(t,i){var s=i.get();if(s===F)return U;if(i.offset(1),(e(s,0,127)||165===s||8254===s)&&a!==n.ASCII)return i.offset(-1),a=n.ASCII,t.emit(27,40,66);if(e(s,0,127))return t.emit(s);if(165===s)return t.emit(92);if(8254===s)return t.emit(126);if(e(s,65377,65439)&&a!==n.Katakana)return i.offset(-1),a=n.Katakana,t.emit(27,40,73);if(e(s,65377,65439))return t.emit(s-65377-33);if(a!==n.lead)return i.offset(-1),a=n.lead,t.emit(27,36,66);var o=c(s,W.jis0208);if(null===o)return p(s);var h=r(o,94)+33,u=o%94+33;return t.emit(h,u)}}function k(t){var r=t.fatal,n=0;this.decode=function(t){var a=t.get();if(a===U&&0===n)return F;if(a===U&&0!==n)return n=0,o(r);if(t.offset(1),0!==n){var i=n;if(n=0,e(a,64,126)||e(a,128,252)){
var s=127>a?64:65,p=160>i?129:193,h=u(188*(i-p)+a-s,W.jis0208);return null===h?o(r):h}return t.offset(-1),o(r)}return e(a,0,128)?a:e(a,161,223)?65377+a-161:e(a,129,159)||e(a,224,252)?(n=a,null):o(r)}}function O(t){t.fatal;this.encode=function(t,n){var a=n.get();if(a===F)return U;if(n.offset(1),e(a,0,128))return t.emit(a);if(165===a)return t.emit(92);if(8254===a)return t.emit(126);if(e(a,65377,65439))return t.emit(a-65377+161);var i=c(a,W.jis0208);if(null===i)return p(a);var s=r(i,188),o=31>s?129:193,h=i%188,u=63>h?64:65;return t.emit(s+o,h+u)}}function N(t){var r=t.fatal,n=0;this.decode=function(t){var a=t.get();if(a===U&&0===n)return F;if(a===U&&0!==n)return n=0,o(r);if(t.offset(1),0!==n){var i=n,s=null;if(n=0,e(i,129,198)){var p=178*(i-129);e(a,65,90)?s=p+a-65:e(a,97,122)?s=p+26+a-97:e(a,129,254)&&(s=p+26+26+a-129)}e(i,199,253)&&e(a,161,254)&&(s=12460+94*(i-199)+(a-161));var h=null===s?null:u(s,W["euc-kr"]);return null===s&&t.offset(-1),null===h?o(r):h}return e(a,0,127)?a:e(a,129,253)?(n=a,null):o(r)}}function D(t){t.fatal;this.encode=function(t,n){var a=n.get();if(a===F)return U;if(n.offset(1),e(a,0,127))return t.emit(a);var i=c(a,W["euc-kr"]);if(null===i)return p(a);var s,o;if(12460>i){s=r(i,178)+129,o=i%178;var h=26>o?65:52>o?71:77;return t.emit(s,o+h)}return i-=12460,s=r(i,94)+199,o=i%94+161,t.emit(s,o)}}function M(t){var r=t.fatal,n={ASCII:0,escape_start:1,escape_middle:2,escape_end:3,lead:4,trail:5},a=n.ASCII,i=0;this.decode=function(t){var s=t.get();switch(s!==U&&t.offset(1),a){default:case n.ASCII:return 14===s?(a=n.lead,null):15===s?null:27===s?(a=n.escape_start,null):e(s,0,127)?s:s===U?F:o(r);case n.escape_start:return 36===s?(a=n.escape_middle,null):(s!==U&&t.offset(-1),a=n.ASCII,o(r));case n.escape_middle:return 41===s?(a=n.escape_end,null):(s===U?t.offset(-1):t.offset(-2),a=n.ASCII,o(r));case n.escape_end:return 67===s?(a=n.ASCII,null):(s===U?t.offset(-2):t.offset(-3),a=n.ASCII,o(r));case n.lead:return 10===s?(a=n.ASCII,o(r,10)):14===s?null:15===s?(a=n.ASCII,null):s===U?F:(i=s,a=n.trail,null);case n.trail:if(a=n.lead,s===U)return o(r);var p=null;return e(i,33,70)&&e(s,33,126)?p=u(178*(i-1)+26+26+s-1,W["euc-kr"]):e(i,71,126)&&e(s,33,126)&&(p=u(12460+94*(i-71)+(s-33),W["euc-kr"])),null!==p?p:o(r)}}}function L(t){var n=(t.fatal,{ASCII:0,lead:1}),a=!1,i=n.ASCII;this.encode=function(t,s){var o=s.get();if(o===F)return U;if(a||(a=!0,t.emit(27,36,41,67)),s.offset(1),e(o,0,127)&&i!==n.ASCII)return s.offset(-1),i=n.ASCII,t.emit(15);if(e(o,0,127))return t.emit(o);if(i!==n.lead)return s.offset(-1),i=n.lead,t.emit(14);var h=c(o,W["euc-kr"]);if(null===h)return p(o);var u,l;return 12460>h?(u=r(h,178)+1,l=h%178-26-26+1,e(u,33,70)&&e(l,33,126)?t.emit(u,l):p(o)):(h-=12460,u=r(h,94)+71,l=h%94+33,e(u,71,126)&&e(l,33,126)?t.emit(u,l):p(o))}}function R(t,r){var n=r.fatal,a=null,i=null;this.decode=function(r){var s=r.get();if(s===U&&null===a&&null===i)return F;if(s===U&&(null!==a||null!==i))return o(n);if(r.offset(1),null===a)return a=s,null;var p;if(p=t?(a<<8)+s:(s<<8)+a,a=null,null!==i){var h=i;return i=null,e(p,56320,57343)?65536+1024*(h-55296)+(p-56320):(r.offset(-2),o(n))}return e(p,55296,56319)?(i=p,null):e(p,56320,57343)?o(n):p}}function x(t,n){n.fatal;this.encode=function(n,a){function i(e){var r=e>>8,a=255&e;return t?n.emit(r,a):n.emit(a,r)}var s=a.get();if(s===F)return U;if(a.offset(1),e(s,55296,57343)&&p(s),65535>=s)return i(s);var o=r(s-65536,1024)+55296,h=(s-65536)%1024+56320;return i(o),i(h)}}function B(t,e){return e.match([255,254])?(e.offset(2),"utf-16"):e.match([254,255])?(e.offset(2),"utf-16be"):e.match([239,187,191])?(e.offset(3),"utf-8"):t}function P(e,r){return this&&this!==t?(e=e?String(e):H,r=Object(r),this._encoding=h(e),this._streaming=!1,this._encoder=null,this._options={fatal:Boolean(r.fatal)},Object.defineProperty?Object.defineProperty(this,"encoding",{get:function(){return this._encoding.name}}):this.encoding=this._encoding.name,this):new P(e,r)}function G(e,r){return this&&this!==t?(e=e?String(e):H,r=Object(r),this._encoding=h(e),this._streaming=!1,this._decoder=null,this._options={fatal:Boolean(r.fatal)},Object.defineProperty?Object.defineProperty(this,"encoding",{get:function(){return this._encoding.name}}):this.encoding=this._encoding.name,this):new G(e,r)}var U=-1,F=-1,K=[{encodings:[{labels:["unicode-1-1-utf-8","utf-8","utf8"],name:"utf-8"}],heading:"The Encoding"},{encodings:[{labels:["cp864","ibm864"],name:"ibm864"},{labels:["cp866","ibm866"],name:"ibm866"},{labels:["csisolatin2","iso-8859-2","iso-ir-101","iso8859-2","iso_8859-2","l2","latin2"],name:"iso-8859-2"},{labels:["csisolatin3","iso-8859-3","iso_8859-3","iso-ir-109","l3","latin3"],name:"iso-8859-3"},{labels:["csisolatin4","iso-8859-4","iso_8859-4","iso-ir-110","l4","latin4"],name:"iso-8859-4"},{labels:["csisolatincyrillic","cyrillic","iso-8859-5","iso_8859-5","iso-ir-144"],name:"iso-8859-5"},{labels:["arabic","csisolatinarabic","ecma-114","iso-8859-6","iso_8859-6","iso-ir-127"],name:"iso-8859-6"},{labels:["csisolatingreek","ecma-118","elot_928","greek","greek8","iso-8859-7","iso_8859-7","iso-ir-126"],name:"iso-8859-7"},{labels:["csisolatinhebrew","hebrew","iso-8859-8","iso-8859-8-i","iso-ir-138","iso_8859-8","visual"],name:"iso-8859-8"},{labels:["csisolatin6","iso-8859-10","iso-ir-157","iso8859-10","l6","latin6"],name:"iso-8859-10"},{labels:["iso-8859-13"],name:"iso-8859-13"},{labels:["iso-8859-14","iso8859-14"],name:"iso-8859-14"},{labels:["iso-8859-15","iso_8859-15"],name:"iso-8859-15"},{labels:["iso-8859-16"],name:"iso-8859-16"},{labels:["koi8-r","koi8_r"],name:"koi8-r"},{labels:["koi8-u"],name:"koi8-u"},{labels:["csmacintosh","mac","macintosh","x-mac-roman"],name:"macintosh"},{labels:["iso-8859-11","tis-620","windows-874"],name:"windows-874"},{labels:["windows-1250","x-cp1250"],name:"windows-1250"},{labels:["windows-1251","x-cp1251"],name:"windows-1251"},{labels:["ascii","ansi_x3.4-1968","csisolatin1","iso-8859-1","iso8859-1","iso_8859-1","l1","latin1","us-ascii","windows-1252"],name:"windows-1252"},{labels:["cp1253","windows-1253"],name:"windows-1253"},{labels:["csisolatin5","iso-8859-9","iso-ir-148","l5","latin5","windows-1254"],name:"windows-1254"},{labels:["cp1255","windows-1255"],name:"windows-1255"},{labels:["cp1256","windows-1256"],name:"windows-1256"},{labels:["windows-1257"],name:"windows-1257"},{labels:["cp1258","windows-1258"],name:"windows-1258"},{labels:["x-mac-cyrillic","x-mac-ukrainian"],name:"x-mac-cyrillic"}],heading:"Legacy single-byte encodings"},{encodings:[{labels:["chinese","csgb2312","csiso58gb231280","gb2312","gbk","gb_2312","gb_2312-80","iso-ir-58","x-gbk"],name:"gbk"},{labels:["gb18030"],name:"gb18030"},{labels:["hz-gb-2312"],name:"hz-gb-2312"}],heading:"Legacy multi-byte Chinese (simplified) encodings"},{encodings:[{labels:["big5","big5-hkscs","cn-big5","csbig5","x-x-big5"],name:"big5"}],heading:"Legacy multi-byte Chinese (traditional) encodings"},{encodings:[{labels:["cseucpkdfmtjapanese","euc-jp","x-euc-jp"],name:"euc-jp"},{labels:["csiso2022jp","iso-2022-jp"],name:"iso-2022-jp"},{labels:["csshiftjis","ms_kanji","shift-jis","shift_jis","sjis","windows-31j","x-sjis"],name:"shift_jis"}],heading:"Legacy multi-byte Japanese encodings"},{encodings:[{labels:["cseuckr","csksc56011987","euc-kr","iso-ir-149","korean","ks_c_5601-1987","ks_c_5601-1989","ksc5601","ksc_5601","windows-949"],name:"euc-kr"},{labels:["csiso2022kr","iso-2022-kr"],name:"iso-2022-kr"}],heading:"Legacy multi-byte Korean encodings"},{encodings:[{labels:["utf-16","utf-16le"],name:"utf-16"},{labels:["utf-16be"],name:"utf-16be"}],heading:"Legacy utf-16 encodings"}],z={},j={};K.forEach(function(t){t.encodings.forEach(function(t){z[t.name]=t,t.labels.forEach(function(e){j[e]=t})})});var W=t["encoding-indexes"]||{};z["utf-8"].getEncoder=function(t){return new T(t)},z["utf-8"].getDecoder=function(t){return new g(t)},function(){["ibm864","ibm866","iso-8859-2","iso-8859-3","iso-8859-4","iso-8859-5","iso-8859-6","iso-8859-7","iso-8859-8","iso-8859-10","iso-8859-13","iso-8859-14","iso-8859-15","iso-8859-16","koi8-r","koi8-u","macintosh","windows-874","windows-1250","windows-1251","windows-1252","windows-1253","windows-1254","windows-1255","windows-1256","windows-1257","windows-1258","x-mac-cyrillic"].forEach(function(t){var e=z[t],r=W[t];e.getDecoder=function(t){return new d(r,t)},e.getEncoder=function(t){return new y(r,t)}})}(),z.gbk.getEncoder=function(t){return new m(!1,t)},z.gbk.getDecoder=function(t){return new v(!1,t)},z.gb18030.getEncoder=function(t){return new m(!0,t)},z.gb18030.getDecoder=function(t){return new v(!0,t)},z["hz-gb-2312"].getEncoder=function(t){return new S(t)},z["hz-gb-2312"].getDecoder=function(t){return new b(t)},z.big5.getEncoder=function(t){return new _(t)},z.big5.getDecoder=function(t){return new E(t)},z["euc-jp"].getEncoder=function(t){return new C(t)},z["euc-jp"].getDecoder=function(t){return new A(t)},z["iso-2022-jp"].getEncoder=function(t){return new I(t)},z["iso-2022-jp"].getDecoder=function(t){return new w(t)},z.shift_jis.getEncoder=function(t){return new O(t)},z.shift_jis.getDecoder=function(t){return new k(t)},z["euc-kr"].getEncoder=function(t){return new D(t)},z["euc-kr"].getDecoder=function(t){return new N(t)},z["iso-2022-kr"].getEncoder=function(t){return new L(t)},z["iso-2022-kr"].getDecoder=function(t){return new M(t)},z["utf-16"].getEncoder=function(t){return new x(!1,t)},z["utf-16"].getDecoder=function(t){return new R(!1,t)},z["utf-16be"].getEncoder=function(t){return new x(!0,t)},z["utf-16be"].getDecoder=function(t){return new R(!0,t)};var H="utf-8";P.prototype={encode:function(t,e){t=t?String(t):"",e=Object(e),this._streaming||(this._encoder=this._encoding.getEncoder(this._options)),this._streaming=Boolean(e.stream);for(var r=[],n=new a(r),s=new i(t);s.get()!==F;)this._encoder.encode(n,s);if(!this._streaming){var o;do o=this._encoder.encode(n,s);while(o!==U);this._encoder=null}return new Uint8Array(r)}},G.prototype={decode:function(t,e){if(t&&!("buffer"in t&&"byteOffset"in t&&"byteLength"in t))throw new TypeError("Expected ArrayBufferView");t||(t=new Uint8Array(0)),e=Object(e),this._streaming||(this._decoder=this._encoding.getDecoder(this._options)),this._streaming=Boolean(e.stream);var r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),a=new n(r),i=B(this._encoding.name,a);if(h(i)!==this._encoding)throw new Error("BOM mismatch");for(var o,p=new s;a.get()!==U;)o=this._decoder.decode(a),null!==o&&o!==F&&p.emit(o);if(!this._streaming){do o=this._decoder.decode(a),null!==o&&o!==F&&p.emit(o);while(o!==F);this._decoder=null}return p.string()}},t.TextEncoder=t.TextEncoder||P,t.TextDecoder=t.TextDecoder||G}(this);