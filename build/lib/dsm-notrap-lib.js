function logResult(e,t){console.log("LOGGING.result: message="+t);var n=document.createElement("div");n.innerHTML=e+t;var r=document.getElementById("results");"undefined"!=typeof r&&null!=r&&r.insertBefore(n,r.firstChild)}function logMessage(e){logResult("",e)}function logInfo(e,t,n){DSM.DEBUG&&"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log("INFO "+e+"."+t+"(): "+n)}function logFailure(e,t,n){"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log("ERROR "+e+"."+t+"(): "+n)}function logWarning(e,t,n){"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log("WARNING "+e+"."+t+"(): "+n)}function trim(e,t){return ltrim(rtrim(e,t),t)}function ltrim(e,t){return t=t||"\\s",e.replace(new RegExp("^["+t+"]+","g"),"")}function rtrim(e,t){return t=t||"\\s",e.replace(new RegExp("["+t+"]+$","g"),"")}function addOnloadEvent(e){if("undefined"!=typeof window.addEventListener)window.addEventListener("load",e,!1);else if("undefined"!=typeof window.attachEvent)window.attachEvent("onload",e);else if(null!=window.onload){var t=window.onload;window.onload=function(n){t(n),window[e]()}}else window.onload=e}var VERSION="DSM120926",DSM={},Cosmic=DSM;DSM.DEBUG=!1,DSM.APIv1=!1,DSM.SSL=!1,DSM.nodeId="server",DSM.ADDRESS_DELIMTER="\\",DSM.autoCommit=!0,"undefined"!=typeof Trap&&(Trap.Logger.appender._info=Trap.Logger.appender._warn=Trap.Logger.appender._error=function(){}),DSM.DataSyncClient=function(e,t){var n=null,r=this,i=null,o=-1,a=t;void 0==a&&(a=!1),null!=e&&(n=e),this.remoteAddress=null,this.localAddress=null,this.storage=null,this.transport=null,this.remoteupdate=null,this.update=null,this.isReady=!1,this.started=!1,this.__defineGetter__("ready",function(){return i}),this.__defineSetter__("ready",function(e){i=e,this.isReady&&e instanceof Function&&e(r)}),this.init=function(){if(this.stateSpaces=new DSM.Hash,this.states=new DSM.Hash,this.commitQueue=new DSM.Queue,null==this.transport)throw logFailure("DataSyncClient","init","no transport specified"),"no transport specified";if(null==this.storage)throw logFailure("DataSyncClient","init","no storage specified"),"no storage specified";this.localAddress=this.transport.localAddress,null!=n&&this.storage.replace(n);var e=function(e){var t=new DSM.MessageArray;t.parse(e),t.forEachMessage(function(t){logInfo("DataSyncClient","messageListener","got a message ["+e+"] from "+t.fromAddress);var o=t.operation,a=!1;switch(o.type){case DSM.Operation.EXCEPTION:throw o.item;case DSM.Operation.DEL:case DSM.Operation.ADD:case DSM.Operation.SET:case DSM.Operation.CLEAR:r.processRemoteMessage(t);break;case DSM.Operation.NOP:break;case DSM.Operation.MESSAGE:null!=r.remoteupdate&&r.remoteupdate instanceof Function&&r.remoteupdate(o);break;case DSM.Operation.PURGE:var s=t.oldState,l=r.stateSpaces.get(t.fromAddress);l.clearIntervall(s.client,s.server);break;case DSM.Operation.PING:break;case DSM.Operation.CONNECT:var p=o.item;if(null==p)throw logFailure("DataSyncClient","messageListener","invalid item"),"invalid item";if(null==n){r.storage.clear();for(var c=JSON.parse(p),d=0;d<c.length;d++){var u=c[d].key,S=c[d].value,o=new DSM.Operation(DSM.Operation.SET,u,S);r.updateStorage(o,r.storage,!1)}}r.isReady=!0,null!=i&&i instanceof Function&&(logInfo("DataSyncClient","messageListener","data sync client is now ready and cloned, "+r.transport.localAddress),i(r));break;default:a=!0}if(a)throw logFailure("DataSyncClient","messageListener","invalid operation type "+o.type),"invalid operation type "+o.type})};logInfo("DataSyncClient","init","setting onRecive on transport"),this.transport.onReceive=e},this.keepAlive=function(){var e=new DSM.Operation(DSM.Operation.PING,0,""),t=r.states.get(r.remoteAddress),n=new DSM.Message(r.remoteAddress,r.transport.localAddress,e,t.clone(),t.clone()),i=new DSM.MessageArray;i.append(n);try{r.transport.send(i)}catch(a){logFailure("DataSyncClient","keepAlive","transport failure"),clearInterval(o)}},this.processRemoteMessage=function(e){var t=this.states.get(this.remoteAddress),n=t.clone(),i=DSM.OT.process(e,this.states,this.stateSpaces,!1,this.transport.localAddress,a);if(null==i)throw logFailure("DataSyncClient","processRemoteMessage","invalid operation type "+operation.type),"invalid operation type "+operation.type;var o=i.transformedOperation;if(this.updateStorage(o,this.storage,!0),DSM.DEBUG){var s="",l=i.fullLog;null!=l&&(s=s.concat("\n"),s=s.concat(l),s=s.concat("\n")),s=s.concat("client:"+this.transport.localAddress+" "+n+"->"+t+" R "+i.log+" from server:"+e.fromAddress+" "+e.oldState+"->"+e.newState+" ==> "+this.storage.toString())}i.transformationRequired||(stateSpace=this.stateSpaces.get(e.fromAddress),stateSpace.clear(),DSM.DEBUG&&(s=s.concat("\nclient@"+this.transport.localAddress+" "+t+"->"+t+" state space purged"))),DSM.DEBUG&&logInfo("DataSyncClient","",s),null!=r.remoteupdate&&r.remoteupdate instanceof Function?(r.remoteupdate(o),logInfo("DataSyncClient","processRemoteMessage","notifying remoteupdate listener for "+r.transport.localAddress)):logInfo("DataSyncClient","processRemoteMessage","remoteupdate listener not found")},this.connect=function(e,t){if(null==e)throw logFailure("DataSyncClient","connect","invalid address "+e),"invalid remote address "+e;this.remoteAddress=e,null!=t&&(i=t)},this.start=function(){if(this.started&&logFailure("DataSyncClient","start","already started"),null==this.remoteAddress)throw logFailure("DataSyncClient","start","remote address not set, call the connect method first"),"remote address not set, call the connect method first";this.stateSpaces.set(this.remoteAddress,new DSM.StateSpace);var e=new DSM.State(0,0);this.states.set(this.remoteAddress,e);var t=new DSM.Operation(DSM.Operation.CONNECT,0,this.storage.toJSONString()),n=new DSM.Message(this.remoteAddress,this.transport.localAddress,t,e,e),r=new DSM.MessageArray;r.append(n),this.transport.send(r),this.started=!0},this.disconnect=function(){if(!this.started)throw logFailure("DataSyncClient","disconnect","already disconnected"),"dsm already disconnected";if(!this.isReady)throw logFailure("DataSyncClient","disconnect","disconnect can only be called when dsm is ready"),"disconnect cannot be called if the dsm is not ready (i.e. connected)";if(null==this.remoteAddress)throw logFailure("DataSyncClient","disconnect","remote address not set, call the connect method first"),"remote address not set, call the connect method first";var e=r.states.get(this.remoteAddress),t=new DSM.Operation(DSM.Operation.DEREGISTER,0,""),n=new DSM.Message(this.remoteAddress,this.transport.localAddress,t,e,e),i=new DSM.MessageArray;i.append(n),this.transport.send(i),this.started=!1,this.update=null,this.remoteupdate=null,this.ready=null,this.transport.stop(),this.transport.onReceive=null,this.transport=null,r=null},this.forEachItem=function(e){this.storage.forEachValue(e)},this.forEachValue=function(e){this.storage.forEachValue(e)},this.forEachKey=function(e){this.storage.forEachKey(e)},this.forEachIndex=function(e){this.storage.forEachKey(e)},this.toJSON=function(){return this.storage.toJSON()},this.del=function(e){var t=this.storage.getItem(e),n=new DSM.Operation(DSM.Operation.DEL,e,t);this.apply(n)},this.get=function(e){return this.storage.getItem(e)},this.add=function(e,t){if(a)throw logFailure("DataSyncClient","add","add operation not supported on hashes"),"add operation not supported on hashes";var n=new DSM.Operation(DSM.Operation.ADD,e,String(t));this.apply(n)},this.post=function(e){var t=new DSM.Operation(DSM.Operation.MESSAGE,0,String(e)),e=new DSM.Message(r.remoteAddress,r.transport.localAddress,t,new DSM.State(0,0),new DSM.State(0,0)),n=new DSM.MessageArray;n.append(e),this.transport.send(n)},this.append=function(e){if(a)throw logFailure("DataSyncClient","append","append operation not supported on hashes"),"append operation not supported on hashes";this.add(this.storage.size(),e)},this.put=function(e,t,n){this.set(e,t,n)},this.set=function(e,t,n){if(a){if(void 0!=n)var r=new DSM.Operation(DSM.Operation.SET,e+"",String(t),n);else var r=new DSM.Operation(DSM.Operation.SET,e+"",String(t));this.apply(r)}else{if(void 0!=n)throw"ttl attribute not supported on lists";var r=new DSM.Operation(DSM.Operation.SET,e,String(t));this.apply(r)}},this.clear=function(){var e=new DSM.Operation(DSM.Operation.CLEAR);this.apply(e)},this.size=function(){return this.storage.size()},this.commit=function(){for(var e=new DSM.MessageArray;this.commitQueue.size()>0;){var t=this.commitQueue.pop();e.append(t)}var n=new DSM.Operation(DSM.Operation.FLUSH,0,""),i=r.states.get(r.remoteAddress);null==i&&(i=new DSM.State(0,0));var o=new DSM.Message(r.remoteAddress,r.transport.localAddress,n,i.clone(),i.clone());e.append(o),this.transport.send(e)},this.toString=function(){return this.storage.toString()},this.isHash=function(){return a},this.updateStorage=function(e,t,n){var i=!1;switch(e.type){case DSM.Operation.DEL:t.delItem(e.pos);break;case DSM.Operation.ADD:t.addItem(e.pos,e.item);break;case DSM.Operation.SET:t.setItem(e.pos,e.item);break;case DSM.Operation.CLEAR:t.clear();break;case DSM.Operation.NOP:break;case DSM.Operation.CONNECT:break;default:i=!0}if(i)throw logFailure("DataSyncClient","updateStorage","invalid operation type "+e.type),"invalid operation type "+e.type;this.isReady&&null!=r.update&&r.update instanceof Function&&r.update(e,n)},this.apply=function(e){if(!this.isReady)return void this.updateStorage(e,r.storage,!1);if(null==r.remoteAddress||void 0==r.remoteAddress)throw logFailure("DataSyncClient","apply","invalid remoteAddress"),"invalid remoteAddress";var t=r.states.get(r.remoteAddress);if(null==t||void 0==t)throw logFailure("DataSyncClient","apply","invalid newState"),"invalid newState";var n=t.clone(),i=r.stateSpaces.get(r.remoteAddress);if(null==i)throw logFailure("DataSyncClient","apply","invalid stateSpace"),"invalid stateSpace";var o=i.get(n.client,n.server);if(null==o)throw logFailure("DataSyncClient","apply","invalid state"),"invalid state";var a=o.opPair;if(null==a)throw logFailure("DataSyncClient","apply","invalid opPair"),"invalid opPair";a.clientOperation=e,this.updateStorage(e,r.storage,!1),t.client++,DSM.DEBUG&&logInfo("DataSyncClient","apply","client:"+r.transport.localAddress+" "+n+"->"+t+" local commit "+e+" ==> "+r.storage.toString());var s=new DSM.Message(r.remoteAddress,r.transport.localAddress,e,o.clone(),t.clone());r.commitQueue.push(s)}},DSM.DataSyncServer=function(e){var t=null,n=this;null!=e&&(t=e),this.storage=null,this.transport=null,this.init=function(){if(this.stateSpaces=new DSM.Hash,this.states=new DSM.Hash,this.clients=new Array,null==this.transport)throw logFailure("DataSyncServer","init","no transport specified"),"no transport specified";if(null==this.storage)throw logFailure("DataSyncServer","init","no storage specified"),"no storage specified";null!=t&&this.storage.replace(t);var e=function(e){var t=new DSM.MessageArray;t.parse(e),t.forEachMessage(function(e){var t=e.operation,i=!1;switch(t.type){case DSM.Operation.PING:logInfo("DataSyncServer","messageListener","got a ping, do not forward");break;case DSM.Operation.DEL:case DSM.Operation.ADD:case DSM.Operation.SET:case DSM.Operation.CLEAR:var a=o(e);a.type!=DSM.Operation.NOP&&r(a,e.fromAddress);break;case DSM.Operation.NOP:break;case DSM.Operation.PURGE:consol.log("got a purge");var s=e.oldState,l=n.stateSpaces.get(e.fromAddress);l.clearIntervall(s.client,s.server);break;case DSM.Operation.FLUSH:break;case DSM.Operation.CONNECT:var p=e.fromAddress;if(void 0==n.clients)throw logFailure("DataSyncServer","messageListener","clients is undefined"),"clients is undefined";n.clients.push(p);var c=new DSM.StateSpace;n.stateSpaces.set(p,c);var d=new DSM.State(0,0);n.states.set(p,d),cloneOperation=new DSM.Operation(DSM.Operation.CONNECT,0,n.storage.toJSONString());var u=new DSM.Message(e.fromAddress,n.transport.localAddress,cloneOperation,d,d),S=new DSM.MessageArray;S.append(u),n.transport.send(S);break;default:i=!0}if(i)throw logFailure("DataSyncServer","messageListener","invalid operation type "+t.type),"invalid operation type "+t.type})};this.transport.onReceive=e},this.toString=function(){return this.storage.toString()};var r=function(e,t){for(var r,i=0;i<n.clients.length;i++){var r=n.clients[i];if(r!=t){var o=n.states.get(r),a=o.clone(),s=n.stateSpaces.get(r);if(null==s||void 0==s)throw logFailure("DataSyncServer","forward","invalid stateSpace"),"invalid stateSpace";var l=s.get(a.client,a.server);if(null==l)throw logFailure("DataSyncServer","forward","state is null"),"state is null";var p=l.opPair;if(null==p)throw logFailure("DataSyncServer","forward","opPair is null"),"opPair is null";p.serverOperation=e,o.server++;var c=new DSM.Message(r,n.transport.localAddress,e,a,o),d=new DSM.MessageArray;d.append(c),n.transport.send(d)}}},i=function(e,t){var n=!1;switch(e.type){case DSM.Operation.DEL:t.delItem(e.pos);break;case DSM.Operation.ADD:t.addItem(e.pos,e.item);break;case DSM.Operation.SET:t.setItem(e.pos,e.item);break;case DSM.Operation.CLEAR:t.clear();break;case DSM.Operation.NOP:break;case DSM.Operation.CONNECT:break;default:n=!0}if(n)throw logFailure("DataSyncServer","update","invalid operation ["+e+"]"),"invalid operation ["+e+"]"},o=function(e){if(null==e)throw logFailure("DataSyncServer","commit","invalid message"),"invalid message";var t=e.fromAddress;if(null==t)throw logFailure("DataSyncServer","commit","invalid from address"),"invalid from address";var r=n.states.get(t);if(null==r)throw logFailure("DataSyncServer","commit","invalid newState, from="+t+" this problem caused by an address already in use problem"),"invalid newState, from="+t+" this problem caused by an address already in use problem";var o=r.clone();if(null==o)throw logFailure("DataSyncServer","commit","failed to clone oldState"),"failed to clone oldState";var a=DSM.OT.process(e,n.states,n.stateSpaces,!0,n.transport.localAddress,!1),s=a.transformedOperation;i(s,n.storage);var l="",p=a.fullLog;if(null!=p&&(l=l.concat("\n"),l=l.concat(p),l=l.concat("\n")),l=l.concat("server@"+e.fromAddress+" "+o+"->"+r+" R "+a.log+" from client:"+e.fromAddress+" "+e.oldState+"->"+e.newState+" ==> "+n.storage.toString()),!a.transformationRequired){var c=n.stateSpaces.get(e.fromAddress);c.clear(),l=l.concat("\nserver@"+e.fromAddress+" "+r+"->"+r+" state space purged")}return s}},DSM.Hash=function(){this.length=0,this.items=new Object;for(var e=0;e<arguments.length;e+=2)"undefined"!=typeof arguments[e+1]&&(this.items[arguments[e]]=arguments[e+1],this.length++);this.remove=function(e){var t;if("undefined"!=typeof this.items[e]){this.length--;var t=this.items[e];delete this.items[e]}return t},this.get=function(e){return this.items[e]},this.set=function(e,t){var n;return"undefined"!=typeof t&&("undefined"==typeof this.items[e]?this.length++:n=this.items[e],this.items[e]=t),n},this.has=function(e){return"undefined"!=typeof this.items[e]},this.clear=function(){for(var e in this.items)delete this.items[e];this.length=0},this.forEachKey=function(e){for(var t in this.items)e(t)},this.toString=function(){console.log(this.items)}},DSM.MemoryController=function(e){var t=e,n=this,r=0;DSM.APIv1&&(this.get=function(e){return n.clone(e)},this.clone=function(e){console.log("DEPRECATED, calling memCtrl.clone("+e+")");var n,r=!1;e.match("^hash")?(n=new DSM.HashReplica(null),r=!0):n=new DSM.ListReplica(null);var i=new DSM.DataSyncClient(null,r);n.attach(i,null);var o=null;return o=new DSM.Transport(t),i.transport=o,r?i.storage=new DSM.Storage(!0):i.storage=new DSM.Storage(!1),i.init(),o.start(),i.connect(e),i.configured=!0,i.start(),n}),this.connect=function(e,n,r){var i=!1;e instanceof DSM.HashReplica&&(i=!0);var o=new DSM.DataSyncClient(null,i);e.attach(o,r);var a=null;a=new DSM.Transport(t),o.transport=a,i?o.storage=new DSM.Storage(!0):o.storage=new DSM.Storage(!1),o.init(),a.start(),o.connect(n),o.configured=!0,o.start()},this.connectClient=function(e,n){var r=!1;e.match("^hash")&&(r=!0);var i=new DSM.DataSyncClient(null,r),o=null;return o=new DSM.Transport(t),i.transport=o,r?i.storage=new DSM.Storage(!0):i.storage=new DSM.Storage(!1),i.init(),o.start(),i.connect(e),i.configured=!0,i.start(),i},this.generateUniqueKey=function(){return DSM.hashCode(t.nodeId+new String(Math.floor(15e4*Math.random())))},this.generateUniqueKeyShort=function(){return DSM.hashCode(t.nodeId+r++)}},DSM.Message=function(e,t,n,r,i){this.toAddress=null,this.fromAddress=null,this.operation=null,this.oldState=null,this.newState=null,void 0!=e&&(this.toAddress=e),void 0!=t&&(this.fromAddress=t),void 0!=n&&(this.operation=n),void 0!=r&&(this.oldState=r),void 0!=i&&(this.newState=i)},DSM.MessageArray=function(){var e=new Array;this.parse=function(e){for(var t=JSON.parse(e),n=0;n<t.length;n++){var r=t[n],i=Base64.decode(r.to),o=Base64.decode(r.from),a=r.op,s=a.type,l=a.pos,p=a.item,c=a.ttl,d=new DSM.Operation;d.type=s,d.pos=Base64.decode(l),d.item=Base64.decode(p),d.ttl=c;var u=r.os,S=u.c,f=u.s,h=new DSM.State;h.client=S,h.server=f;var D=r.ns,M=D.c,O=D.s,m=new DSM.State;m.client=M,m.server=O;var g=new DSM.Message;g.toAddress=i,g.fromAddress=o,g.operation=d,g.oldState=h,g.newState=m,this.append(g)}},this.append=function(t){e.splice(e.length,0,t)},this.firstMessage=function(){return 0==e.length?null:e[0]},this.toJSON=function(){for(var t=[],n=0;n<e.length;n++){var r=e[n],i={};i.to=Base64.encode(r.toAddress),i.from=Base64.encode(r.fromAddress);var o=(Base64.decode(i.from),{});o.type=r.operation.type,o.pos=Base64.encode(r.operation.pos+""),o.item=Base64.encode(r.operation.item),o.ttl=r.operation.ttl,i.op=o;var a={};a.c=r.oldState.client,a.s=r.oldState.server,i.os=a;var s={};s.c=r.newState.client,s.s=r.newState.server,i.ns=s,t[n]=i}var l=JSON.stringify(t);return l},this.forEachMessage=function(t){for(var n in e)e.hasOwnProperty(n)&&t(e[n])}},DSM.Operation=function(e,t,n,r){this._type=DSM.Operation.UNKOWN,this._pos=-1,this._item="",this._ttl=-1,void 0!=e&&(this._type=e),void 0!=t&&(this._pos=t),void 0!=n&&(this._item=n),void 0!=r&&(this._ttl=r),this.__defineGetter__("type",function(){return parseInt(this._type)}),this.__defineSetter__("type",function(e){this._type=e}),this.__defineGetter__("pos",function(){return this._pos}),this.__defineSetter__("pos",function(e){this._pos=e}),this.__defineGetter__("index",function(){return this._pos}),this.__defineSetter__("index",function(e){this._pos=e}),this.__defineGetter__("item",function(){return this._item}),this.__defineSetter__("item",function(e){this._item=e}),this.__defineGetter__("ttl",function(){return this._ttl}),this.__defineSetter__("ttl",function(e){this._ttl=e}),this.__defineGetter__("key",function(){return this._pos}),this.__defineSetter__("key",function(e){this._pos=e}),this.__defineGetter__("value",function(){return this._item}),this.__defineSetter__("value",function(e){this._item=e}),this.toString=function(){var e="";switch(this._type){case DSM.Operation.DEL:e="DEL";break;case DSM.Operation.ADD:e="ADD";break;case DSM.Operation.SET:e="SET";break;case DSM.Operation.NOP:e="NOP";break;case DSM.Operation.CLEAR:e="CLEAR";break;case DSM.Operation.CONNECT:e="CONNECT";break;case DSM.Operation.REGISTER:e="REGISTER";break;case DSM.Operation.PING:e="PING";break;case DSM.Operation.FLUSH:e="FLUSH";break;case DSM.Operation.EXCEPTION:e="EXCEPTION";break;case DSM.Operation.PURGE:e="PURGE";break;case DSM.Operation.MESSAGE:e="MESSAGE";break;default:e="UNKOWN"}return null==this._item?-1==this._pos?e:e+"("+this._pos+")":e+"("+this._pos+","+this._item+")"},this.clone=function(){var e=DSM.clone(this);return e},this.equals=function(e){return!e instanceof DSM.Operation?!1:this._type!=e.type?!1:this._pos!=e.pos?!1:this._item!=e.item?!1:this._ttl!=e.ttl?!1:!0}},DSM.Operation.__defineGetter__("DEL",function(){return 0}),DSM.Operation.__defineGetter__("ADD",function(){return 1}),DSM.Operation.__defineGetter__("SET",function(){return 2}),DSM.Operation.__defineGetter__("PUT",function(){return 2}),DSM.Operation.__defineGetter__("NOP",function(){return 3}),DSM.Operation.__defineGetter__("CLEAR",function(){return 4}),DSM.Operation.__defineGetter__("CONNECT",function(){return 5}),DSM.Operation.__defineGetter__("DEREGISTER",function(){return 6}),DSM.Operation.__defineGetter__("REGISTER",function(){return 7}),DSM.Operation.__defineGetter__("PING",function(){return 8}),DSM.Operation.__defineGetter__("FLUSH",function(){return 9}),DSM.Operation.__defineGetter__("EXCEPTION",function(){return 10}),DSM.Operation.__defineGetter__("PURGE",function(){return 11}),DSM.Operation.__defineGetter__("MESSAGE",function(){return 12}),DSM.OperationPair=function(e,t){this.clientOperation=null,this.serverOperation=null,void 0!=e&&(this.clientOperation=e),void 0!=t&&(this.serverOperation=t),this.clone=function(){var e=DSM.clone(this);return e},this.toString=function(){return"("+this.clientOperation+", "+this.serverOperation+")"},this.equals=function(e){return!e instanceof DSM.OperationPair?!1:this.clientOperation.equals(e.clientOperation)&&this.serverOperation.equals(e.serverOperation)?!0:!1}},DSM.Queue=function(){var e=[],t=0;this.size=function(){return e.length-t},this.isEmpty=function(){return 0==e.length},this.push=function(t){e.push(t)},this.pop=function(){var n=void 0;return e.length&&(n=e[t],2*++t>=e.length&&(e=e.slice(t),t=0)),n}},DSM.OT=function(){DSM.OT.process=function(e,t,n,r,i,o){var a=e.fromAddress,s=e.operation;o||(s.pos=parseInt(s.pos));var l=t.get(a),p=l.clone(),c="'",d=e.oldState;if(null==d||void 0==d)throw logFailure("OT","process","invalid remote old state"),"invalid remote old state";var u=e.newState;if(null==u||void 0==u)throw logFailure("OT","process","invalid remote new state"),"invalid remote new state";var S=n.get(a);if(null==S||void 0==S)throw logFailure("OT","process","invalid stateSpace"),"invalid stateSpace";var f=S.get(d.client,d.server),h=f.opPair;if((null==h||void 0==h)&&logFailure("OT","process","invalid opPair"),r?h.clientOperation=s.clone():h.serverOperation=s.clone(),e.oldState.equals(l))return r?l.client++:l.server++,new DSM.XFormResult(s,s.toString(),null,!1);r?l.client++:l.server++;var D=0;if(D=r?l.server-u.server:l.client-u.client,0==D)throw logFailure("OT","process","invalid number of operation calculations, localNewState="+l+", remoteNewState="+u+", operation="+s),"invalid number of operation calculations";for(var M=s,O=s,m=s.toString(),g="",w=0;D>w;w++){var v=-1,y=-1;r?(v=p.client,y=p.server-D+w):(v=p.client-D+w,y=p.server);var _=S.get(v,y);if(null==_||void 0==_)throw logFailure("OT","process","invalid state"),"invalid state";var E=_.opPair;if(null==E||void 0==E)throw logFailure("OT","process","invalid operation pair"),"invalid operation pair";var A=E.clientOperation;if(null==A||void 0==A)throw logFailure("OT","process","invalid client operation, clientOperation="+A),"invalid client operation, clientOperation="+A;var C=E.serverOperation;if(null==C||void 0==C)throw logFailure("OT","process","invalid server operation, serverOperation="+C),"invalid server operation, serverOperation="+C;g=g.concat("  "+i+" c"+v+","+y+"="+A+"\n"),g=g.concat("  "+i+" s"+v+","+y+"="+C+"\n");var P;if(P=o?DSM.XHashFormer.xform(E):DSM.XListFormer.xform(E),null==P||void 0==P)throw logFailure("OT","process","invalid transformed operation pair"),"invalid transformed operation pair";var T=S.get(v+1,y);if(null==T||void 0==T)throw logFailure("OT","process","invalid next client state"),"invalid next client state";var R=S.get(v,y+1);if(null==R||void 0==R)throw logFailure("OT","process","invalid next server state"),"invalid next server state";var N=T.opPair;if(null==N||void 0==N)throw logFailure("OT","process","invalid next client state operation pair"),"invalid next client state operation pair";var F=R.opPair;if(null==F||void 0==F)throw logFailure("OT","process","invalid next server state operation pair"),"invalid next server state operation pair";N.serverOperation=P.serverOperation.clone(),F.clientOperation=P.clientOperation.clone(),g=g.concat("  "+i+" c"+c+T.client+","+T.server+"="+P.clientOperation+"\n"),g=g.concat("  "+i+" s"+c+R.client+","+R.server+"="+P.serverOperation+"\n"),M=P.clientOperation,O=P.serverOperation,m+=r?"->"+M:"->"+O}return r?new DSM.XFormResult(M,m.toString(),g.toString(),!0):new DSM.XFormResult(O,m.toString(),g.toString(),!0)}},new DSM.OT,DSM.State=function(e,t){this.opPair=new DSM.OperationPair,this.client=0,this.server=0,void 0!=e&&(this.client=e),void 0!=t&&(this.server=t),this.clone=function(){return DSM.clone(this)},this.toString=function(){return"("+this.client+","+this.server+")"},this.equals=function(e){return!e instanceof DSM.Operation?!1:this.client!=e.client?!1:this.server!=e.server?!1:!0}},DSM.StateSpace=function(){var e=new DSM.Hash,t=[];this.get=function(n,r){var i=n+","+r;if(e.has(i))return e.get(i);var o=new DSM.State(n,r);return e.set(i,o),t.push(i),o},this.clear=function(){e.clear(),t=[]},this.clearIntervall=function(n,r){var i,o,a=n+","+r;for(i=0;i<t.length&&(o=t[i],o!=a);i++)e.remove(o);i>0&&i<t.length&&(t=t.splice(i))},this.size=function(){return e.length}},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},DSM.assertNull=function(e,t){if((void 0==t||null==t)&&(t="error, assertNull failed"),void 0==e)throw t;if(null!=e)throw t},DSM.assertNotNull=function(e,t){if((void 0==t||null==t)&&(t="error, assertNotNull failed"),void 0==e)throw t;if(null==e)throw t},DSM.assertFalse=function(e,t){if((void 0==t||null==t)&&(t="error, assertFalse failed"),void 0==e||null==e)throw t;if(0!=e)throw t},DSM.assertTrue=function(e,t){if((void 0==t||null==t)&&(t="error, assertTrue failed"),void 0==e||null==e)throw t;if(1!=e)throw t},DSM.assert=function(e,t,n,r){DSM.DEBUG&&("undefined"==typeof e?logFailure(n,r,t+" is undefined"):null==e?logFailure(n,r,t+" is null"):logInfo(n,r,t+" is OK"))},DSM.clone=function(e){if(null==e||"object"!=typeof e)return e;if(e.constructor==Array){for(var t=[],n=0;n<e.length;n++)"object"==typeof e[n]?t.push(clone(e[n])):t.push(e[n]);return t}var t={};for(var r in e)t[r]=DSM.clone(e[r]);return t},DSM.hashCode=function(e){var t,n=Math.pow(2,-32),r=2095533,i=0,o=1,a=0,s=2147483547;e=e.toString();for(var l=0;l<e.length;l++)i-=65537*e.charCodeAt(l)*n,0>i&&(i+=1),t=r*i+o*n,a=i=t-(o=0|t),t=r*i+o*n,i=t-(o=0|t);return s?Math.floor(s*(i+a*n)):i+a*n},DSM.Storage=function(e){var t=new Array,n=e;this.replace=function(e){t=t.concat(e)},this.addItem=function(e,n){t.splice(e,0,n)},this.delItem=function(e){n?delete t[e]:t.splice(e,1)},this.setItem=function(e,n){t[e]=n},this.getItem=function(e){return t[e]},this.size=function(){var e=0;for(var n in t)t.hasOwnProperty(n)&&e++;return e},this.contains=function(e){var n=t[e];return void 0==n?!1:!0},this.clear=function(){t=new Array},this.toJSON=function(){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push({key:n,value:t[n]});return e},this.toJSONString=function(){return JSON.stringify(this.toJSON())},this.toString=function(){var e=new String;for(var n in t)t.hasOwnProperty(n)&&(e+=t[n]);return e},this.forEachValue=function(e){for(var n in t)t.hasOwnProperty(n)&&e(t[n])},this.forEachKey=function(e){for(var n in t)t.hasOwnProperty(n)&&e(n)}},DSM.TrapBusSimple=function(e,t,n){function r(e){if(!DSM.debug_lost_downlink){var t=new DSM.MessageArray;t.parse(e);var n=t.firstMessage(),r=s.get(n.toAddress);null!=r||r instanceof Function?r(e):logInfo("TrapBusSimple","forward","invalid listener")}}var i=null,o=!1,a=null,s=new DSM.Hash,l=null,p=0;this.__defineGetter__("nodeId",function(){return l}),this.__defineGetter__("onConfigured",function(){return a}),this.__defineSetter__("onConfigured",function(e){a=e,o&&e instanceof Function&&e()}),n?(logInfo("TrapBusSimple","contructor","config="+JSON.stringify(n)),i=new Trap.ClientEndpoint(n,!1)):(logInfo("TrapBusSimple","constructor","host="+e),i=DSM.SSL?new Trap.ClientEndpoint("trap.transport.http.url = https://"+e+":"+(parseInt(t)+3)+"/\ntrap.transport.websocket.wsuri = wss://"+e+":"+(parseInt(t)+4)+"/ws",!1):new Trap.ClientEndpoint("trap.transport.http.url = http://"+e+":"+t+"/\ntrap.transport.websocket.wsuri = ws://"+e+":"+(parseInt(t)+1)+"/ws",!1)),i.onstatechange=function(e){logInfo("TrapBusSimple","cte.onstatechange","New state: "+e.newState),e.newState==Trap.Endpoint.State.OPEN&&null==l&&(n&&n.preamble&&i.send(n.preamble),logInfo("TrapBusSimple","cte.onstatechange","requesting nodeid"),i.send("getClientNodeId"))},i.onmessage=function(e){logInfo("TrapBusSimple","ctr.onmessage","message: "+e.string),null==l?(l=e.string.trim(),logInfo("TrapBusSimple","onread","assigned node id <"+l+">"),o=!0,setTimeout(a,0)):r(e.string)},this.close=function(){i.close()},this.send=function(e){DSM.assert(i,"cte","TrapBusSimple","send"),DSM.assert(e,"messageArray","TrapBusSimple","send"),i.send(e)},this.register=function(e){var t="client:"+l+"."+p++;return s.set(t,e),t},this.deregister=function(e){s.remove(e)}},DSM.MsrpBus=function(e,t,n){function r(e){l&&(p.push(e),logInfo("MsrpBus","sendmessage","added message to queue - queue.length: "+p.length),1==p.length&&(c=l.send(p[0]),logInfo("MsrpBus","sendmessage","session.send message id: "+c+" while queue.length: "+p.length)))}function i(e){logInfo("MsrpBus","onsent","message id: "+e.messageId),e.messageId===c?(p.shift(),logInfo("MsrpBus","onsent","removed message from queue - queue.length: "+p.length),p.length>0?l&&(c=l.send(p[0]),logInfo("MsrpBus","onsent","session.send message id: "+c+" while queue.length: "+p.length)):c=null):logWarning("MsrpBus","onsent","ignoring onsent event with message id: "+e.messageId+" - this message is not being sent!")}function o(e){null==f?(f=e.trim(),logInfo("MsrpBus","onmessage","got configReady nodeId="+f),logInfo("MsrpBus","onmessage","assigned node id <"+f+">"),d=!0,setTimeout(u,0)):a(e)}function a(e){var t=new DSM.MessageArray;t.parse(e);var n=t.firstMessage(),r=S.get(n.toAddress);null!=r||r instanceof Function?r(e):logInfo("MsrpBus","forward","invalid listener")}var s=n.endpoint,l=null,p=[],c=null,d=!1,u=null,S=new DSM.Hash,f=null,h=0;this.__defineGetter__("nodeId",function(){return f}),this.__defineGetter__("onConfigured",function(){return u}),this.__defineSetter__("onConfigured",function(e){u=e,d&&e instanceof Function&&e()}),logInfo("MsrpBus","new","host="+e),s.onopen=function(e){},s.onconnect=function(e){logInfo("MsrpBus","endpoint.onconnect",JSON.stringify(e)),l=s.createMsrpSession(n.localUri,n.remoteUri,n.initiator,function(e){}),l.setAcceptedContentTypes([{type:"application/dsm",text:!0}]),l.onsessionready=function(e){logInfo("MsrpBus","session.onsessionready",JSON.stringify(e)),p=[],c=null,r({msg:"getClientNodeId",type:"application/dsm"})},l.onmessage=function(e){if(e.data)o(e.data);else if(e.blob){var t=new FileReader;t.onload=function(e){o(t.result)},t.readAsText(e.blob)}},l.onerror=function(e){logFailure("MsrpBus","session.onerror",JSON.stringify(e)),l=null},l.onready=i,l.onprogress=l.onabort=function(){}},s.onclose=function(e){logInfo("MsrpBus","endpoint.onclose",JSON.stringify(e)),l=null},s.onerror=function(e){logFailure("MsrpBus","endpoint.onerror",JSON.stringify(e)),l=null},n.initiator&&s.connect(n.remoteAddrPort),this.close=function(){s.close()},this.send=function(e){DSM.assert(l,"session","MsrpBus","send"),DSM.assert(e,"messageArray","MsrpBus","send"),r({msg:e,type:"application/dsm"})},this.register=function(e){var t="client:"+f+"."+h++;return S.set(t,e),t},this.deregister=function(e){S.remove(e)}},DSM.SocketIOBus=function(e,t){function n(e){var t=new DSM.MessageArray;t.parse(e);var n=t.firstMessage(),r=a.get(n.toAddress);null!=r||r instanceof Function?r(e):logInfo("SocketIOBus","forward","invalid listener")}var r=null,i=!1,o=null,a=new DSM.Hash,s=null,l=0;this.__defineGetter__("nodeId",function(){return s}),this.__defineGetter__("onConfigured",function(){return o}),this.__defineSetter__("onConfigured",function(e){o=e,i&&e instanceof Function&&e()}),console.log("host="+e),r=io.connect("http://"+e+":"+t),r.on("connect",function(){console.log("socket.on('connect')"),r.send("getClientNodeId")}),r.on("message",function(e){null==s?(s=e.trim(),
logInfo("SocketIOBus","onread","assigned node id <"+s+">"),console.log("SocketIOBus got configReady nodeId="+s),i=!0,setTimeout(o,0)):n(e)}),this.close=function(){r.close()},this.send=function(e){DSM.assert(r,"socket","SocketIOBus","send"),DSM.assert(e,"messageArray","SocketIOBus","send"),r.send(e)},this.register=function(e){var t="client:"+s+"."+l++;return a.set(t,e),t},this.deregister=function(e){a.remove(e)}},DSM.TransportBus=DSM.TrapBusSimple,DSM.Transport=function(e){var t=null;this.localAddress=null,this.__defineGetter__("onReceive",function(){return t}),this.__defineSetter__("onReceive",function(e){t=e}),this.start=function(){null==e&&logFailure("Transport","init","invalid bus"),this.localAddress=e.register(t)},this.send=function(t){logInfo("Transport","send","sending message <"+t.toJSON()+">"),e.send(t.toJSON())},this.stop=function(){e.deregister(this.localAddress)}};var connectedClients=new DSM.Hash;DSM.EmulatedTransport=function(e){var t=null;this.localAddress=e,this.__defineGetter__("onReceive",function(){return t}),this.__defineSetter__("onReceive",function(e){t=e,e instanceof Function&&connectedClients.set(this.localAddress,e)}),this.send=function(e){var t=e.firstMessage(),n=t.toAddress,r=(t.fromAddress,e.toJSON()),i=connectedClients.get(n);if(void 0==i)throw logFailure("EmulatedTransport","send","listener is undefined"),"listener is undefined";if(!(i instanceof Function))throw logFailure("EmulatedTransport","send","no message listener found for address ["+n+"]"),"no message listener found for address ["+n+"]";i(r)}},DSM.XFormResult=function(e,t,n,r){this.transformedOperation=null,this.log=null,this.fullLog=null,this.transformationRequired=!1,void 0!=e&&(this.transformedOperation=e),void 0!=t&&(this.log=t),void 0!=n&&(this.fullLog=n),void 0!=r&&(this.transformationRequired=r)},DSM.XListFormer=function(){DSM.XListFormer.xform=function(e){if(null==e)throw logFailure("XListFormer","xform","invalid operation pait"),"invalid operation pair";var t=e.clientOperation,n=e.serverOperation;if(null==t)throw logFailure("XListFormer","xform","invalid client operation"),"invalid client operation";if(null==n)throw logFailure("XListFormer","xform","invalid server operation"),"invalid client operation";if(t.type==DSM.Operation.NOP)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),n.clone());if(n.type==DSM.Operation.NOP)return new DSM.OperationPair(t.clone(),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.NOP&&n.type==DSM.Operation.NOP)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.CLEAR)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.CLEAR),new DSM.Operation(DSM.Operation.NOP));if(n.type==DSM.Operation.CLEAR)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.CLEAR));if(t.type==DSM.Operation.DEL&&n.type==DSM.Operation.DEL)return t.pos>n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos-1,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item)):t.pos<n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos-1,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.ADD&&n.type==DSM.Operation.ADD)return t.pos>n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.ADD,t.pos+1,t.item),new DSM.Operation(DSM.Operation.ADD,n.pos,n.item)):t.pos<n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.ADD,t.pos,t.item),new DSM.Operation(DSM.Operation.ADD,n.pos+1,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.ADD,t.pos+1,t.item),new DSM.Operation(DSM.Operation.ADD,n.pos,n.item));if(t.type==DSM.Operation.DEL&&n.type==DSM.Operation.ADD)return t.pos>n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos+1,t.item),new DSM.Operation(DSM.Operation.ADD,n.pos,n.item)):t.pos<n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.ADD,n.pos-1,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos+1,t.item),new DSM.Operation(DSM.Operation.ADD,n.pos,n.item));if(t.type==DSM.Operation.ADD&&n.type==DSM.Operation.DEL)return t.pos>n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.ADD,t.pos-1,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item)):t.pos<n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.ADD,t.pos,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos+1,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.ADD,t.pos,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos+1,n.item));if(t.type==DSM.Operation.SET&&n.type==DSM.Operation.SET)return t.pos>n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,n.item)):t.pos<n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,t.item));if(t.type==DSM.Operation.ADD&&n.type==DSM.Operation.SET)return t.pos>n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.ADD,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,n.item)):t.pos<n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.ADD,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos+1,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.ADD,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos+1,n.item));if(t.type==DSM.Operation.SET&&n.type==DSM.Operation.ADD)return t.pos>n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos+1,t.item),new DSM.Operation(DSM.Operation.ADD,n.pos,n.item)):t.pos<n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.ADD,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos+1,t.item),new DSM.Operation(DSM.Operation.ADD,n.pos,n.item));if(t.type==DSM.Operation.DEL&&n.type==DSM.Operation.SET)return t.pos>n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,n.item)):t.pos<n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos-1,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.SET&&n.type==DSM.Operation.DEL)return t.pos>n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos-1,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item)):t.pos<n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item));throw logFailure("XListFormer","xform","did not find any matching transformation rules"),"no matching transformation rules found"}},new DSM.XListFormer,DSM.XHashFormer=function(){DSM.XHashFormer.xform=function(e){if(null==e)throw logFailure("XHashFormer","xform","invalid operation pait"),"invalid operation pair";var t=e.clientOperation,n=e.serverOperation;if(null==t)throw logFailure("XHashFormer","xform","invalid client operation"),"invalid client operation";if(null==n)throw logFailure("XHashFormer","xform","invalid server operation"),"invalid client operation";if(t.type==DSM.Operation.NOP)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),n.clone());if(n.type==DSM.Operation.NOP)return new DSM.OperationPair(t.clone(),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.NOP&&n.type==DSM.Operation.NOP)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.CLEAR)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.CLEAR),new DSM.Operation(DSM.Operation.NOP));if(n.type==DSM.Operation.CLEAR)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.CLEAR));if(t.type==DSM.Operation.DEL&&n.type==DSM.Operation.DEL)return t.pos!=n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.SET&&n.type==DSM.Operation.SET)return t.pos!=n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,t.item));if(t.type==DSM.Operation.DEL&&n.type==DSM.Operation.SET)return t.pos!=n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.SET&&n.type==DSM.Operation.DEL)return t.pos!=n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item));throw logFailure("XHashFormer","xform","did not find any matching transformation rules"),"no matching transformation rules found"}},new DSM.XHashFormer,DSM.XHashFormer=function(){DSM.XHashFormer.xform=function(e){if(null==e)throw logFailure("XHashFormer","xform","invalid operation pait"),"invalid operation pair";var t=e.clientOperation,n=e.serverOperation;if(null==t)throw logFailure("XHashFormer","xform","invalid client operation"),"invalid client operation";if(null==n)throw logFailure("XHashFormer","xform","invalid server operation"),"invalid client operation";if(t.type==DSM.Operation.NOP)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),n.clone());if(n.type==DSM.Operation.NOP)return new DSM.OperationPair(t.clone(),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.NOP&&n.type==DSM.Operation.NOP)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.CLEAR)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.CLEAR),new DSM.Operation(DSM.Operation.NOP));if(n.type==DSM.Operation.CLEAR)return new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.CLEAR));if(t.type==DSM.Operation.DEL&&n.type==DSM.Operation.DEL)return t.pos!=n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.SET&&n.type==DSM.Operation.SET)return t.pos!=n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,t.item));if(t.type==DSM.Operation.DEL&&n.type==DSM.Operation.SET)return t.pos!=n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.SET,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.DEL,t.pos,t.item),new DSM.Operation(DSM.Operation.NOP));if(t.type==DSM.Operation.SET&&n.type==DSM.Operation.DEL)return t.pos!=n.pos?new DSM.OperationPair(new DSM.Operation(DSM.Operation.SET,t.pos,t.item),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item)):new DSM.OperationPair(new DSM.Operation(DSM.Operation.NOP),new DSM.Operation(DSM.Operation.DEL,n.pos,n.item));throw logFailure("XHashFormer","xform","did not find any matching transformation rules"),"no matching transformation rules found"}},new DSM.XHashFormer;var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,n,r,i,o,a,s,l="",p=0;for(e=Base64._utf8_encode(e);p<e.length;)t=e.charCodeAt(p++),n=e.charCodeAt(p++),r=e.charCodeAt(p++),i=t>>2,o=(3&t)<<4|n>>4,a=(15&n)<<2|r>>6,s=63&r,isNaN(n)?a=s=64:isNaN(r)&&(s=64),l=l+this._keyStr.charAt(i)+this._keyStr.charAt(o)+this._keyStr.charAt(a)+this._keyStr.charAt(s);return l},decode:function(e){var t,n,r,i,o,a,s,l="",p=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");p<e.length;)i=this._keyStr.indexOf(e.charAt(p++)),o=this._keyStr.indexOf(e.charAt(p++)),a=this._keyStr.indexOf(e.charAt(p++)),s=this._keyStr.indexOf(e.charAt(p++)),t=i<<2|o>>4,n=(15&o)<<4|a>>2,r=(3&a)<<6|s,l+=String.fromCharCode(t),64!=a&&(l+=String.fromCharCode(n)),64!=s&&(l+=String.fromCharCode(r));return l=Base64._utf8_decode(l)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var r=e.charCodeAt(n);128>r?t+=String.fromCharCode(r):r>127&&2048>r?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(63&r|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(63&r|128))}return t},_utf8_decode:function(e){for(var t="",n=0,r=c1=c2=0;n<e.length;)r=e.charCodeAt(n),128>r?(t+=String.fromCharCode(r),n++):r>191&&224>r?(c2=e.charCodeAt(n+1),t+=String.fromCharCode((31&r)<<6|63&c2),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=String.fromCharCode((15&r)<<12|(63&c2)<<6|63&c3),n+=3);return t}};DSM.HashReplica=function(e){var t=new Object;t.isReady=!1;var n=e,r=null,i=null,o=this,a=null;this.isBusy=!1,this.autoCommit=DSM.autoCommit,DSM.APIv1?(this.__defineSetter__("ready",function(e){t.ready=e}),this.__defineGetter__("ready",function(){return t.ready})):(this.__defineSetter__("ready",function(e){i=e}),this.__defineGetter__("ready",function(){return i})),this.__defineGetter__("nodeParent",function(){return a}),this.__defineSetter__("update",function(e){t.update=e}),this.__defineSetter__("remoteupdate",function(e){t.remoteupdate=e}),this.__defineSetter__("unready",function(e){r=e}),this.__defineGetter__("name",function(){return n}),this.__defineGetter__("client",function(){return t}),this.__defineGetter__("remoteAddress",function(){if(!t.isReady)throw"error, hash replica not connected";return t.remoteAddress}),this.__defineGetter__("localAddress",function(){if(!t.isReady)throw"error, hash replica not connected";return t.localAddress}),this.attach=function(e,r){if(t instanceof DSM.DataSyncClient)throw"hash replica("+n+") already attached";DSM.APIv1&&(e.ready=t.ready),e.update=t.update,e.remoteupdate=t.remoteupdate,t=e,a=r},this.detach=function(e){DSM.assertNotNull(a,"error, no reference to node"),e&&a.dereferenceReplica(o),null!=r&&r instanceof Function&&r(),mockDataSyncClient=new Object,mockDataSyncClient.isReady=!1,DSM.APIv1&&(mockDataSyncClient.ready=t.ready),mockDataSyncClient.update=t.update,mockDataSyncClient.remoteupdate=t.remoteupdate,t.disconnect(),t=mockDataSyncClient,a=null},this.forEachKey=function(e){if(!t.isReady)throw"error, hash replica not connected";t.forEachKey(e)},this.forEachValue=function(e){if(!t.isReady)throw"error, hash replica not connected";t.forEachValue(e)},this.start=function(){if(!t.isReady)throw"error, hash replica not connected";t.start()},this.disconnect=function(){if(!t.isReady)throw"error, hash replica not connected";t.disconnect(),t=null},this.del=function(e){if(!t.isReady)throw"error, hash replica not connected";t.del(e),o.autoCommit&&t.commit()},this.get=function(e){if(!t.isReady)throw"error, hash replica not connected";return t.get(e)},this.set=function(e,n,r){if(!t.isReady)throw"error, hash replica not connected";t.set(e,n,r),o.autoCommit&&t.commit()},this.clear=function(){if(!t.isReady)throw"error, hash replica not connected";t.clear(),o.autoCommit&&t.commit()},this.post=function(e){if(!t.isReady)throw"error, hash replica not connected";t.post(e)},this.commit=function(){if(!t.isReady)throw"error, hash replica not connected";t.commit()},this.apply=function(e){if(!t.isReady)throw"error, hash replica not connected";t.apply(e),o.autoCommit&&t.commit()},this.size=function(){if(!t.isReady)throw"error, hash replica not connected";return t.size()},this.toString=function(){if(!t.isReady)throw"error, hash replica not connected";return t.storage.toString()},this.isHash=function(){if(!t.isReady)throw"error, hash replica not connected";return t.isHash()},this.toJSON=function(){if(!t.isReady)throw"error, hash replica not connected";return t.toJSON()}},DSM.ListReplica=function(e){var t=new Object;t.isReady=!1;var n=e,r=null,i=null,o=this,a=null;this.isBusy=!1,this.autoCommit=DSM.autoCommit,DSM.APIv1?(this.__defineSetter__("ready",function(e){t.ready=e}),this.__defineGetter__("ready",function(){return t.ready})):(this.__defineSetter__("ready",function(e){i=e}),this.__defineGetter__("ready",function(){return i})),this.__defineGetter__("nodeParent",function(){return a}),this.__defineSetter__("update",function(e){t.update=e}),this.__defineSetter__("remoteupdate",function(e){t.remoteupdate=e}),this.__defineSetter__("unready",function(e){r=e}),this.__defineGetter__("name",function(){return n}),this.__defineGetter__("client",function(){return t}),this.__defineGetter__("remoteAddress",function(){if(!t.isReady)throw"error, list replica not connected";return t.remoteAddress}),this.__defineGetter__("localAddress",function(){if(!t.isReady)throw"error, list replica not connected";return t.localAddress}),this.attach=function(e,n){if(t instanceof DSM.DataSyncClient)throw"list replica already attached";DSM.APIv1&&(e.ready=t.ready),e.update=t.update,e.remoteupdate=t.remoteupdate,t=e,a=n},this.detach=function(e){DSM.assertNotNull(a,"error, no reference to node"),e&&a.dereferenceReplica(o),null!=r&&r instanceof Function&&r(),mockDataSyncClient=new Object,mockDataSyncClient.isReady=!1,DSM.APIv1&&(mockDataSyncClient.ready=t.ready),mockDataSyncClient.update=t.update,mockDataSyncClient.remoteupdate=t.remoteupdate,t.disconnect(),t=mockDataSyncClient,a=null},this.forEachIndex=function(e){if(!t.isReady)throw"error, list replica not connected";t.forEachIndex(e)},this.forEachItem=function(e){if(!t.isReady)throw"error, list replica not connected";t.forEachItem(e)},this.start=function(){if(!t.isReady)throw"error, list replica not connected";t.start()},this.disconnect=function(){if(!t.isReady)throw"error, list replica not connected";t.disconnect(),t=null},this.del=function(e){if(!t.isReady)throw"error, list replica not connected";t.del(e),o.autoCommit&&t.commit()},this.add=function(e,n){if(!t.isReady)throw"error, list replica not connected";t.add(e,n),o.autoCommit&&t.commit()},this.append=function(e){if(!t.isReady)throw"error, list replica not connected";t.append(e),o.autoCommit&&t.commit()},this.get=function(e){if(!t.isReady)throw"error, list replica not connected";return t.get(e)},this.set=function(e,n){if(!t.isReady)throw"error, list replica not connected";t.set(e,n),o.autoCommit&&t.commit()},this.clear=function(){if(!t.isReady)throw"error, list replica not connected";t.clear(),o.autoCommit&&t.commit()},this.post=function(e){if(!t.isReady)throw"error, list replica not connected";t.post(e)},this.commit=function(){if(!t.isReady)throw"error, list replica not connected";t.commit()},this.apply=function(e){if(!t.isReady)throw"error, list replica not connected";t.apply(e),o.autoCommit&&t.commit()},this.size=function(){if(!t.isReady)throw"error, list replica not connected";return t.size()},this.toString=function(){if(!t.isReady)throw"error, list replica not connected";return t.storage.toString()},this.isHash=function(){if(!t.isReady)throw"error, list replica not connected";return t.isHash()},this.toJSON=function(){if(!t.isReady)throw"error, list replica not connected";return t.toJSON()}},DSM.Node=function(e){var t=this,n=null,r=null;new Array;this.name=e,this.nodeParent=null,this.nodeChildren=new Array,this.replicas=new Array,this.path="",this.path=this.name,this.__defineSetter__("memCtrl",function(e){n=e}),this.__defineSetter__("localSyncTree",function(e){r=e}),this.isBusy=!1,this.newChildNode=function(e){var t=new DSM.Node(e);return this.attachChild(t),t},this.attachChild=function(e,n){c(t,e,!1,n,!0)},this.detachChild=function(e){if(e instanceof DSM.Node){var t=e;i(t)}else if(e instanceof DSM.HashReplica||e instanceof DSM.ListReplica){var n=e;n.detach(!0)}},this.detach=function(){if(null==t.nodeParent)throw"error, cannot detach root node";i(t)},this.migrateChild=function(e,n){c(t,e,!0,n,!0)},this.dereferenceReplica=function(e){for(var t=0;t<r.objects.length;t++)e===r.objects[t]&&r.objects.splice(t,1);var n=e.nodeParent;if(null==n)throw"error, trying to dereference a detached object";for(var t=0;t<n.replicas.length;t++)e===n.replicas[t]&&n.replicas.splice(t,1)};var i=function(e){var t=function(e){for(var n=0;n<e.replicas.length;n++){var r=e.replicas[n];r.detach(!1)}if(e.replicas=[],0!=e.nodeChildren.length)for(var n=0;n<e.nodeChildren.length;n++){l(e);var i=e.nodeChildren[n];t(i)}};t(e)},o=function(e,t){var n=function(e){e.isBusy=t;for(var r=0;r<e.replicas.length;r++){var i=e.replicas[r];i.isBusy=t}if(0!=e.nodeChildren.length)for(var r=0;r<e.nodeChildren.length;r++){var o=e.nodeChildren[r];n(o,t)}};if(e instanceof DSM.Node){var r=e;n(r)}else{var i=e;i.isBusy=t}},a=function(e){var n=function(e,t){if(e.nodeParent===t)throw"error, trying to create a loop in the local sync tree";null!=e.nodeParent&&n(e.nodeParent,t)};n(t,e)},s=function(e){var t=function(e){if(DSM.assertNotNull(e),e.isBusy)throw"error, node("+e.name+") is busy, don't do anything before ready is called";for(var n=0;n<e.replicas.length;n++){var r=e.replicas[n];if(DSM.assertNotNull(r),r.isBusy)throw"error, replica("+r.name+") is busy, don't do anything before ready is called"}if(0!=e.nodeChildren.length)for(var n=0;n<e.nodeChildren.length;n++){var i=e.nodeChildren[n];t(i)}};if(e instanceof DSM.Node){var n=e;if(n.isBusy)throw"error, YY node("+n.name+") is busy, don't do anything before ready is called";t(n)}else{var r=e;if(r.isBusy)throw"error, replica("+r.name+") is busy, don't do anything before ready is called"}},l=function(e){if(void 0!=e.nodeParent&&null!=e.nodeParent)for(var t=0;t<e.nodeParent.nodeChildren.length;t++)e.nodeParent.nodeChildren[t]==e&&e.nodeParent.nodeChildren.splice(t,1)},p=function(e){for(var t=0;t<r.objects.length;t++){var n=r.objects[t];if(n===e)return!0}return!1},c=function(e,t,i,c,f){if(e===t)throw"error, cannot connect node("+e.name+") to itself";if(t instanceof DSM.Node){var h=t;if(a(h),s(h),o(h,!0),l(h),null==n)throw"error, node is not connected to a local sync tree";h.nodeParent=e,h.memCtrl=n,h.localSyncTree=r,h.path=e.path+DSM.ADDRESS_DELIMTER+h.name,e.nodeChildren.push(h),r.objects.push(h),h.nodeChildren.length>0||h.replicas.length>0?S(h,i,function(){o(h,!1),void 0!=c&&null!=c&&c instanceof Function&&c()}):(o(h,!1),void 0!=c&&null!=c&&c instanceof Function&&c())}else if(t instanceof Array)for(var D=t,M=0,O=function(t){o(t,!1),f&&e.replicas.push(t),M++,M==D.length&&void 0!=c&&null!=c&&c instanceof Function&&c()},m=0;m<D.length;m++){var g=D[m];if(DSM.assertNotNull(g,"error, trying to attach null"),s(g),o(g,!0),!(g instanceof DSM.HashReplica||g instanceof DSM.ListReplica))throw"error, currently not possible to connect multiple nodes";var w=p(g);if(w)i?(e.dereferenceReplica(g),u(e,g,O,!0)):(e.dereferenceReplica(g),u(e,g,O,!1));else{d(g);var v=function(e){var e=e;e.client.ready=function(){O(e)}};v(g)}}else{if(!(t instanceof DSM.HashReplica||t instanceof DSM.ListReplica))throw"error, trying to attach an unsupported object to the local sync tree";var g=t;s(g),o(g,!0);var w=p(g);w?i?(e.dereferenceReplica(g),u(e,g,c,!0)):(e.dereferenceReplica(g),u(e,g,c,!1)):(d(g),g.client.ready=function(){o(g,!1),f&&e.replicas.push(g),void 0!=c&&null!=c&&c instanceof Function&&c()})}},d=function(e){if(r.objects.push(e),e instanceof DSM.HashReplica||e instanceof DSM.ListReplica){var i=null;i=e instanceof DSM.HashReplica?f(t,e.name,!0):f(t,e.name,!1),n.connect(e,i,t)}},u=function(e,t,r,i){if(t instanceof DSM.HashReplica||t instanceof DSM.ListReplica){var o=null;o=t instanceof DSM.HashReplica?f(e,t.name,!0):f(e,t.name,!1);var a=n.connectClient(o,e);a.ready=function(){i&&(a.isHash()?t.forEachKey(function(e){var n=t.get(e);a.set(e,n)}):t.forEachIndex(function(e){var n=t.get(e);a.add(e,n)}),a.commit()),t.detach(!1),t.attach(a,e),void 0!=r&&null!=r&&r instanceof Function&&r()}}},S=function(e,t,n){var r=0,i=0,o=function(){i++,i==r&&void 0!=n&&null!=n&&n instanceof Function&&n()},a=function(e,t){e.path=e.nodeParent.path+DSM.ADDRESS_DELIMTER+e.name;for(var n=0;n<e.replicas.length;n++){r++;var i=e.replicas[n],s=null;s=i instanceof DSM.HashReplica?f(e,i.name,!0):f(e,i.name,!1),t?u(e,i,o,t):u(e,i,o,t)}if(0!=e.nodeChildren.length)for(var n=0;n<e.nodeChildren.length;n++){var l=e.nodeChildren[n];a(l,t)}};a(e,t)},f=function(e,t,n){return n?"hash:"+DSM.nodeId+"."+e.path+DSM.ADDRESS_DELIMTER+t:"list:"+DSM.nodeId+"."+e.path+DSM.ADDRESS_DELIMTER+t}},DSM.LocalSyncTree=function(e,t){this.objects=new Array;var n=e.rootName,r=!1,i=this,o=null,a=null,s=new DSM.Node(n);i.objects.push(s),s.localSyncTree=i,this.__defineGetter__("ROOT",function(){return s}),this.generateUniqueKey=function(){return o.generateUniqueKey()};var l=function(e,t,n,i,o){if(r)throw"error, local sync tree is already connected";if(o||void 0!=i)p(e,i,n,o);else{logInfo("LocalSyncTree","connect","DSM.port is not defined, ask management server ("+e+")  for the port");var a;try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(s){try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(l){try{a=new XMLHttpRequest}catch(c){a=!1}}}a.onreadystatechange=function(){if(4==a.readyState)if(200==a.status){logInfo("LocalSyncTree","connect","sucessfully resolved port information for API key <"+t+">");var r=a.responseText;p(e,r,n,o)}else logFailure("LocalSyncTree","connect","failed to resolve port information for API key <"+t+">")},a.open("GET","http://"+e+"/management/authenticate?api_key="+t,!0),a.send(null)}};this.disconnect=function(){a&&a.close()};var p=function(e,t,n,i){logInfo("LocalSyncTree","establishConnection","DSM.port="+t),logInfo("LocalSyncTree","establishConnection","creating a new DSM.TransportBus object"),a=i?i.protocol.match(/TRAP/i)?new DSM.TrapBusSimple(e,t,i):i.protocol.match(/MSRP/i)?new DSM.MsrpBus(e,t,i):new DSM.TransportBus(e,t,i):new DSM.TransportBus(e,t,i),a.onConfigured=function(){if(logInfo("LocalSyncTree","establishConnection","Transport is now ready"),r=!0,o=new DSM.MemoryController(a),s.memCtrl=o,!(null!=n&&n instanceof Function))throw"error, cannot call ready callback on connect";n()}};l(e.dsmServerIP,e.dsmApiKey,t,e.port,e.transportConfig)};